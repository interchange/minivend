#!/usr/bin/perl
#
#  MAKEDBM - Make the DBM files
#

BEGIN {
$VendRoot = '/usr/local/lib/minivend';
}
$ProductDir = 'products';
$ConfDir = "$VendRoot/etc";
use GDBM_File; $GDBM = 1;

### END CONFIGURABLE VARIABLES

use lib $::VendRoot;
use Getopt::Std;
use Fcntl;
use Vend::lock;
 
my $trackfile = "$VendRoot/$ProductDir/tracking";

$::USAGE = <<EOF ;
$0 - Make MiniVend Database Files

    $0 [-v]

    OPTIONS:

        -v  verbose, echo entries as made


EOF

getopts('v')
	or die "Couldn't read program options: $@\n$::USAGE\n";

$productfile  = "$VendRoot/$ProductDir/products.asc";

$descdbfile	  = "$VendRoot/$ProductDir/pr_desc";
$pricedbfile  = "$VendRoot/$ProductDir/pr_pric";

$verbose = $opt_v || $opt_v || 0;

my $lockfile = "$ConfDir/product.lock";

open(ProductLock, "+>>$lockfile")
        or die "Could not open '$lockfile': $!\n";
lockfile(\*ProductLock, 1, 0)
        or die "Could not lock '$lockfile': $!\n";

#Open the database files
if(defined $GDBM && $GDBM) {
	$descdbfile	 .= '.gdbm';
	$pricedbfile .= '.gdbm';
	tie(%::Product_description, 'GDBM_File', $descdbfile,
			&GDBM_WRCREAT,		0644)
    	or die "Could not tie to $descdbfile: $!\n";

	tie(%::Product_price, 'GDBM_File', $pricedbfile,
			&GDBM_WRCREAT,		0644)
    	or die "Could not tie to $pricedbfile: $!\n";
}
elsif(defined $NDBM && $NDBM) {
	tie(%::Product_description, 'NDBM_File', $descdbfile,
 	 		&O_RDWR|&O_CREAT,	0644)
    	or die "Could not tie to $descdbfile: $!\n";

	tie(%::Product_price, 'NDBM_File', $pricedbfile,
 	 		&O_RDWR|&O_CREAT,	0644)
    	or die "Could not tie to $pricedbfile: $!\n";
}
else {
        die "No DBM implementation configured!\n";
}

open(ASCII, $productfile) or die "Couldn't open $productfile: $!\n";

my ($code, $desc, $price, $junk);

while(<ASCII>) {
	chop;
	($code, $desc, $price,$page) = split(/\t+/, $_, 4);
	if (! defined $price) {
		warn "No price for product '$code'.  Adding default 'CALL'.\n";
		$price = 'CALL';
	}
	elsif ($page =~ /\t/) {
		warn "Too many fields for product $code. Skipping.\n";
		next;
	}
	print "code: $code	desc: $desc	price: $price page: $page\n" if $verbose;
	$::Product_description{$code} = $desc;
	$::Product_price{$code} = $price;
}

untie(%::Product_description);
untie(%::Product_price);

unlockfile(\*ProductLock)
        or die "Could not unlock '$lockfile': $!\n";
close(ProductLock);
