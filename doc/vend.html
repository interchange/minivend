<html><head>
<title>Vend Documentation</title>
<link rev="made" href="mailto:awilcox@world.std.com">
</head>

<body>
<h1>Vend Documentation</h1>

Vend version 0.1 (alpha).  This documentation is preliminary.<p>

Vend allows customers to select items to buy from catalog pages.  The
program tracks which products they have selected and the quantity
desired.  From the ordering page they may complete the ordering
process by entering their name and address, or return to browsing and
select more items.<p>

Vend 0.1 does not support secure transmission of credit card numbers.
Vendors should contact customers separately for payment.<p>

<ul>
  <li><a href="#overview">Overview</a>
  <li><a href="#download">Where to Download Vend</a>
  <li><a href="#perl">Perl version 5</a>
  <li><a href="#cern">Setup for the CERN HTTPD Server</a>
  <li><a href="#directories">Needed Directories</a>
  <li><a href="#unpacking">Unpacking the Vend Distribution</a>
  <li><a href="#cgibin">Testing Your CGI-BIN Directory</a>
  <li><a href="#svend">Setting up SVEND</a>
  <li><a href="#products">The Products File</a>
  <li><a href="#catalog">Catalog Pages</a>
  <li><a href="#order">The Order Page</a>
  <li><a href="#input">Customer Input Fields</a>
  <li><a href="#report">Order Report File</a>
  <li><a href="#config">Vend Configuration File</a>
  <li><a href="#optional">Optional Configuration Directives</a>
  <li><a href="#required">Required Pages</a>
  <li><a href="#expire">Expiring Sessions</a>
</ul>


<h2><a name="overview">Overview</a></h2>

Normally, each request for a World Wide Web page which comes in to a
server stands on its own.  While the server will probably know which
machine a request comes from, it may not know if the next request
comes from the same browser or even from the same user on that
machine.<p>

Vend keeps track of who is ordering what by including in the URL a
<dfn>session id</dfn>: a random string which is different for each
customer browsing the catalog.<p>

So that the session id can be included in URL's within catalog pages,
every page in the catalog is served up by Vend running as a cgi-bin
program.  Here is an example of such a URL:

<pre>
        http://xyzcorp.com/cgi-bin/vend/shirts?WehUkATn;;1
</pre>

An explanation of each part:

<dl>
  <dt><code>xyzcorp.com</code>
    <dd>Internet address of server
  <dt><code>cgi-bin</code>
    <dd>Informs server that the requested page will be generated by a
	 program.
  <dt><code>vend</code>
    <dd>Name of the program to run
  <dt><code>shirts</code>
    <dd>Page of the catalog to display
  <dt><code>WehUkATn;;1</code>
    <dd>The session id
</dl>
       
Catalog pages are written in regular HTML with a few extensions to
support catalog ordering.  Pages are delivered through the following
steps:<p>

<ol>
  <li>The HTTPD server receives a request for a catalog page.
  <li>The server runs <code>svend</code> as a cgi-bin program.
       <code>svend</code> is a small C program which is setuid to the
       account which owns the catalog files.
  <li><code>svend</code> executes the Vend Perl script
       <code>vend.pl</code>.
  <li>Vend reads the HTML source page from the catalog pages
       directory, and interprets the catalog ordering extensions in
       the file.
  <li>The page, which is now entirely in regular HTML, is delivered to
       the HTTPD server, which returns it to the browser.
</ol>

Once the customer has finished, the completed order is emailed to the
vendor.<p>

<h2><a name="download">Where to Download Vend</a></h2>

Vend is available from:<p>

<a href="ftp://gray.maine.com/pub/awilcox/vend-0.1.tar.gz">ftp://gray.maine.com/pub/awilcox/vend-0.1.tar.gz</a><br>
<a href="ftp://ftp.biddeford.com/pub/awilcox/vend-0.1.tar.gz">ftp://ftp.biddeford.com/pub/awilcox/vend-0.1.tar.gz</a>

<h2><a name="perl">Perl version 5</a></h2>

You will need Perl version 5 (or later) to run Vend.  Many sites are
still running Perl version 4.  You can download a copy of Perl 5 from
the following sites (from the Perl FAQ):

<h3>North America</h3>
<a href="ftp://ftp.cis.ufl.edu/pub/perl/src/5.0/perl5.000.tar.gz">ftp://ftp.cis.ufl.edu/pub/perl/src/5.0/perl5.000.tar.gz</a><br>
<a href="ftp://prep.ai.mit.edu/pub/gnu/perl5.000.tar.gz">ftp://prep.ai.mit.edu/pub/gnu/perl5.000.tar.gz</a><br>
<a href="ftp://ftp.uu.net/languages/perl/perl5.000.tar.gz">ftp://ftp.uu.net/languages/perl/perl5.000.tar.gz</a><br>
<a href="ftp://ftp.khoros.unm.edu/pub/perl/perl5.000.tar.gz">ftp://ftp.khoros.unm.edu/pub/perl/perl5.000.tar.gz</a><br>
<a href="ftp://ftp.cbi.tamucc.edu/pub/duff/Perl/perl5.000.tar.gz">ftp://ftp.cbi.tamucc.edu/pub/duff/Perl/perl5.000.tar.gz</a><br>
<a href="ftp://ftp.metronet.com/perlinfo/source/perl5.000.tar.gz">ftp://ftp.metronet.com/perlinfo/source/perl5.000.tar.gz</a><br>
<a href="ftp://genetics.upenn.edu/perl5/perl5_000.zip">ftp://genetics.upenn.edu/perl5/perl5_000.zip</a>

<h3>Europe</h3>
<a href="ftp://ftp.cs.ruu.nl/pub/PERL/perl5.0/perl5.000.tar.gz">ftp://ftp.cs.ruu.nl/pub/PERL/perl5.0/perl5.000.tar.gz</a><br>
<a href="ftp://ftp.funet.fi/pub/languages/perl/ports/perl5/perl5.000.tar.gz">ftp://ftp.funet.fi/pub/languages/perl/ports/perl5/perl5.000.tar.gz</a><br>
<a href="ftp://ftp.zrz.tu-berlin.de/pub/unix/perl/perl5.000.tar.gz">ftp://ftp.zrz.tu-berlin.de/pub/unix/perl/perl5.000.tar.gz</a><br>
<a href="ftp://src.doc.ic.ac.uk/packages/perl5/perl5.000.tar.gz">ftp://src.doc.ic.ac.uk/packages/perl5/perl5.000.tar.gz</a><br>
<a href="http://src.doc.ic.ac.uk/packages/perl5/perl5.000.tar.gz">http://src.doc.ic.ac.uk/packages/perl5/perl5.000.tar.gz</a><br>
<a href="gopher://src.doc.ic.ac.uk/0/packages/perl5/perl5.000.tar.gz">gopher://src.doc.ic.ac.uk/0/packages/perl5/perl5.000.tar.gz</a>

<h3>Australia</h3>
<a href="ftp://sungear.mame.mu.oz.au/pub/perl/src/5.0/perl5.000.tar.gz">ftp://sungear.mame.mu.oz.au/pub/perl/src/5.0/perl5.000.tar.gz</a>

<h2><a name="cern">Setup for the CERN HTTPD Server</a></h2>

Vend uses the user and machine name of the customer as an additional
mechanism for distinguishing between users.  Turn identity checking on
in the HTTPD server with the <code>IdentityCheck</code> directive:

<pre>
        IdentityCheck  On
</pre>

Unless changed by the <code>UserId</code> directive, the CERN
<code>httpd</code> server will run programs as the user
"<code>nobody</code>".  To ensure that <code>svend</code> is only run
as a cgi-bin program and not by other users on the system,
<code>svend</code> will only run under this user account.  If other
programs on the system use the <code>nobody</code> account, you may
want to change the <code>UserId</code> to an account which is only
used by <code>httpd</code>.

<pre>
        UserId  hguest
</pre>

You will also need rules to map URLs to your public HTML files and
your cgi-bin directory.  These may be already set up in the
<code>httpd</code> configuration file.  Here is an example:

<pre>
        Exec  /xyzcorp/cgi-bin/*  /home/xyzcorp/cgi-bin/*
        Pass  /xyzcorp/*          /home/xyzcorp/WWW/*
</pre>

The first line specifies that a URL such as
"<code>http://machine.com/xyzcorp/cgi-bin/svend</code>" will run the
program <code>svend</code> located in the
<code>/home/xyzcorp/cgi-bin</code> directory.

The second line specifies that files in the
<code>/home/xyzcorp/WWW</code> directory can be retrieved with a URL
such as <code>http://machine.com/xyzcorp/file</code>.<p>

The mapping described by <code>Exec</code> will always require two
parts in the URL: one to specify the cgi-bin directory and another to
specify the program to run.  You can shorten the URL by specifying an
additional mapping such as:

<pre>
        Map  /catalog/*  /xyzcorp/cgi-bin/svend/*
</pre>

This will allow a URL such as
"<code>http://machine.com/catalog/shirts</code>" to be used.<p>

In the Vend configuration file, <code>vend.conf</code>, set the
<code>VendURL</code> directive to the URL which runs
<code>svend</code> in the cgi-bin directory.

<pre>
        VendURL  http://machine.com/catalog
</pre>

<h2><a name="directories">Needed Directories</a></h2>

The Vend program, your catalog pages, and the products file should all
go into a private directory.  Because the catalog pages are served
through the Vend cgi-bin program and contain nonstandard elements,
they should not be put into a public WWW directory, nor do they need
to have world-readable file permissions.<p>

You will want a public WWW directory for inline image graphic files.<p>

You will need a cgi-bin directory in which to put the
<code>svend</code> program.<p>

<h2><a name="unpacking">Unpacking the Vend Distribution</a></h2>

Decompress and untar the distribution:

<pre>
        gzip -d vend-0.1.tar.gz
        tar xfv vend-0.1.tar
</pre>

If you have GNU tar, you can combine these steps:

<pre>
        tar xfvz vend-0.1.tar.gz
</pre>

The <code>samples</code> directory contains a sample product file and
order report, and sample catalog pages.  If you would like to use them
as a starting point for your own catalog, you can copy the sample
files into the Vend directory:

<pre>
        cd /usr/vend                   # wherever your vend directory is
        cp sample/pages/* pages
        cp sample/products/* products
        cp sample/report .
</pre>

Edit <code>vend.pl</code> and set <code>VendRoot</code> to the
vend directory which you just unpacked.

<h2><a name="cgibin">Testing Your CGI-BIN Directory</a></h2>

This is a good time to test your cgi-bin configuration and find out
the numeric user-id which your HTTPD server runs cgi-bin programs
under.  Edit "<code>testcgi</code>" and change the first line to refer
to your Perl version 5 (or higher) executable.

<pre>
        #!/usr/bin/perl
</pre>

Copy "<code>testcgi</code>" into your cgi-bin directory, and make it
executable.

<pre>
        cp testcgi /your/cgi-bin/directory
        chmod a+rx /your/cgi-bin/directory/testcgi
</pre>

Try running <code>testcgi</code> from your shell command line to make
sure that everything is working.

<pre>
        /your/cgi-bin/directory/testcgi
</pre>

<code>testcgi</code> should respond with the version of Perl that you
are running and your numeric user id.<p>

Now try running <code>testcgi</code> from your browser.  Write down
the numeric user id which you get there, as you will need it later for
<code>svend</code>.

<h2><a name="svend">Setting up SVEND</a></h2>

<code>svend</code> is a small C program which is setuid to the user
account which can access the catalog data files.  The following defines at
the beginning of <code>svend.c</code> should be set:

<dl>
  <dt>CGIUSER
  <dd>Set this to the numeric uid (user id) which HTTPD runs cgi-bin
       programs under.  Typically this will be 'nobody' or 'guest'.
  <dt>PERL
  <dd>Set this to the location of the perl (version 5 or higher)
       executable.
  <dt>VEND
  <dd>Set to the location of <code>vend.pl</code>, typically in the
       <code>vend</code> directory.
</dl>

Compile <code>svend.c</code> with your C compiler:

<pre>
        cc svend.c -o svend
</pre>

On some systems you can make the executable smaller with the
<code>strip</code> program.  But don't worry about it if
<code>strip</code> is not on your system.

<pre>
        strip svend
</pre>

If you want Vend to run under a different user account than your own,
make that user the owner of <code>svend</code>.  (You probably need to
be root to do this).  Do not make <code>svend</code> owned by root,
because making <code>svend</code> setuid root is an unnecessary
security risk.

<pre>
        chown vendacct svend
</pre>

Make <code>svend</code> setuid:

<pre>
        chmod u+s svend
</pre>

Move the <code>svend</code> executable to your cgi-bin directory:

<pre>
        mv svend /the/cgi-bin/directory
</pre>

<h3>Setting up vend.pl</h3>

Edit <code>vend.pl</code> and specify the root directory which
contains the Vend distribution.

<pre>
        $Config::VendRoot = '/usr/vend';
</pre>

<h2><a name="products">The Products File</a></h2>

Each product you are selling should be given a <dfn>product
code</dfn>: a short code that identifies the product on the ordering
page and in the catalog.  You can use any combination of letters and
digits for the product code.

The "<code>products</code>" file is a simple Ascii comma-delimited
list of all the product codes, a short description, and the price.

Here is an example of a products file:

<pre>
        SH543,Men's fine cotton shirt,14.95
        PA776,Elegant pants,29.00
</pre>

<h2><a name="catalog">Catalog Pages</a></h2>

Pages in the catalog are written in regular HTML with extensions to
support catalog ordering.  To distinguish them from regular HTML,
these extended elements use square brakets instead of angular
brackets.<p>

The first page displayed in the catalog is
"<code>catalog.html</code>".  This page will contain links to other
catalog pages with the <code>[page]</code> element.  Individual
products can be ordered by the <code>[order]</code> element, which
brings up the order page "<code>order.html</code>".  The order page
contains input boxes for the customer to type in their name and
address.  Once the order has been sent the
"<code>confirmation.html</code>" page is displayed.<p>

You will normally not want to include regular hypertext links to pages
outside of the catalog.  Such links will not include the session id,
which means that if the customer follows an external link back to the
catalog the list of products ordered so far will have been lost.<p>

Inline images, on the other hand, are served in the normal fashion.
You should include a regular <code>&lt;img src="URL"&gt;</code>
element, where the URL refers to a graphic image.<p>

The following elements can be used in catalog pages:

<dl>
  <dt>[page <var>pg</var>]
  <dd>Insert a hyperlink to the specified catalog page <var>pg</var>.
       For example, <code>[page shirts]</code> will expand into
       <code>&lt;a
       href="http://xyzcorp.com/cgi-bin/vend/shirts?WehUkATn;;1&gt;</code>.
       The catalog page displayed will come from
       "<code>shirts.html</code>" in the pages directory.
  <dt>[/page]
  <dd>Expands into <code>&lt;/a&gt;</code>.  Used with the page
       element, such as: <code>[page shirts]Our shirt
       collection[/page]</code>.
  <dt>[finish-order]
  <dd>This element is used to give the customer, while browsing, a way
       to return to the order page after they have already ordered
       something.  If they haven't ordered anything yet [finish-order]
       does not appear at all on the displayed page.  If they have
       ordered an item, the element will expand into something like:
       <code>&lt;a
       href="http://xyzcorp.com/cgi-bin/vend/finish;WehUkATn;;1"&gt;
       Finish Incomplete Order&lt;/a&gt;</code>
  <dt>[order <var>code</var>]
  <dd>Expands into a hypertext link which will include the specified
       <var>code</var> in the list of products to order and display
       the order page.  <var>code</var> should be a product code
       listed in the "<code>products</code>" file.
  <dt>[/order]
  <dd>Expands into <code>&lt;/a&gt;</code>.  Used with the order element, such
       as: <code>Buy a [order TK112]Toaster[/order] today.</code>
  <dt>[price <var>code</var>]
  <dd>Expands into the price of the product identified by
       <var>code</var> as found in the products file.
  <dt>[description <var>code</var>]
  <dd>Expends into the description of <var>code</var> as found in the
       products file.
</dl>       

<h2><a name="order">The Order Page</a></h2>

The following elements are used on the order page:

<dl>
  <dt>[value <var>field</var>]
  <dd>Expands into the current value of the customer input field named
       by <var>field</var>.  See the section on input fields for more
       information.
  <dt>[nitems]
  <dd>Expands into the total number of items ordered so far.
  <dt>[total-cost]
  <dd>Expands into the total cost of all the items ordered so far.
</dl>

Within the order page, the <code>[item-list]</code> element shows a
list of all the items ordered by the customer so far.  It works by
repeating the source between <code>[item-list]</code> and
<code>[/item-list]</code> once for each item ordered.  Between the
item-list markers the following elements will return information for
the current item:

<dl>
  <dt>[item-code]
  <dd>Evaluates to the product code for the current item.
  <dt>[item-description]
  <dd>Evaluates to the product description (from the products file)
       for the current item.
  <dt>[item-quantity]
  <dd>Evaluates to the quantity ordered for the current item.
  <dt>[item-price]
  <dd>Evaluates to the price (from the products file) of the current
       item.
  <dt>[quantity-name]
  <dd>Evaluates to the name to give an input box in which the customer
       can enter the quantity to order.
</dl>

<h2><a name="input">Customer Input Fields</a></h2>

On the orders page, <code>order.html</code>, you will have a number of
input fields allowing customer to enter information such as their name
and address.  You can add more fields simply by putting more input
elements on the <code>order.html</code> page, and the information will
automatically be included in the order report.  Input elements should
be written in this way:

<pre>
        &lt;input type="text" name="town" value="[value town]" size=30&gt;
</pre>

The <code>type</code> attribute should be set to <code>"text"</code>,
which is the only input type supported by this version of Vend.<p>

Choose a name for this input field such as "email" for an email
address.  Set the <code>name</code> attribute to the name you have
choosen.<p>

The <code>value</code> attribute specifies the default value
to give the field when the page is displayed.  Because the customer
may enter information on the order page, return to browsing, and come
back to the order page, you want the default value to be what was
entered the first time.  This is done with the <code>[value]</code>
element, which returns the last value of an input field.  Thus,

<pre>
        value="[value name]"
</pre>

will evaluate to the name entered on the previous order screen, such
as:

<pre>
       value="Jane Smith"
</pre>

which will be displayed by the browser.<p>

The <code>size</code> attributes specifies how many characters wide
the input field should be on the browser.  You do not need to set this
to fit the lengthiest possible value since the browser will scroll the
field, but you should set it large enough to be comfortable for the
customer.

<h2><a name="report">Order Report File</a></h2>

The order report file, "<code>report</code>", defines the layout of
the order report which gets mailed on the completion of the order.
For example,

<pre>
        Order Date: $date

                    Name: $name
           Email address: $email

        Shipping address: $addr
        Town, State, Zip: $town, $state $zip
                 Country: $country
</pre>

Any input field from the order page can be included using the dollar
sign notation.

<h2><a name="config">Vend Configuration File</a></h2>

The VendRoot directory, specified in <code>vend.pl</code>, is the
default location of all of the Vend files.  Unless changed in
<code>vend.pl</code>, the Vend configuration file will be
<code>vend.conf</code> in the VendRoot directory.<p>

In the configuration file, these directives are required:

<h3>Vend URL</h3>

Specifies the base URL that will run <code>svend</code> as a cgi-bin
program.

<pre>
        VendURL  http://machine.com/xyzcorp/cgi-bin/svend
</pre>

<h3>Mail Order To</h3>

Specifies the email address to mail completed orders to.

<pre>
        MailOrderTo  orders@xyzcorp.com
</pre>

<h2><a name="optional">Optional Configuration Directives</a></h2>

These directives all have default values and are optional.

<h3>Page Directory</h3>

Location of catalog pages.  Defaults to the <code>pages</code>
subdirectory in the <code>VendRoot</code> directory.

<pre>
        PageDir  /data/catalog/pages
</pre>

<h3>Products Directory</h3>

Location of the <code>products</code> file.  Defaults to the
<code>products</code> subdirectory of the <code>VendRoot</code>
directory.

<pre>
        ProductDir  /data/catalog/for-sale
</pre>

<h3>Order Report File</h3>

When the completed order is ready to be mailed to the vendor, the
order report file describes the layout of the order report.  Defaults
to <code>report</code>.

<pre>
        OrderReport  /data/order-form
</pre>

<h3>Display Errors</h3>

While all errors are reported in the error log file, you can also have
errors displayed by the browser.  This is convenient while you are
testing your configuration.

<pre>
        DisplayErrors  Yes
</pre>

<h3>Session Database</h3>

When storing sessions in a DBM database, specify the base name of the
DBM file to use.  The file extensions of <code>.pag</code>,
<code>.dir</code>, or <code>.gdbm</code> (depending on the DBM
implementation used) will be appended.

<pre>
        SessionDatabase  session-data
</pre>

<h3>File Permissions</h3>

By default, only the user account that Vend runs under (as set by the
setuid permission on <code>svend</code>) can read and write files
created by Vend.  <code>WritePermission</code> and
<code>ReadPermission</code> can be set to '<code>user</code>',
'<code>group</code>', or '<code>world</code>'.

<pre>
        WritePermission  group
        ReadPermission   group
</pre>

<h3>Session Expire</h3>

A customer can exit their browser or leave the catalog pages at any
time, and no indication is given to the HTTPD server aside from the
lack of further requests that have the same session id.  Old session
information needs to be periodically expired.  The
<code>SessionExpire</code> specifies the minimum time to keep track of
session information.  Defaults to one day.

<pre>
        SessionExpire  4 hours
</pre>

<h3>SendMail Program</h3>

Specifies the program used to send email.  Defaults to
'/usr/lib/sendmail'.

<pre>
        SendMailProgram  /bin/mailer
</pre>

<h3>Shipping Charges</h3>

Specifies a shipping charge to add onto the total price for items
ordered.  If you do not want to include a fixed shipping charge on the
order page, leave this 0 and do not include the
<code>[shipping]</code> element in the order page.  Defaults to 0.

<pre>
        Shipping  5.00
</pre>

<h2><a name="required">Required Pages</a></h2>

The following pages need to be present in the <code>pages</code>
directory.  See the <code>sample</code> subdirectory for examples.

<dl>
  <dt>catalog.html
  <dd>The main catalog page presented by Vend when another page is not
       specified.
  <dt>order.html
  <dd>This page is displayed when the customer orders an item.
  <dt>confirmation.html
  <dd>After the order is completed, the confirmation page is
       displayed.
  <dt>failed.html
  <dd>If the sendmail program could not be envoked to email the
       completed order, the <code>failed.html</code> page is
       displayed.  (Sadly we don't know if the email was successfully
       delivered).
  <dt>missing.html
  <dd>This page is displayed if the URL from the browser specifies a
       page that does not have a matching <code>.html</code> file in
       the <code>pages</code> directory.  This can happen if the
       customer saved a bookmark to a page that was later removed.
  <dt>noproduct.html
  <dd>This page is displayed if the URL from the browser specifies the
       ordering of a product code which is not in the
       <code>products</code> file.
  <dt>interact.html
  <dd>Displayed if an unexpected response was received from the
       browser, such as not getting expected fields from submitting a
       form.  This would probably happen from typos in the html pages,
       but could be a browser bug.
</dl>

<h2><a name="expire">Expiring Sessions</a></h2>

You should periodically expire old sessions to keep the session
database file from growing too large.  Use the <code>-expire</code>
option to <code>vend.pl</code> to do this:

<pre>
        /usr/vend/vend.pl -expire
</pre>

You could add a crontab entry such as the following:

<pre>
        # once a day at 6:10 am
        10 6 * * * /usr/vend/vend.pl -expire
</pre>

<hr>
<address>
Febuary 1, 1995.
<a href="http://www.maine.com/awilcox/">Andrew Wilcox</a>,
<a href="mailto:awilcox@world.std.com">awilcox@world.std.com</a></address>
</body></html>
