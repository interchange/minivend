#!/usr/bin/perl

## This is here because Perl 5.005 installations may try to re-install
## a whole perl if you run this! If you want to try it, then

use Getopt::Std;

getopts('fd:h');

eval {
	require 5.6.0;
};

use vars qw/$opt_f $opt_d $opt_h/;
my $prog = $0;
$prog =~ s:.*/::;

$::USAGE = <<EOF;
usage: $prog [-f] [-d interchange_root] [module1 module2 module_n]

[module] defaults to Bundle::Interchange.

OPTIONS:

    -f    Force install for Perl 5.005
    -d    Set interchange root directory (default current)

EOF

if($opt_h) {
	warn $USAGE;
	exit 2;
}

if($@) {

	require 5.005;
	if(! $opt_f) {
		my $args = join " ", @ARGV;
		print <<EOF;
Perl 5.005 installations may try to re-install a whole perl if you run this! If
you want to try it, then rerun with a -f flag, i.e.

	$0 -f $args

EOF
	}
}

use Cwd;
use File::Spec;

use strict;

# See if we have the CPAN module
my $Cpan = 0;
my $CpanInit;
eval { 	
		die "Don't try this at home with Windows.\n" if $^O =~ /win32/i;
		require CPAN::Config;
		require CPAN;
		import CPAN;
};

if($@) {
	die "Can't do cpan_local_install: $@\n";
}

die "CPAN not initialized.\n"
	unless defined $CPAN::Config;

sub my_prompt {
    my($pr) = shift || '? ';
    my($def) = shift;
    my($ans);

    print $pr;
    print "[$def] " if $def;
    chomp($ans = <STDIN>);
    $ans ? $ans : $def;
}

my $libdir = $opt_d || $opt_d || '';

my @mods_to_get = @ARGV;

if(! @mods_to_get) {
	push @mods_to_get, 'Bundle::Interchange';
}

if(! $libdir) {
	my @possible = grep -f $_, qw/minivend.cfg interchange.cfg interchange.cfg.dist/;
	if(@possible) {
		$libdir = cwd() if -d 'lib';
	}
}

$libdir =~ s:(^|/)lib$::;

if(! File::Spec->file_name_is_absolute($libdir) ) {
	$libdir = File::Spec->catfile(cwd(), $libdir);
}

unshift @INC, $libdir, "$libdir/lib";

print <<EOF;

Since you have the CPAN module installed and initialized,
we can go and get optional modules that help Interchange work a
bit better and faster. At least we can if you are connected
to the Internet and have one of the following on your machine:

		Perl LWP libraries
		Perl Net::FTP library
		ncftp (a nice FTP program)
		lynx  (the text-based web browser)

In case you were wondering, CPAN is a worldwide network of
over 100 FTP sites which maintain the latest Perl software.
If you don't know a URL to use, you can try:

	ftp://ftp.freesoftware.com/pub/perl/CPAN
	ftp://ftp.funet.fi/pub/languages/perl/CPAN

If you have never used CPAN before, you may want to reply NO.
Interchange should work anyway -- it just won't be quite as easy
to build the demo catalogs.

If you have errors during the process, don't worry. Either
just continue on or stop the program and try again, replying
No when prompted for CPAN.

EOF

for my $module (@mods_to_get) {
	my $prompt = "Get $module? [yes] ";
	my $ask = my_prompt($prompt);
	exit 2 if $ask =~ /^\s*n/i;
	
	$CPAN::Config->{makepl_arg} = "INSTALLPRIVLIB=$libdir/lib INSTALLARCHLIB=$libdir/lib INSTALLSITELIB=$libdir/lib INSTALLMAN1DIR=none INSTALLMAN3DIR=none INSTALLSITEARCH=$libdir/lib INSTALLDIRS=perl";
	$CPAN::Config->{keep_source_where} = "$libdir/src"
		unless -w $CPAN::Config->{keep_source_where};
	$CPAN::Config->{cpan_home} = "$libdir/src"
		unless -w $CPAN::Config->{cpan_home};
	$CPAN::Config->{build_dir} = "$libdir/src"
		unless -w $CPAN::Config->{build_dir};
	CPAN::install($module);
}
