[comment]
ui_template: Yes
ui_template_name: leftonly
[/comment]

[tmp members_only]1[/tmp]
[tmp page_title]__COMPANY__ -- Order Detail[/tmp]

[control reset=1]

[control-set]
[component]search_box_small[/component]
[/control-set]

[control-set]
[component]category_vertical[/component]
[/control-set]

[control-set]
[component]cart_tiny[/component]
[/control-set]

[control reset=1]

@_LEFTONLY_TOP_@

<!-- BEGIN CONTENT -->

[if session arg]
	[seti arg][data session arg][/seti]
[else]
	[bounce href="[area special/violation arg_missing]"]
[/else]
[/if]

[value name=test_user
	set="[data
		table=transactions
		col=username
		key='[scratch arg]'
	]"
hide=1]

[if value test_user]
[else]
	[bounce href="[area special/violation user_missing]&user=[value test_user]&arg=[scratch arg]"]
[/else]
[/if]
[if type=explicit compare=`
	return 1 if ! $Session->{username};
	return 0 if $Session->{username} eq $Values->{test_user};
	return 1;
`]
[bounce href="[area special/user_violation username_no_match]&s=[data session username]&v=[value test_user]"]
[/if]

[loop list="[scratch arg]"]
<TABLE BORDER=0>
[html-table fr='class="contentbar1"']
	<B>ORDER NUMBER	[scratch arg]
	<B>Name	[loop-data transactions fname] [loop-data transactions lname]
	[if-loop-data transactions company]Company	[loop-data transactions company]
	[/if-loop-data]<B>Address	[loop-data transactions address1][if-loop-data transactions address2]
	[loop-data transactions address2][/if-loop-data]
	<B>City, State, Zip	[loop-data transactions city], [loop-data transactions state]  [loop-data transactions zip]
	<B>Country	[loop-data transactions country]
	<B>Payment Method	[loop-data transactions payment_method]
	<B>Shipping Method	[loop-data transactions shipmode]
	<B>Daytime Phone	[loop-data transactions phone_day]
	<B>Evening Phone	[loop-data transactions phone_night]
	[if-loop-data transactions b_fname]<B>Billing Name	[loop-data transactions b_fname] [loop-data transactions b_lname]
	[/if-loop-data][if-loop-data transactions b_address1]<B>Billing Address	[loop-data transactions b_address1]
	[loop-data transactions b_address2]
	<B>City, State, Zip	[loop-data transactions b_city], [loop-data transactions b_state]  [loop-data transactions b_zip]
	[/if-loop-data][if-loop-data transactions b_country]<B>Shipping Country	[loop-data transactions b_country][/if-loop-data]
[/html-table]
</TABLE>

<p>

<TABLE BORDER=0 CLASS="contentbar1">

[perl products userdb]
	sub get_download {
		my $sku = shift;
		return '' unless tag_data('products', 'download', $sku);
		my $loc =  tag_data('products', 'dl_location', $sku);
		my $save = delete $Scratch->{mv_add_dot_html};
		my $url = $Tag->area( { href => "deliver/$loc", arg => $sku } ); 
		$Scratch->{mv_add_dot_html} = $save if $save;
		return qq{<BR><A HREF="$url"><IMG border=0 SRC="download.png"></A>};
	}
	return;
[/perl]

[html-table interpolate=1 td="VALIGN=TOP"]
<B>Quan	<B>Item No.	<B>Description	<B><DIV ALIGN=RIGHT>Price	<B><DIV ALIGN=RIGHT>Extension
[query
	list=1
	st=db
	sql=|
		SELECT * FROM orderline
		WHERE order_number = '[scratch arg]'
		ORDER BY code
	|
][sql-param quantity]	[sql-param sku]	[description [sql-param sku]]<BR>[if-sql-data orderline size__MVC_FIELDMUNGE__]SIZE-->[sql-param size__MVC_FIELDMUNGE__][/if-sql-data][if-sql-data orderline color] COLOR-->[sql-param color][/if-sql-data][calc]
return unless
	q{[userdb function=check_file_acl mode=expire location="[sql-param sku]"]};
	return get_download(q{[sql-param sku]});
[/calc]	<DIV ALIGN=RIGHT>[currency][sql-param price][/currency]	<DIV ALIGN=RIGHT>[currency][sql-param subtotal][/currency]
[/query]
			SUBTOTAL	<DIV ALIGN=RIGHT>[currency][loop-data transactions subtotal][/currency]
			SALES TAX	<DIV ALIGN=RIGHT>[currency][loop-data transactions salestax][/currency]
			SHIPPING	<DIV ALIGN=RIGHT>[currency][loop-data transactions shipping][/currency][if-loop-data transactions handling]
			HANDLING	<DIV ALIGN=RIGHT>[currency][loop-data transactions handling][/currency][/if-loop-data]
			ORDER TOTAL	<DIV ALIGN=RIGHT>[currency][loop-data transactions total_cost][/currency]
[/html-table]
</TABLE>
[/loop]

<BR CLEAR=ALL>

<!-- END CONTENT -->

@_LEFTONLY_BOTTOM_@
