[if !session logged_in]
[bounce page=config/violation]
[/if]

<HTML>
<HEAD>
<TITLE>Orders by SKU</TITLE>
</HEAD>
<BODY BGCOLOR=white>
<H1>Orders by SKU</H1>
[perl]
	my ($yr, $mon, $day) = split /\s+/, $Tag->time({ body => '%Y %m %d'});
	for(qw/ limit_begin_yr limit_end_yr / ) {
		$Values->{$_} = $CGI->{$_} || $yr;
		$Scratch->{$_} = '';
	}
	for(qw/ limit_begin_mon limit_end_mon / ) {
		$Values->{$_} = $CGI->{$_} || $mon;
		$Scratch->{$_} = '';
	}
	for(qw/ limit_begin_day limit_end_day / ) {
		$Values->{$_} = $CGI->{$_} || $day;
		$Scratch->{$_} = '';
	}
	my $end_day = $Values->{limit_end_day};
	$end_day++;
	$Scratch->{search_string} = <<EOF;
sf=order_date
se=$Values->{limit_begin_yr}$Values->{limit_begin_mon}$Values->{limit_begin_day}
op=ge
sf=order_date
se=$Values->{limit_end_yr}$Values->{limit_end_mon}$end_day
op=lt
co=yes
EOF

	for (2000 .. $yr) {
		$Scratch->{limit_begin_yr} .= "<OPTION";
		$Scratch->{limit_begin_yr} .= " SELECTED"
			if $_ eq $Values->{limit_begin_yr};
		$Scratch->{limit_begin_yr} .= ">$_";
		$Scratch->{limit_end_yr} .= "<OPTION";
		$Scratch->{limit_end_yr} .= " SELECTED"
			if $_ eq $Values->{limit_end_yr};
		$Scratch->{limit_end_yr} .= ">$_";
	}
	for (
			[  '01' => 'January'],
			[  '02' => 'February'],
			[  '03' => 'March'],
			[  '04' => 'April'],
			[  '05' => 'May'],
			[  '06' => 'June'],
			[  '07' => 'July'],
			[  '08' => 'August'],
			[  '09' => 'September'],
			[  '10' => 'October'],
			[  '11' => 'November'],
			[  '12' => 'December'],
		)
	{
		$Scratch->{limit_begin_mon} .= "<OPTION VALUE=$_->[0]";
		$Scratch->{limit_begin_mon} .= " SELECTED"
			if $_->[0] eq $Values->{limit_begin_mon};
		$Scratch->{limit_begin_mon} .= ">$_->[1]";
		$Scratch->{limit_end_mon} .= "<OPTION VALUE=$_->[0]";
		$Scratch->{limit_end_mon} .= " SELECTED"
			if $_->[0] eq $Values->{limit_end_mon};
		$Scratch->{limit_end_mon} .= ">$_->[1]";
	}
	for ('01' .. '31') {
		$Scratch->{limit_begin_day} .= "<OPTION";
		$Scratch->{limit_begin_day} .= " SELECTED"
			if $_ eq $Values->{limit_begin_day};
		$Scratch->{limit_begin_day} .= ">$_";
		$Scratch->{limit_end_day} .= "<OPTION";
		$Scratch->{limit_end_day} .= " SELECTED"
			if $_ eq $Values->{limit_end_day};
		$Scratch->{limit_end_day} .= ">$_";
	}
[/perl]
<FORM ACTION="[process]" METHOD=GET>
<INPUT TYPE=hidden NAME=mv_nextpage VALUE="@@MV_PAGE@@">
<INPUT TYPE=hidden NAME=mv_todo     VALUE=return>
<TABLE>
<TR>
	<TD>
		<FONT SIZE="-1"><INPUT TYPE=SUBMIT VALUE="Go"> Begin
			<SELECT NAME=limit_begin_mon>[scratch limit_begin_mon]</SELECT>
			<SELECT NAME=limit_begin_day>[scratch limit_begin_day]</SELECT>
			<SELECT NAME=limit_begin_yr>[scratch limit_begin_yr]</SELECT>
		</FONT>
	</TD>
	<TD>
		<FONT SIZE="-1">End
			<SELECT NAME=limit_end_mon>[scratch limit_end_mon]</SELECT>
			<SELECT NAME=limit_end_day>[scratch limit_end_day]</SELECT>
			<SELECT NAME=limit_end_yr>[scratch limit_end_yr]</SELECT>
		</FONT>
	</TD>
</TR>
</TABLE>
</FORM>

<TABLE>
[set first_done][/set]
[search-region more=1 search="
		[scratch search_string]
		fi=orderline
		st=db
		ml=100000
		tf=sku
		to=x
		tf=order_number
		to=x
		rf=code,order_number,sku,quantity,username,subtotal
		"]
[set first_done_sku][/set]
[search-list]

[item-change 0][condition][item-param sku][/condition]
<TR>
	<TD ALIGN=LEFT>[if scratch first_done_sku]<HR>[value prev_data_sku]<HR>[/if]</TD>
	<TD ALIGN=LEFT></TD>
	<TD ALIGN=MIDDLE></TD>
	<TD ALIGN=RIGHT>[if scratch first_done_sku]<HR>[summary name=subtotal.orderline.quantity.sku total=1][summary name=subtotal.orderline.quantity.sku reset=1]<HR>[/if]</TD>
	<TD ALIGN=RIGHT>[if scratch first_done_sku]<HR>[filter op=|'currency'| interpolate=1][summary name=subtotal.orderline.subtotal.sku total=1][summary name=subtotal.orderline.subtotal.sku reset=1][/filter]<HR>[/if]</TD>
	<TD ALIGN=LEFT></TD>
</TR>
<TR>
	<TH ALIGN=LEFT>sku</TH>
	<TH ALIGN=LEFT>title</TH>
	<TH ALIGN=MIDDLE>order_number</TH>
	<TH ALIGN=RIGHT>quantity</TH>
	<TH ALIGN=RIGHT>subtotal</TH>
	<TH ALIGN=LEFT>email</TH>
</TR>

[/item-change 0]


[set first_done_sku]1[/set]
<TR>
	<TD ALIGN=LEFT>[page href="config/edit_record"
								form="
									mv_action=return
									mv_data_table=products
									mv_arg=[item-param sku]
									"][item-param sku]</A></TD>
	<TD ALIGN=LEFT>[filter op=|'16'| interpolate=1][data table=products column=title key='[item-param sku]'][/filter]</TD>
	<TD ALIGN=MIDDLE>[page href="config/edit_record"
								form="
									mv_action=return
									mv_data_table=transactions
									mv_arg=[item-param order_number]
									"][item-param order_number]</A></TD>
	<TD ALIGN=RIGHT>[item-param quantity][summary name=total.orderline.quantity hide=1 amount="[item-param quantity]"][summary name=subtotal.orderline.quantity.sku hide=1 amount="[item-param quantity]"]</TD>
	<TD ALIGN=RIGHT>[filter op=|'currency'| interpolate=1][item-param subtotal][/filter][summary name=total.orderline.subtotal hide=1 amount="[item-param subtotal]"][summary name=subtotal.orderline.subtotal.sku hide=1 amount="[item-param subtotal]"]</TD>
	<TD ALIGN=LEFT>[filter op=|'mailto'| interpolate=1][data table=userdb column=email key='[item-param username]'][/filter]</TD>
</TR>
[value name=prev_data_sku hide=1 set=|[item-param sku]|]
[/search-list]
<TR>
	<TD ALIGN=LEFT>[if scratch first_done_sku]<HR>[value prev_data_sku]<HR>[/if]</TD>
	<TD ALIGN=LEFT></TD>
	<TD ALIGN=MIDDLE></TD>
	<TD ALIGN=RIGHT>[if scratch first_done_sku]<HR>[summary name=subtotal.orderline.quantity.sku total=1][summary name=subtotal.orderline.quantity.sku reset=1]<HR>[/if]</TD>
	<TD ALIGN=RIGHT>[if scratch first_done_sku]<HR>[filter op=|'currency'| interpolate=1][summary name=subtotal.orderline.subtotal.sku total=1][summary name=subtotal.orderline.subtotal.sku reset=1][/filter]<HR>[/if]</TD>
	<TD ALIGN=LEFT></TD>
</TR><TR>
	<TD ALIGN=LEFT><B>TOTAL</B></TD>
	<TD ALIGN=LEFT></TD>
	<TD ALIGN=MIDDLE></TD>
	<TD ALIGN=RIGHT><B>[summary name=total.orderline.quantity total=1]
</B></TD>
	<TD ALIGN=RIGHT><B>[filter op=|'currency'| interpolate=1][summary name=total.orderline.subtotal total=1]
[/filter]</B></TD>
	<TD ALIGN=LEFT></TD>
</TR>

[/search-region]
</TABLE>
