[set page_title]__COMPANY__ -- Order detail[/set]
[include pages/config/header]
[include pages/config/mid_header]

[comment]
Do some security checking
[query arrayref=tmp
	   sql="
			select store_id, parent
			from transactions
			where order_number = '[data session arg]'
		"][/query]
<!-- edit OK: [perl]
	return $Scratch->{ok} = 1 if $Session->{username} eq $Config->{remote_user};
	return $Scratch->{ok} = 0 if ! $ref = $Tmp->{tmp}[0];
	for(@$ref) {
			return $Scratch->{ok} = 1 if $Session->{username} eq $_;
	}
	return $Scratch->{ok} = '';
[/perl]
[if !scratch ok]
		[set error_message]Not your order![/set]
		[bounce href="[area config/error]"]
[/if]
[/comment]

<TD BGCOLOR=white>
[loop list="[data session arg]"]
[seti email][data table=userdb column=email key="[loop-data transactions username]"][/seti]
<TABLE WIDTH=600 BORDER=1>
[html-table fr='__TABLEFG__']
<B>SYNDICATE/CAMPAIGN/ID	[loop-data transactions syndicate]/[loop-data transactions campaign]/[loop-data transactions status]
<B>ORDER NUMBER	[loop-data transactions order_number]
<B>Name	[loop-data transactions fname] [loop-data transactions lname]&nbsp;
[if-loop-data transactions company]Company	[loop-data transactions company]
[/if-loop-data]<B>Address	[loop-data transactions address1][if-loop-data transactions address2]
	[loop-data transactions address2][/if-loop-data]
<B>City, State, Zip	[loop-data transactions city], [loop-data transactions state]  [loop-data transactions zip]
<B>Country	[loop-data transactions country]
<B>Payment Method	[loop-data transactions payment_method]&nbsp;[loop-data transactions order_id]
<B>Daytime Phone	[loop-data transactions phone_day]&nbsp;
<B>Email	<A HREF="mailto:[scratch email]">[scratch email]</A>&nbsp;
[if-loop-data transactions b_fname]<B>Billing Name	[loop-data transactions b_fname] [loop-data transactions b_lname]
[/if-loop-data][if-loop-data transactions b_address1]<B>Billing Address	[loop-data transactions b_address1]
	[loop-data transactions b_address2]
<B>City, State, Zip	[loop-data transactions b_city], [loop-data transactions b_state]  [loop-data transactions b_zip]
[/if-loop-data][if-loop-data transactions b_country]<B>Shipping Country	[loop-data transactions b_country][/if-loop-data]
[/html-table]
</TABLE>
<TABLE WIDTH=600 BORDER=1 __TABLEBG__>

[perl products userdb]
	sub get_download {
		my $sku = shift;
		return '' unless tag_data('products', 'download', $sku);
		my $loc =  tag_data('products', 'dl_location', $sku);
		my $save = delete $Scratch->{mv_add_dot_html};
		my $url = $Tag->area( { href => "deliver/$loc", arg => $sku } ); 
		$Scratch->{mv_add_dot_html} = $save if $save;
		return qq{<BR><A HREF="$url"><IMG SRC="download.png"></A>};
	}
	return;
[/perl]
[html-table interpolate=1 td="VALIGN=TOP"]
<B>Quan	<B>Item No.	<B>Description	<B><DIV ALIGN=RIGHT>Price	<B><DIV ALIGN=RIGHT>Extension
[query
	list=1
	st=db
	sql=|
		SELECT * FROM orderline
		WHERE order_number = '[data session arg]'
		ORDER BY code
	|
][sql-param quantity]	[sql-param sku]	[description [sql-param sku]]<BR>[if-sql-data orderline size]SIZE-->[sql-param size][/if-sql-data][if-sql-data orderline color] COLOR-->[sql-param color][/if-sql-data][calc]
return unless
	q{[userdb function=check_file_acl mode=expire location="[sql-param sku]"]};
	return get_download(q{[sql-param sku]});
[/calc]	<DIV ALIGN=RIGHT>[currency][sql-param price][/currency]	<DIV ALIGN=RIGHT>[currency][sql-param subtotal][/currency]
[/query]
			SUBTOTAL	<DIV ALIGN=RIGHT>[currency][loop-data transactions subtotal][/currency]
			SALES TAX	<DIV ALIGN=RIGHT>[currency][loop-data transactions salestax][/currency]
			SHIPPING	<DIV ALIGN=RIGHT>[currency][loop-data transactions shipping][/currency][if-loop-data transactions handling]
			HANDLING	<DIV ALIGN=RIGHT>[currency][loop-data transactions handling][/currency][/if-loop-data]
			ORDER TOTAL	<DIV ALIGN=RIGHT>[currency][loop-data transactions total_cost][/currency]
[/html-table]
</TABLE>
[/loop]
</TD>
<BR CLEAR=ALL>
__MENUBOTTOM__
__COPYRIGHT__
<!-- current page: @@MV_PAGE@@ -->

[include pages/config/mid_footer]
[include pages/config/footer]
