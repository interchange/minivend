GlobalSub <<EndOfSub
sub userdb {
	my($function, %options) = @_;
print("userdb function $function\n") if $Global::DEBUG;
	use Vend::UserDB;

	my $status = 1;
	my $user = new Vend::UserDB %options;
	unless (defined $user) {
		$Vend::Session->{failure} = "Unable to access user database.";
		return undef;
	}
	elsif (! $function) {
		$Vend::Session->{failure} = "No function called for userdb.";
		return undef;
	}

print("Called userdb user=$user function=$function\n" .
				do {
					my $out;
					for(keys %options) {
						$out .= "option $_=$options{$_}\n";
					}
					for(keys %{$user}) {
						$out .= "user $_=$user->{$_}\n";
					}
	} ) if $Global::DEBUG;

	if($function eq 'login') {
		$Vend::Session->{logged_in} = 0;
		$status = $user->login(%options) and $Vend::Session->{logged_in} = 1;
	}
	elsif($function eq 'new_account') {
		$Vend::Session->{logged_in} = 0;
		$status = $user->new_account(%options) and $Vend::Session->{logged_in} = 1;
	}
	elsif($function eq 'logout') {
		$Vend::Session->{logged_in} = 0;
		$Vend::Session->{'values'}{mv_password} = '';
		$user->{MESSAGE} = 'Logged out.';
	}
	elsif (! $Vend::Session->{logged_in}) {
		$Vend::Session->{failure} = "Not logged in.";
		return undef;
	}
	elsif($function eq 'save') {
		$status = $user->set_values();
	}
	else {
		$status = $user->$function(%options);
	}
	
	if($status) {
		delete $Vend::Session->{failure};
print("userdb success=$user->{ERROR}\n") if $Global::DEBUG;
		$Vend::Session->{success} = $user->{MESSAGE} || '';
	}
	else {
print("userdb failure=$user->{ERROR}\n") if $Global::DEBUG;
		$Vend::Session->{failure} = $user->{ERROR};
	}
	return $status;
}
EndOfSub

