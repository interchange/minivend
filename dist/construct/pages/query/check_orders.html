<html>
<head>
<title>Construct Something -- Order History</title>

__TOP__

          <tr> 
            <td> 
              <table width="600" border="0" cellspacing="0" cellpadding="0">
                <tr> 
                  <td><img src="navigation/d.gif" width="600" height="2" align="top"></td>
                </tr>
              </table>
            </td>
          </tr>
          <tr> 
            <td> 
              <table width="600" border="0" cellspacing="0" cellpadding="0">
                <tr> 
                  <td width="131" bgcolor="#999999"><img src="navigation/d1.gif" width="131" height="20"></td>
                  <td width="12" valign="top"> 
                    <div align="left"><img src="navigation/d2.gif" width="10" height="20"></div>
                  </td>
                  <td width="457"> 
                    <div align="left"><i><b><font face="Verdana, Arial, Helvetica, sans-serif"><font color="#0099FF" size="2">Order History
					</font><font color="#0099FF" size="1"> </font></font></b></i></div>
                  </td>
                </tr>
                <tr> 
                  <td bgcolor="#999999" valign="top" width="131"> 
				  
__LEFT__
				  
                  </td>
                  <td width="12">&nbsp;</td>
                  <td valign="top" width="457"> 

[query st=db arrayref=orders
		sql="SELECT
			code,status,nitems,subtotal,shipping,handling,total_cost,payment_method,order_date
			FROM transactions
			WHERE username = '[data base=session field=username filter=sql]'
			ORDER by code
		"][/query]
[mvasp tables=transactions]
<%
	my $uid = $Session->{username};

	if (! $uid) {
		$Document->write ("<H3><font face=\"Verdana, Arial, Helvetica, sans-serif\">You are not logged in.</font></H3>");
		return;
	}

	my $orders = $Tmp->{orders};
	
	if(! $orders or scalar @$orders == 0) {
		$Document->write( "No pending orders for $uid.");
		return;
	}

	HTML "<TABLE CELLSPACING=0 CELLMARGIN=0 BORDER=1 WIDTH=450>";

	my $header_template = <<'EOF';
<TR bgcolor="#0099FF">
	<TD VALIGN=bottom>
		<FONT COLOR="#FFFFFF" face="Verdana, Arial, Helvetica, sans-serif" size="1">DATE</FONT>
	</TD>
	<TD VALIGN=bottom>
		<FONT COLOR="#FFFFFF" face="Verdana, Arial, Helvetica, sans-serif" size="1">ORDER ID</FONT>
	</TD>
	<TD VALIGN=bottom>
		<FONT COLOR="#FFFFFF" face="Verdana, Arial, Helvetica, sans-serif" size="1">QTY<BR>TOTAL</FONT>
	</TD>
	<TD VALIGN=bottom>
		<FONT COLOR="#FFFFFF" face="Verdana, Arial, Helvetica, sans-serif" size="1">PAYMENT<BR>METHOD</FONT>
	</TD>
	<TD VALIGN=bottom>
		<FONT COLOR="#FFFFFF" face="Verdana, Arial, Helvetica, sans-serif" size="1">SUBTOTAL</FONT>
	</TD>
	<TD VALIGN=bottom>
		<FONT COLOR="#FFFFFF" face="Verdana, Arial, Helvetica, sans-serif" size="1">SHIPPING<BR>HANDLING</FONT>
	</TD>
	<TD VALIGN=bottom>
		<FONT COLOR="#FFFFFF" face="Verdana, Arial, Helvetica, sans-serif" size="1">TOTAL</FONT>
	</TD>
	<TD VALIGN=bottom>
		<FONT COLOR="#FFFFFF" face="Verdana, Arial, Helvetica, sans-serif" size="1">STATUS</FONT>
	</TD>
</TR>
EOF

		my $line_template = <<'EOF';
<TR bgcolor="#FEEDD2">
	<TD VALIGN=TOP>
		<FONT face="Verdana, Arial, Helvetica, sans-serif" size="1">$order_date</FONT>
	</TD>
	<TD VALIGN=TOP>
		<FONT face="Verdana, Arial, Helvetica, sans-serif" size="1"><A HREF="$detail_url">$order_number</A></FONT>
	</TD>
	<TD ALIGN=RIGHT VALIGN=TOP>
		<FONT face="Verdana, Arial, Helvetica, sans-serif" size="1">$nitems</FONT>
	</TD>
	<TD VALIGN=TOP>
		<FONT face="Verdana, Arial, Helvetica, sans-serif" size="1">$payment_method</FONT>&nbsp;
	</TD>
	<TD ALIGN=RIGHT VALIGN=TOP>
		<FONT face="Verdana, Arial, Helvetica, sans-serif" size="1">$subtotal</FONT>
	</TD>
	<TD ALIGN=RIGHT VALIGN=TOP>
		<FONT face="Verdana, Arial, Helvetica, sans-serif" size="1">$shipping$handling</FONT>
	</TD>
	<TD ALIGN=RIGHT VALIGN=TOP>
		<FONT face="Verdana, Arial, Helvetica, sans-serif" size="1">$total_cost</FONT>
	</TD>
	<TD VALIGN=TOP>
		<FONT face="Verdana, Arial, Helvetica, sans-serif" size="1">$status</FONT>
	</TD>
</TR>
EOF

	my %hash;

	my @fields = qw/order_number status nitems subtotal shipping
					handling total_cost payment_method order_date/;
			
	my $row;

	my %summary;
	my $first;
	my $record;
	HTML $header_template;
	foreach $record (@$orders) {
		my $line = $line_template;
		@hash{@fields} = @$record;
		$hash{detail_url} = $Tag->area( {
									href => 'query/order_detail',
									arg => $hash{order_number},
								});
		if($hash{status} =~ /\d/) {
			my @ids = grep /\S/, split /\s+/, $hash{status};
			$hash{status} = '';
			for(@ids) {
				$hash{status} .= <<EOF;
<A HREF="http://wwwapps.ups.com/etracking/tracking.cgi?InquiryNumber1=$_&TypeOfInquiryNumber=T">UPS $_</A>
EOF
			}
		}
		else {
				$hash{status} = <<EOF;
<A HREF="$hash{detail_url}">$hash{status}</A>
EOF
		}
		for(qw/subtotal shipping total_cost/) {
			$hash{$_} = $Tag->currency ({ body=> $hash{$_} });
		}
		if($hash{handling}) {
			$hash{handling} = "<BR>(handling "								.
							  $Tag->currency ({ body=> $hash{handling} })	.
							  ")";
		}
		else {
			$hash{handling} = '';
		}
		$line =~ s/\$(\w+)/$hash{$1}/g;
		HTML $line;
	}

	HTML "</TABLE>";
%>
[/mvasp]

<BR CLEAR=ALL>

[seti export][tag export transactions transactions.txt][/tag][/seti]
[seti export][tag export orderline orderline.txt][/tag][/seti]

                  </td>
                </tr>
                <tr> 
                  <td bgcolor="#999999" width="131"><img src="navigation/poweredby.gif" width="131" height="61"></td>
                  <td width="12">&nbsp;</td>
                  <td valign="top" width="457">&nbsp;</td>
                </tr>
              </table>
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
  <p>&nbsp;</p>
  <p>&nbsp;</p>
</div>
</body>
</html>
