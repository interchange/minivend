# Set the sitewide information. The initial settings
# in the "variable" table are shown below; subsequent
# changes are only in the database, not below.

VariableDatabase variable

### These reflect the initial settings set
### above; if you uncomment them they will override
### it.
#
#Variable    SERVER_NAME     __MVC_SERVERNAME__
#Variable    CGI_URL         __MVC_CGIURL__
#Variable    SECURE_SERVER   http://__MVC_SERVERNAME__
#Variable    ORDERS_TO       __MVC_MAILORDERTO__
#Variable    IMAGE_DIR       __MVC_IMAGEURL__
#Variable    DOCROOT         __MVC_DOCUMENTROOT__
#Variable    SAMPLEHTML      __MVC_SAMPLEHTML__
#Variable    SAMPLEURL       __MVC_SAMPLEURL__
#
#Variable    COMPANY         __MVC_COMPANY__
#Variable    ADDRESS         __MVC_ADDRESS__
#Variable    CITY            __MVC_CITY__
#Variable    PHONE           __MVC_PHONE__
#Variable    TOLLFREE        __MVC_TOLLFREE__
#Variable    FAX             __MVC_FAX__
#Variable    LOGO            __MVC_LOGO__
#Variable    SMLOGO          __MVC_SMLOGO__
#Variable    ENCRYPTOR       __MVC_ENCRYPTOR__
#Variable    TAXAREA         __MVC_TAXAREA__
#Variable    TAXRATE         __MVC_TAXRATE__
#Variable    TAXSHIPPING     __MVC_TAXSHIPPING__
#
#Variable    SOMESQL         __MVC_MYSQL____MVC_PGSQL__
#Variable    MYSQL           __MVC_MYSQL__
#Variable    PGSQL           __MVC_PGSQL__
#Variable    SQLDSN          __MVC_SQLDSN__
#Variable    SQLDB           __MVC_SQLDB__
#Variable    SQLUSER         __MVC_SQLUSER__
#Variable    SQLPASS         __MVC_SQLPASS__

## END SITE CONFIGURATION

ParseVariables  Yes

## The URLs which run the catalog. They are built from the Variable
## settings above.
VendURL                 http://__SERVER_NAME____CGI_URL__
SecureURL               __SECURE_SERVER____CGI_URL__

## Set the image path for relative images
ImageDir                __IMAGE_DIR__/
ImageDirInternal        http://__SERVER_NAME____IMAGE_DIR__/


### Some user session related settings...
###
###
#
#

## Whether to encrypt passwords in UserDB
UserDB    default    crypt         0

## Change a field to something that doesn't conflict in MySQL
UserDB    default    time_field    mod_time

## Don't want people setting their credit limit directly
UserDB    default    scratch       credit_limit

## Set some initial values
ScratchDefault   mv_add_dot_html   1
ScratchDefault   mv_no_session_id  1
ScratchDefault   mv_no_count       1
ScratchDefault   order_style       1
ValuesDefault    mv_shipmode       upsg
ValuesDefault    show_basket       1
#
#
###
###
###

## Set some menubars and headers
## Use [include ...] with low traffic settings (from minivend.cfg)
## Put in memory with high traffic settings (from minivend.cfg)


# Better performance this way
#ifdef @TRAFFIC =~ /high/i
ParseVariables  Yes
ConfigDir config
Variable      TOP              <top.html
Variable      LEFT             <left.html
Variable      RIGHT            <right.html
Variable      SPECIALS         <specials.html
Variable      RECEIPT_SPECIALS <receipt_specials.html
Variable      RECEIPT_TOP      <receipt_top.html
ConfigDir config
#endif

# template changes show up immediately this way
#ifdef @TRAFFIC =~ /low/i
Variable      TOP              [include pages/top.html]
Variable      LEFT             [include pages/left.html]
Variable      RIGHT            [include pages/right.html]
Variable      SPECIALS         [include pages/specials.html]
Variable      RECEIPT_SPECIALS [include pages/receipt_specials.html]
Variable      RECEIPT_TOP      [include pages/receipt_top.html]
#endif

ParseVariables  Yes

# Sets Interchange to not parse <BODY MV="body 1"> and other tags within
# HTML tags, use [pragma no_html_parse 0] to enable on a page
Pragma          no_html_parse

MailOrderTo             __ORDERS_TO__


#####
#####
##### DATABASE SETUP
#####
#####

#####
##### Default DBM
#####
#ifndef SOMESQL

# The table defs are in separate files in the dbconf/dbm directory.

Message Using default DBM databases.
#include dbconf/default_db/*

#endif

#ifndef SQLDSN
Variable    SQLDSN          __MVC_SQLDSN__
#endif

#####
##### MySQL
#####
#ifdef MYSQL

Message Using MySQL, DSN=__SQLDSN__.

# Uncomment if needed
#Variable  SQLUSER  foo
#Variable  SQLPASS  bar

# The table defs are in separate files in the dbconf/mysql directory,
# the ones kept in DBM are in TABLENAME.dbm files.

#include dbconf/mysql/*

#endif

#ifdef PGSQL

Message Using PostgreSQL, DSN=__SQLDSN__.

# Uncomment and edit if needed
#Variable  SQLUSER  foo
#Variable  SQLPASS  bar

# The table defs are in separate files in the dbconf/pgsql directory,
# the ones kept in DBM are in TABLENAME.dbm files.

#include dbconf/pgsql/*

#endif

AlwaysSecure         ord/checkout multi/checkout
AsciiTrack           logs/tracking.asc

ProductFiles   products

PriceField     price

CommonAdjust   pricing:price_group,q5,q10: ;:wholesale ;$
UserDB         default    scratch    dealer

Autoload <<EOR
[perl]
	if($Scratch->{dealer}) {
			$Config->{PriceField} = 'no_price';
	}
[/perl]
EOR

# Here is one that sets up "Mix and match" based upon the price_group field
# in the "pricing" database.
#CommonAdjust   pricing:price_group,q2,q5,q10,q25,q100, ;:price, ;$ ==color:pricing, ==size:pricing
CookieLogin  Yes

# This sets up the new payment charge mode in Interchange 4
# You set it to "custom name", where name is the name of a GlobalSub
# that performs the charge operation. If it is not "custom", then
# it will use the CyberCash routines.
#
# "minivend_test" is special, and the demo order profile
# works with the demo order form to test
#
#Variable  MV_PAYMENT_MODE   minivend_test

# Uncomment to use creditCardAuto if you want, now handled better in
# order profiles with "&credit_card=standard".
#CreditCardAuto      Yes

# These are usually all you need for CyberCash 3
# Uncomment and edit to suit; make sure you remove CreditCardAuto somehow
#
#Variable         CYBER_CONFIGFILE    /home/you/yourid75/mck-cgi/merchant_conf
#Variable         CYBER_VERSION       3.2
#Variable         CYBER_MODE          mauthonly

#ifdef CYBER_MODE
Variable         MV_PAYMENT_MODE     mauthonly
CreditCardAuto   No
#endif

EncryptProgram   __ENCRYPTOR__

# Uncomment only if you have these locales on your system
#Locale          de_DE
#Locale          de_DE LC_CTYPE de_DE
#Locale          fr_FR
#Locale          en_US

Locale          en_US LC_CTYPE C
LocaleDatabase  locale

Onfly           onfly
OrderCounter    etc/order.number
OrderLineLimit  25
OrderProfile    etc/profiles.order etc/profiles.login etc/profiles.misc

# This makes CommonAdjust effective, since no_price doesn't exist
ReadPermission  group
RobotLimit       50

# Here we override Interchange's normal order routine
ActionMap  order   <<EOR
sub {
	#Log('in order action');
	if($CGI->{mv_nextpage} ne 'order') {
		# Do nothing
	}
	elsif($Values->{no_basket}) {
		$CGI->{mv_nextpage} = 'ord/nobasket';
	}
	else {
		$CGI->{mv_nextpage} = 'ord/basket';
	}
	$CGI->{mv_order_item} = $CGI->{mv_arg}
		if ! $CGI->{mv_order_item};
	$Tag->update('values');
	return 1;
}
EOR

ActionMap  deliver   <<EOR
sub {
	my $deliverable = shift;
	$Scratch->{deliverable} = $CGI->{mv_arg};
	$CGI->{mv_nextpage} = 'deliver';
	return 1;
}
EOR

ActionMap  get_password   <<EOR
sub {
	$Config->{NoSearch} = '';
	$CGI->{mv_nextpage} = $CGI->{mv_search_page} = 'action/get_password';
	$CGI->{mv_todo} = 'search';
	$Tag->update('process');
	return;
}
EOR

ParseVariables Yes
Route log       attach          0
Route log       cybermode       ""
Route log       empty           1
Route log       encrypt         0
Route log       increment       0
Route log       report          etc/log_transaction
Route log       supplant        0
Route log       track           logs/log

Route log_entry       attach          0
Route log_entry       cybermode       ""
Route log_entry       empty           1
Route log_entry       encrypt         0
Route log_entry       increment       0
Route log_entry       report          etc/log_entry
Route log_entry       supplant        0
Route log_entry       track           logs/log

Route copy_user attach          0
Route copy_user cybermode       ""
Route copy_user empty           1
Route copy_user encrypt         0
Route copy_user increment       0
#Route copy_user report          etc/mail_receipt
Route copy_user supplant        0
Route copy_user track           logs/log

# Main route must be last to make default
Route main      attach           0
#Route main      counter         etc/some.other.order.number
Route main      credit_card      0
Route main      cybermode        ""
Route main      default          1
Route main      email            '__ORDERS_TO__'
Route main      encrypt          0
Route main      encrypt_program  '__ENCRYPTOR__'
Route main      errors_to        '__ORDERS_TO__'
Route main      increment        0
Route main      pgp_cc_key       ""
Route main      pgp_key          ""
Route main      receipt          etc/receipt.html
Route main      report           etc/report
Route main      supplant         1
Route main      individual_track orders
Route main      track            logs/tracking.asc

# Order routes can be maintained in a database, empty in demo
# CHANGES TO THIS WILL OVERRIDE THE ROUTES ABOVE
RouteDatabase    route

SalesTax         state
SeparateItems Yes

SpecialPage          catalog        index
SpecialPage          report         ../etc/report
SpecialPage          receipt        ../etc/receipt

NoCache  reconfig special config query ord multi
Static        __CATALOG_STATIC__
StaticLogged  __LOGGED_STATIC__
StaticAll     Yes
StaticDBM     static
StaticDepth   2
StaticDir     __SAMPLEHTML__/pages
StaticFly     Yes
StaticPath    __SAMPLEURL__/pages
TaxShipping   __TAXSHIPPING__

#ifdef UI_TRAFFIC_STATS
TrackFile __UI_TRAFFIC_STATS__
#endif

UpsZoneFile   products/450.csv
UseModifier   size color
AutoModifier  pricing:price_group

AutoModifier  products:gift_cert

History 10
UserTag history-scan Order find exclude default
UserTag history-scan addAttr
UserTag history-scan Routine <<EOR
my %var_exclude = ( qw/
	mv_credit_card_number 1
	mv_pc                 1
	mv_session_id         1
/);
sub {
	my ($find, $exclude, $default) = @_;
	my $ref = $Vend::Session->{History}
		or return $Tag->area($default || $Config->{SpecialPage}{catalog});
	my ($hist, $href, $cgi);
	$exclude = qr/$exclude/ if $exclude;
	for(my $i = $#$ref; $i >= 0; $i--) {
		#Log("checking $ref->[$i][0] for $exclude");
		if ($exclude and $ref->[$i][0] =~ $exclude) {
			next;
		}
		if($find) {
			next unless $ref->[$i][0] =~ /$find/;
		}
		($href, $cgi) = @{$ref->[$i]};
		last;
	}
	return $Tag->area($default || $Config->{SpecialPage}{catalog})
		if ! $href;
	my $form = '';
	for(grep !$var_exclude{$_}, keys %$cgi) {
		$form .= "\n$_=";
		$form .= join("\n$_=", split /\0/, $cgi->{$_});
	}
	return $Tag->area( { href => $href, form => $form} );
}
EOR

WritePermission group

# Here you can set up fatal errors if a necessary sub or usertag
# doesn't exist, uncomment one of next lines to test
#Require globalsub   nevairbe
#Require usertag   nevairbe

Require usertag   email
Require usertag   email_raw
Require usertag   var
Require usertag   loc
Require usertag   summary
Require usertag   button

# This UserTag sets a default font face, size, color
# or more in a table without having to type it in every
# time.
# 
# Usage:
# [table-font face="arial, helvetica" size="-1"]
# <TABLE><TR><TD>Test.</TD></TR></TABLE>
#    Will do multiple tables.
# <TABLE><TR><TD>Test.</TD></TR></TABLE>
# [/table-font]
#
UserTag table-font Order face
UserTag table-font PosNumber 1
UserTag table-font addAttr 1
UserTag table-font hasEndTag
UserTag table-font Routine <<EOR
sub {
    my ($face, $opt, $table) = @_;

    my @parms;
    push(@parms, qq{FACE="$face"})
        if $face;
    for(qw/size color/) {
        push(@parms, qq{\U$_\E="} . $opt->{$_} . '"')
            if $opt->{$_};
    }
    push(@parms, $opt->{extra})
        if $opt->{extra};
    my $front = "<FONT " . join(" ", @parms) . '>';
    $table =~ s:(<T[HD][^>]*>):$1$front:ig;
    $table =~ s:(</T[HD]\s*>):</FONT>$1:ig;
    return $table;
}
EOR

