
[if cgi mv_data_table]
[value name=mvc_data_table set="[cgi mv_data_table]" hide=1]
[value name=mv_data_table set="[cgi mv_data_table]" hide=1]
[else]
[value name=mv_data_table set="[calc]$Config->{ProductFiles}[0][/calc]" hide=1]
[value name=mvc_data_table set="[values mv_data_table]" hide=1]
[/else]
[/if]

[if-mm !tables]
[bounce href="[area @@MM_BASE@@/table_violation]"]
[/if-mm]

[calc]
	if(! $CGI->{item_id}) {
		$CGI->{item_id} = 'new';
	}
	$Scratch->{arg} = $CGI->{item_id};
	return;
[/calc]

[if-mm function=keys name="[scratch arg]"]
[else][bounce href="[area @@MM_BASE@@/key_violation]"][/else]
[/if-mm]

[perl tables="[value mv_data_table]"]
my $table = $Values->{mv_data_table};
$Values->{mvc_data_key_name} = $Db{$table}->config('KEY');
if ($table ne $Values->{mv_data_table}) {
	$Values->{mv_data_table} = $table;
}
$Values->{mvc_data_fields} =
	$CGI->{mvc_data_fields} ||
	$CGI->{mv_data_fields} ||
	$Values->{"$table:mvc_data_fields"} || '' ;
$Values->{mvc_data_fields} =~ s/\0+/ /g;
if($table eq delete $Values->{mvc_auto_export}) {
	return "[seti export_ok][tag export $table][/tag][/seti]";
}
else {
	return '[set export_ok][/set]';
}
[/perl]

[seti page_title]Item editor: edit item [cgi item_id][/seti]
[set help_name]item.edit[/set]

@@MM_TALLY_HEADER@@

<img src="admin/icon_item.gif" width=16 height="16" border="0" valign="top" align="top">

&nbsp;
<font size="+1" face="Verdana,arial,helvetica,sans-serif" color="#000000">
Edit item
<p>
&nbsp;
</font>
</td>
</tr>

<tr>
<td colspan="2">

<!-- ----- BEGIN REAL STUFF ----- -->

[if scratch mm_failure]
	[LC]
	<FONT COLOR=RED>Failed:
	[/LC]
	[scratch mm_failure][set mm_failure][/set]</FONT><BR>
[/if]
[set process_filter]
[perl]
	my @filters = grep /^mm_filter:/, keys %$CGI;
	return unless @filters;
	foreach my $key (@filters) {
		my $val = delete $CGI->{$key};
		$key =~ s/mm_filter://;
		next unless $val;
		next unless defined $CGI->{$key};
		$CGI->{$key} = $Tag->filter($val, $CGI->{$key}, $key);
	}
	return;
[/perl]
[/set]

<FORM METHOD=POST ACTION="[area minimate]">
<INPUT TYPE=hidden NAME=mv_doit VALUE="set">
<INPUT TYPE=hidden NAME=mv_click VALUE="process_filter">
<INPUT TYPE=hidden NAME=mv_nextpage VALUE="__MM_BASE__/item">
<INPUT TYPE=hidden NAME=mv_data_table VALUE="[value mv_data_table]">
<INPUT TYPE=hidden NAME=mv_data_key VALUE="[value mvc_data_key_name]">
<INPUT TYPE=hidden NAME=mv_data_decode VALUE="[value mv_data_decode]">
<INPUT TYPE=hidden NAME=mm_return_to   VALUE="@@MV_PAGE@@">
<INPUT TYPE=hidden NAME=mm_return_to   VALUE="item_id=[scratch arg]">
<INPUT TYPE=hidden NAME=mv_update_empty VALUE="1">
<INPUT TYPE=hidden NAME=mv_data_fields
	VALUE="[db-columns columns='[value mvc_data_fields]' ]">

[if-key-exists table="[value mv_data_table]" key="[scratch arg]"]
<INPUT TYPE=hidden NAME="mv_data_function" VALUE="update">
[else]
<INPUT TYPE=hidden NAME="mv_data_function" VALUE="insert">
[/else]
[/if-key-exists]

<table cellpadding=3 cellspacing=0>

[seti extra_tables]
[query list=1 sql="SELECT DISTINCT db FROM __MINIMATE_META__" table="__MINIMATE_META__"]
	[sql-code]
[/query]
[/seti]

[mvasp tables="[scratch extra_tables] [value mv_data_table] __MINIMATE_META__ __MINIMATE_TABLE__"]
<%
	my $table	= $Values->{mv_data_table};
	my $db		= $Db{$table};
	my %break;
	if($CGI->{mm_break_before}) {
		my @tmp = grep /\S/, split /[\s,\0]+/, $CGI->{mm_break_before};
		@break{@tmp} = @tmp;
	}
	if(!$db) {
		return "<TR><TD>Broken table '$table'</TD></TR>";
	}
	my $key		= $Scratch->{arg};
	my $keycol  = $db->config('KEY');
	my (@cols)  = split /\s+/, $Tag->db_columns( {
										name	=> $table,
										columns	=> $Values->{mvc_data_fields},
										passed_order => 1,
									});
	my $super = $Tag->if_mm('super');
	#my $super = $Scratch->{is_super};
	if($db->record_exists($key)) {
		#Log("Should work. key=$key table=$table");
	}
	else {
		$CGI->{$Values->{mvc_data_key_name}} = $key;
		undef $key;
		Log("key is undeffed.");
	}
	foreach my $col (@cols) {
		if($CGI->{mm_hide_key} and $col eq $keycol) {
			$Document->write(<<EOF);
<INPUT TYPE=hidden NAME="$col" VALUE="$Scratch->{arg}">
EOF
			next;
		}
		my $currval;
		if($CGI->{$col} and !tag_data($table, $col, $key) ) {
			$currval = $CGI->{$col};
		}
		my $label = $Tag->field_label($table, $col);
		my $meta = '';
		if($super) {
			$meta .= '<FONT SIZE=1><BR>';
			$meta .= $Tag->page(
							{	href => '__MM_BASE__/format_meta',
								form => qq{
										mv_arg=${table}::$col
										mm_return_to=@@MV_PAGE@@
										mm_return_to=item_id=$Scratch->{arg}
										}
							});
			$meta .= '[L]meta[/L]</A></FONT>';
		}
		my $display = $Tag->display({
										table => $table,
										column => $col,
										key => $key,
										default => $default,
									});
		$Document->write(<<EOF) if $break{$col};
<tr>
<td colspan=2 bgcolor=#7079aa><img src="admin/cleardot.gif" width=600 height=1></td>
</tr>
EOF
		$Document->write(<<EOF);
<tr>
<td bgcolor=#94a0e0 align=right>
$label$meta
</td>
<td bgcolor=#94a0e0>
$display
</td>
</tr>
EOF
	}
%>
[/mvasp]

</table>

<p>

<input type=submit name="do_update_cmd"
  value="Ok">

<input type=submit name="cancel_cmd" value="Cancel">

</form>


<!-- ----- END REAL STUFF ----- -->

@@MM_TALLY_FOOTER@@
<!-- page: @@MM_PAGE@@ -->
