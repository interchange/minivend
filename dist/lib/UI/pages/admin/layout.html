[set page_title]Layout Editor[/set]
[set page_banner]Layout Editor: Organize your site into categories[/set]
[set page_perm]layout=e[/set]
[set help_name]layout.edit[/set]
[set icon_name]admin/icon_pages.gif[/set]
[seti ui_body_extra]
	[if cgi from_section]
		onLoad="window.open('[area __UI_BASE__/layout_area_properties]', 'ui_prop', 
			'resizable=1,scrollbars=1,width=750')"
	[elsif cgi from_category]
		onLoad="window.open('[area __UI_BASE__/layout_cat_properties]', 'ui_prop', 
			'resizable=1,scrollbars=1,width=750')"
	[/elsif]
	[/if][/seti]

@@UI_STD_HEAD@@
[if scratch ui_message]
<BLOCKQUOTE>
<FONT COLOR="__CONTRAST__" SIZE=+1><B>[scratch ui_message][set ui_message][/set]</B></FONT>
</BLOCKQUOTE>
[/if]
<!-- ----- BEGIN REAL STUFF ----- -->
<FORM	METHOD=GET
		ACTION="[process]"
		name="layoutform"
		onSubmit="document.layoutform.ui_window_name.value=window.name;" >
<input type=hidden name=ui_window_name value="mainwindow[scratch window_name]">
<input type=hidden name=mv_todo        value=return>
<input type=hidden name=mv_nextpage    value="@@MV_PAGE@@">

<table __UI_T_PROPERTIES__>

[if cgi newarea]
<!-- Creating area: 
[value name=area set="[fcounter etc/area.recordnumber]" hide=1]
[data table=area column=name key="[value area]" value="[cgi newarea]"] -->
[data table=area column=selector key="[value area]" value="[value area]"] -->
[elsif cgi newcat]
<!-- Creating category: 
[value name=cat set="[fcounter etc/cat.recordnumber]" hide=1]
[data table=cat column=name key="[value cat]" value="[cgi newcat]"]
[data table=cat column=area key="[value cat]" value="[data table=area col=selector key='[value area]']"] -->
[/elsif]
[elsif cgi setarea]
<!-- Setting area: [value name=area set="[value code]" hide=1] -->
[/elsif]
[elsif cgi setcat]
<!-- Setting cat: [value name=cat set="[value code]" hide=1] -->
[/elsif]
[/if]

[set Delete section]
[tag flag write]area[/tag]
mv_nextpage=__UI_BASE__/layout
[if-mm advanced sitedesign=d]
	[perl tables="area"]
		my ($item) = $CGI->{area};
		my $out;
	    unless ($Db{area}) {
			Log("no site design table 'area'");
			return undef;
		}
		my $name = $Db{area}->field($item, 'name');
		if ($Db{area}->delete_record($item)) {
			$out .= "Deleted $name from area table<BR>";
		}
		else {
			$out .= "Item $item not in $_ table (or delete failed)<BR>";
		}
		$Scratch->{ui_message} = $out;
		return;
	[/perl]
[else]
	[set ui_message]Not authorized to delete items.[/set]
[/else]
[/if-mm]
[/set]

<tr>
<td [if value area]colspan=3[/if] bgcolor=__UI_C_TOPBLOCKBAR__><img src="admin/cleardot.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>

<tr>
<td valign=top bgcolor="__UI_C_INTBLOCK__">

<B>Area -- section:</B><br>

<select name="area" size=10 onchange="this.form.target='_self';document.layoutform.submit()">
[loop   search="
			fi=area
			tf=bar
			tf=sort
			tf=name
			st=db
			ra=yes
			rf=code,name,bar
		"
		option=area ]
<option value="[loop-code]">[loop-param bar] -- [loop-param name]
[/loop]
</select>
<br>

[set Section Properties]
mv_todo=return
mv_nextpage=__UI_BASE__/layout_area_properties
[/set]

<input onclick="window.open('', 'ui_prop', 
			'resizable=1,scrollbars=1,width=750'); this.form.target='ui_prop'" 
type=submit name=mv_click value="Section Properties">

<br>

[set Create section]
mv_todo=back
mv_nextpage=__UI_BASE__/layout_create
ui_varname=newarea
ui_title=New section name
[/set]

<input onclick="window.open('', 'create_window', 
			'resizable=1,width=240,height=120'); this.form.target='create_window'" 
	type=submit name=mv_click value="Create section">

<br>

<input type=submit name=mv_click value="Delete section"
	 onClick="this.form.target='_self'; return confirm('Are you sure you want to delete this section?')">


</td>


[if value area]
[then]
<td valign=top bgcolor="__UI_C_INTBLOCK__">

<B>Contains:</B><BR>

<select name="cat" size=10>
[loop   search="
			fi=cat
			st=db
			ml=1000

			tf=sort
			tf=name

			co=yes

			sf=area
			op=rm
			se=[data table=area col=selector key='[value area]']

			rf=code,name,sort
			" option=cat]
<OPTION VALUE="[loop-code]">[loop-param name] ([loop-param sort])
[/loop]
</select>
<br>

[set Category Properties]
mv_todo=return
mv_nextpage=__UI_BASE__/layout_cat_properties
[/set]

<input onclick="window.open('', 'ui_prop', 
			'resizable=1,scrollbars=1,width=750'); this.form.target='ui_prop'" 
 type=submit name=mv_click value="Category Properties">
<br>
[set Create category]
mv_todo=back
mv_nextpage=__UI_BASE__/layout_create
ui_varname=newcat
ui_title=New category name
[/set]

<input onclick="window.open('', 'create_window', 
			'resizable=1,width=240,height=120'); this.form.target='create_window'" 
	type=submit name=mv_click value="Create category">

[set Delete category]
[tag flag write]cat[/tag]
mv_nextpage=__UI_BASE__/layout
[if-mm advanced sitedesign=d]
	[perl tables="cat"]
		my ($item) = $CGI->{cat};
		my $out;
	    unless ($Db{area}) {
			Log("no site design table 'cat'");
			return undef;
		}
		my $name = $Db{cat}->field($item, 'name');
		if ($Db{cat}->delete_record($item)) {
			$out .= "Deleted $name from cat table<BR>";
		}
		else {
			$out .= "Item $item not in $_ table (or delete failed)<BR>";
		}
		$Scratch->{ui_message} = $out;
		return;
	[/perl]
[else]
	[set ui_message]Not authorized to delete items.[/set]
[/else]
[/if-mm]
[/set]


<br>
<input type=submit name=mv_click value="Delete category"
	 onClick="this.form.target='_self'; return confirm('Are you sure you want to delete this category?')">
<br><br>
<small><small><i>Values in (parentheses) are the sort precedence. Ties are sorted by title.</I></small></small>

</td>

<td bgcolor="__UI_C_INTBLOCK__" valign=top>


<table>
<tr>

<td>
[set name="<--"]
[if-mm advanced layout=e]
[flag type=write table=cat]
[perl tables=cat]
	my $db = $Db{cat};
	if (! $db) {
		Log ("No category database.");
		return;
	}
	my $area = $CGI->{area};
	@codes = split /\0/, $CGI->{add_cat};
	for(@codes) {
		my $curr = $db->field($_, 'area');
		if($curr) {
			$curr =~ s/\s+$//;
			$curr .= " $area";
		}
		else {
			$curr = $area;
		}
		$db->set_field($_, 'area', $curr);
	}
	return;
[/perl]
[/if-mm]
[perl tables=cat]
[/set]
[set name="-->"]
[if-mm advanced layout=e]
[flag type=write table=cat]
[perl tables=cat]
	my $db = $Db{cat};
	if (! $db) {
		Log ("No category database.");
		return;
	}
	my $area = $CGI->{area};
	@codes = split /\0/, $CGI->{cat};
	my @there;
	foreach my $one (@codes) {
		my %seen;
		my $curr = $db->field($one, 'area');
		Log("current = $curr");
		@there = grep $_ ne $area, split /\s+/, $curr;
		Log("now = @there");
		@there = grep !$seen{$_}++, @there;
		$db->set_field($one, 'area', join " ", @there);
	}
	return;
[/perl]
[/if-mm]
[/set]
<INPUT TYPE=submit onClick="this.form.target='_self'"  NAME=mv_click VALUE="&lt;--">
<INPUT TYPE=submit onClick="this.form.target='_self'" NAME=mv_click VALUE="--&gt;">
</td>

<td VALIGN=top><B>Available categories:</B><br>
<select name="add_cat" size=10>
[loop   search="
			fi=cat
			st=db
			ml=1000

			tf=sort
			tf=name

			co=yes

			sf=area
			op=rn
			se=[data table=area col=selector key='[value area]']

			rf=code,name,sort
			"]
<OPTION VALUE="[loop-code]">[loop-param name] ([loop-param sort])
[/loop]
</select>

</td>
</tr>
</table>
</td>

</tr>

<tr>
<td colspan=3 bgcolor=__UI_C_INTBLOCKBAR__><img src="admin/cleardot.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>

<tr>
<td colspan=3 bgcolor=__UI_C_TOPBLOCKBAR__><img src="admin/cleardot.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>

[/then]
[else]
<!-- wait for them to select a category first -->
</tr>

<tr>
<td [if value area]colspan=2[/if] bgcolor=__UI_C_TOPBLOCKBAR__><img src="admin/cleardot.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>
[/else]
[/if]

</table>

</form>

<BR>
@@UI_STD_FOOTER@@
<!-- page: @@MV_PAGE@@ -->






