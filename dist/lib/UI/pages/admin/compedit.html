[set page_title]Edit Page Component[/set]
[set ui_class]Design[/set]
[set help_name]page.main[/set]
[set icon_name]icon_pages.gif[/set]
@_UI_STD_HEAD_@

<!-- ----- BEGIN REAL STUFF ----- -->

<form action="[area @@MV_PAGE@@]" method=POST>
<input type=hidden name=mv_action value=back>

<table __UI_T_PROPERTIES__>
<tr>
<td colspan=2 bgcolor=__UI_C_TOPBLOCKBAR__><img src="bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>
[perl tables="__UI_COMPONENT_TABLE__ __UI_META_TABLE__"] 
	my $ref;
	my $ref_in_page;
	my $t_name = '';
	my $cdb = $Db{__UI_COMPONENT_TABLE__};
	my $c_name;

	if($c_name = $Session->{arg}) {
		if($cdb->record_exists($c_name)) {
		}
		else {
			
		}
		$CGI->{ui_template} = $Tag->filter('filesafe', $CGI->{ui_template});
		# Parens are necessary to generate array context
		my ($ary) = $Tag->read_ui_template($CGI->{ui_template});
		$ref = shift @$ary || {};
		$t_name = $CGI->{ui_template};
		$t_desc = $ref->{ui_template_description} || 'none';
	}

	my @choices = split /\s*\0\s*/, $CGI->{ui_page};
	my $page;
	for(@choices) {
		next if ! $_;
		$page = $_;
		$page .= $Config->{HTMLsuffix} if $page !~ /$Config->{HTMLsuffix}$/;
		$page = "pages/$page" if $page !~ m(^pages/);
		last;
	}

	my $ary;
	my $current = $Tag->file($page);

	# This call returns an array of hashes if exists
	if($current) {
		($ary) = $Tag->read_ui_template($page);
		if(ref $ary) {
			$ref_in_page = shift (@$ary);
		}
	}

	if(! $ref and $ref_in_page) {
		$ref = $ref_in_page;
	}
	elsif($ref_in_page) {
		for(keys %$ref_in_page) {
			$ref->{$_} = $ref_in_page->{$_};
		}
	}
	else {
		$ref = {} if ! $ref;
		$current !~ m{<!--\s+begin\s+content\s+-->(.*)<!--\s+end\s+content\s+-->}is
			and $current = "<!-- BEGIN CONTENT -->$current<!-- END CONTENT -->";
	}

	$t_name = $ref->{ui_template_name} || 'None'
		if ! $t_name;
	$t_desc = $ref->{ui_template_description} || 'n/a'
		if ! $t_desc;

	my @def;

	foreach $e (keys %$ref) {
		my $v = $ref->{$e};
		if(ref $v) {
			for(keys %$v) {
				push @def, "$e: $_ : $v->{$_}";
			}
		}
		else {
			push @def, "$e: $v";
		}
	}
	my $def_string = join "\n", @def;
	if($def_string) {
		$def_string =~ s/"/&quot;/g;
	}

	my $r;
	#Log("ui_control_element=$ref->{ui_control_element}");
	if ($r = $ref->{ui_control_element} and ref($r)) {
			my $widget;
			for(keys %$r) {
				#Log("r key $_");
				my ($set) = $current =~ m{\[set\s+$_\](.*?)\[/set\]};
				my $t_set = $r->{$_};
				if($t_set =~ /=.*,.*=/) {
					$widget = $Tag->widget( {
												name => "ui_control_$_",
												passed => $t_set,
												default => $set,
											});
				}
				else {
					my $val = $set || $t_set;
					$val =~ s/"/&quot;/g;
					$widget = qq{<INPUT NAME="ui_control_$_" VALUE="$val" SIZE=60>};
				}
				my $desc = $ref->{ui_control_description}{$_} || $_;
				push @controls, [ $desc, $widget ];
			}
	}
	my $out = <<EOF;
<tr>
	<td bgcolor=__UI_C_INTBLOCK__><b>Page file</b></td>
	<td bgcolor=__UI_C_INTBLOCK__>$page<INPUT TYPE=hidden NAME=ui_page VALUE="$page"></td>
</tr>
<tr>
	<td bgcolor=__UI_C_INTBLOCK__><b>Template name</b></td>
	<td bgcolor=__UI_C_INTBLOCK__>$t_name</td>
</tr>
<tr>
	<td bgcolor=__UI_C_INTBLOCK__><b>Template description</b></td>
	<td bgcolor=__UI_C_INTBLOCK__>$t_desc</td>
</tr>
<tr>
	<td bgcolor=__UI_C_INTBLOCK__>
		<b>Template sequence</b><br>
	</td>
	<td bgcolor=__UI_C_INTBLOCK__ VALIGN=top><INPUT NAME=ui_elements SIZE=80 VALUE="$ref->{ui_template_layout}"></td>
</tr>
<tr>
	<td bgcolor=__UI_C_INTBLOCK__ colspan=2>
		<small><i>UI_CONTENT is the content portion(s), all others refer
		to Knar elements.</i></small>
	</td>
</tr>
<tr>
<td colspan=2 bgcolor=__UI_C_TOPBLOCKBAR__><img src="bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>
EOF

	my $table_done;
	for(@controls) {
		$out .= <<EOF unless $table_done++;
<tr>
	<td bgcolor=__UI_C_INTBLOCK__ colspan=2>
		<B>Control elements</B>
		<input type=hidden name=ui_definition value="$def_string">
	</td>
</tr>
<tr>
<td colspan=2 bgcolor=__UI_C_TOPBLOCKBAR__><img src="bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>
EOF
		$out .= qq{<tr><td bgcolor=__UI_C_INTBLOCK__><b>$_->[0]</td><td bgcolor=__UI_C_INTBLOCK__>$_->[1]</td></tr>};
	}

	if($current) {
		$current =~ m{<!--\s+begin\s+content\s+-->(.*)<!--\s+end\s+content\s+-->}is;
		$content = $1 || '';
	}
	$content =~ s/</&lt;/g;
	$content =~ s/\[/&#91;/g;

	# If nothing else, display the content
	$ref->{ui_template_layout} = 'UI_CONTENT'
		if ! $ref->{ui_template_layout};

	$out .= <<EOF;
<tr>
<td colspan=2 bgcolor=__UI_C_TOPBLOCKBAR__><img src="bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>
<tr>
	<td bgcolor=__UI_C_INTBLOCK__ COLSPAN=2>
	<b>Content</b>
	</td>
</tr>

<tr>
<td colspan=2 bgcolor=__UI_C_TOPBLOCKBAR__><img src="bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>

<tr>
	<td colspan=2 bgcolor=__UI_C_INTBLOCK__>
		<TEXTAREA NAME=ui_content COLS=80 ROWS=20>$content</TEXTAREA>
	</td>
</tr>
EOF
	$out .= <<EOF;
</td>
</tr>
EOF
	return $out;
[/perl]

<tr>
<td colspan=2 bgcolor=__UI_C_TOPBLOCKBAR__><img src="bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>

<tr>
<td colspan=2 bgcolor=__UI_C_INTBLOCK__>
[set Preview]
mv_nextpage=__UI_BASE__/page_preview
[/set]

[set Save]
mv_nextpage=__UI_BASE__/page_save
[/set]

[set Cancel]
mv_nextpage=__UI_BASE__/page
mv_todo=back
[set Cancel][/set]
[/set]

<INPUT TYPE=submit NAME=mv_click VALUE=Preview onClick="this.form.target='page_preview'">
<INPUT TYPE=submit NAME=mv_click VALUE=Save onClick="this.form.target='_self'">
<INPUT TYPE=submit NAME=mv_click VALUE=Cancel onClick="this.form.target='_self'">
</td>
</tr>

<tr>
<td colspan=2 bgcolor=__UI_C_TOPBLOCKBAR__><img src="bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>

</table>
</form>


<!-- ----- END REAL STUFF ----- -->

@_UI_STD_FOOTER_@
<!-- page: @@MV_PAGE@@ -->
