[if !cgi mv_data_table]
[calc]
	$CGI->{mv_data_table} = $Values->{mv_data_table} = $Config->{ProductFiles}[0];
	return;
[/calc]
[/if]


<!-- sequence_edit: [cgi ui_sequence_edit] -->
<!-- item_id_left: [cgi item_id_left] -->
[if cgi deleterecords]
[if-mm function="!tables" table="[cgi mv_data_table]"]
[bounce page="__UI_BASE__/error"]
[else]
<!-- flag write for delete: [flag type=write table="[cgi mv_data_table]"] -->
[/else]
[/if-mm]
[/if]

[perl tables="[cgi mv_data_table] __UI_META_TABLE__"]
	delete $Scratch->{ui_location};
	if($CGI->{ui_sequence_edit}) {
		my $doit;
		if($CGI->{item_id_left} =~ s/^(.*?),//) {
			$CGI->{item_id} = $1;
			$doit = 1;
		}
		elsif ($CGI->{item_id_left}) {
			$CGI->{item_id} = delete $CGI->{item_id_left};
			delete $CGI->{ui_sequence_edit};
			$doit = 1;
		}
		else {
			delete $CGI->{item_id};
			delete $CGI->{ui_sequence_edit};
		}
		return unless $doit;
		$Scratch->{ui_location}
				= $Tag->area( {
						href => '__UI_BASE__/item_edit',
						form => qq{
							item_id=$CGI->{item_id}
							item_id_left=$CGI->{item_id_left}
							ui_sequence_edit=$CGI->{ui_sequence_edit}
						},
					});
		return;
	}

	return unless $CGI->{item_id};
	return unless delete $CGI->{deleterecords};
	return unless $Tag->if_mm('tables', '=d');

	delete $Scratch->{ui_location};
	$Config->{NoSearch} = '';
	my $tab = $CGI->{mv_data_table} or return;

	my $db = $Db{$tab};
	if(! ref $db) {
		$Scratch->{error_message} = "<FONT CLASS=error>Error: no <B>$tab</B> database.</FONT><BR>";
		$Scratch->{ui_location} = "__UI_BASE__/error";
		return;
	}

	for(grep $_, @{$CGI_array->{item_id}}) {
		$db->delete_record($_)
			or push @errors, $@;
	}
	if(@errors) {
		my $plural = @errors > 1 ? 's' : '';
		return "<FONT CLASS=error>Error$plural:<UL><LI>" .
				join ("<LI>", @errors)                    .
				"</UL></FONT><BR>";
	}
	return;
[/perl]

[if scratch ui_location]
	[bounce href=`delete $Scratch->{ui_location}`]
[/if]

[set ui_class]Items[/set]
[set page_title]Item editor[/set]
[set table_perm]__UI_PRODUCT_TABLE__=v[/set]
[set help_name]item.editor[/set]
[set icon_name]admin/icon_item.gif[/set]
@_UI_STD_HEAD_@


<!-- ----- BEGIN REAL STUFF ----- -->
[if scratch ui_message]
<BLOCKQUOTE>
	[scratchd ui_message]
</BLOCKQUOTE>
<p>
&nbsp;
[/if]

<FORM ACTION="[area @@MV_PAGE@@]">
<INPUT NAME=ui_text_qualification>
<INPUT TYPE=submit VALUE="Limit with search">
</FORM>
[if cgi ui_text_qualification]
<H3>Entries containing "[cgi ui_text_qualification]"</H3>
[/if]
[search-region more=1 arg="
		[if cgi ui_text_qualification]
		se=[cgi ui_text_qualification]
		su=yes
		[else]ra=yes[/else][/if]
		[if cgi ui_sort_field]
			tf=[cgi ui_sort_field]
			to=[cgi ui_sort_option]
		[else]
			tf=description
		[/else]
		[/if]
		st=db
		sp=@@MV_PAGE@@
		ml=__UI_SZ_LIST_ITEMS__
"][on-match]
[calc] 
	my $so   = $CGI->{ui_sort_option};
	my $fld  = $CGI->{ui_sort_field};
	$fld =~ s/[\s,\0].*//;
	sub sortrev {
		my ($f, $n) = @_;
		my $out = 'ui_sort_option=';
		$out .= 'n' if $n;
		return $out unless ($fld eq $f) || ($f eq 'description');
		return $out if $so =~ /r/;
		return $out . 'r';
	}
	return;
[/calc]

<FORM ACTION="[area __UI_BASE__/item_edit]" METHOD=POST>
<INPUT TYPE=hidden NAME=mv_action VALUE=back>
<TABLE border=0 CELLSPACING=0 width="90%">
<tr bgcolor="#000000" height=1><td colspan=8></td></tr>
<TR BGCOLOR="__UI_C_TITLEBARBG__">
<TH ALIGN=LEFT><FONT COLOR="__UI_C_TITLEBARTXT__">[page href=@@MV_PAGE@@ form=`
	return "ui_sort_field=sku\n" . sortrev('sku');
	`]SKU</TH>
<TH ALIGN=LEFT><FONT COLOR="__UI_C_TITLEBARTXT__">[page href=@@MV_PAGE@@ form=`
	return "ui_sort_field=description\n" . sortrev('description');
	`]Description</TH>
<TH ALIGN=RIGHT><FONT COLOR="__UI_C_TITLEBARTXT__">[page href=@@MV_PAGE@@ form=`
	return "ui_sort_field=price\n" . sortrev('price', 1);
	`]Price</TH>
<TH ALIGN=CENTER><FONT COLOR="__UI_C_TITLEBARTXT__">Qty pricing</TH>
<TH ALIGN=CENTER><FONT COLOR="__UI_C_TITLEBARTXT__">Up-sell</TH>
<TH ALIGN=CENTER><FONT COLOR="__UI_C_TITLEBARTXT__">Cross-sell</TH>
<TH ALIGN=CENTER><FONT COLOR="__UI_C_TITLEBARTXT__">Promotion</TH>
<TH ALIGN=right><FONT COLOR="__UI_C_TITLEBARTXT__">Inventory</TH>

</tr>
<tr bgcolor="#000000" height=1><td colspan=8></td></tr>
<tr bgcolor="#FFFFFF" height=2><td colspan=8></td></tr>
[/on-match]
[search-list]
<TR [item-alternate 2]BGCOLOR="__UI_T_ROW_EVEN__"[else]BGCOLOR="__UI_T_ROW_ODD__"[/else][/item-alternate]>
<TD><INPUT TYPE=checkbox NAME=item_id VALUE="[item-code]"> [page href=__UI_BASE__/item_edit form="item_id=[item-code]"][item-code]</A></TD>
<TD>[filter 30][item-description][/filter]</TD>
<TD ALIGN=RIGHT>[item-price]</TD>
<TD ALIGN=CENTER>[page href=__UI_BASE__/item_price form="
	item_id=[item-code]
"][if-item-data pricing sku]Yes[else]No[/else][/if-item-data]</A>
</TD>
<TD ALIGN=CENTER>[page href=__UI_BASE__/item_up form="
	item_id=[item-code]
"][if-item-data merchandising upsell_to]Yes[else]No[/else][/if-item-data]</a>
</TD>
<TD ALIGN=CENTER>[page href=__UI_BASE__/item_cross form="
	item_id=[item-code]
"][either][if-item-data merchandising cross_category]Yes[/if-item-data][or][if-item-data merchandising cross_sell]Yes[/if-item-data][or]No[/either]</a>
</TD>
<TD ALIGN=CENTER>[page href=__UI_BASE__/item_feature form="
	item_id=[item-code]
"][if-item-data merchandising featured]Yes[else]No[/else][/if-item-data]</a>
</TD>
<TD ALIGN=right>[page href=__UI_BASE__/item_inventory form="
	item_id=[item-code]
"][if-item-data inventory quantity ne ''][item-data inventory quantity][else]N/A[/else][/if-item-data]</a>
</TD>
</tr>

[/search-list]
[no-match]
<tr>
<td colspan=6 align=left>
<br>
<B>Nothing matched.</B>
<br><br>
</td>
</tr>
[/no-match]
<tr bgcolor="#000000" height=1><td colspan=8></td></tr>
<tr bgcolor="#FFFFFF" height=8><td colspan=8></td></tr>
[more-list]
<tr>
<td colspan=8 align=center>
More items: [decade-next][/decade-next] [more] [decade-prev][/decade-prev]
</td>
</tr>
[/more-list]
</table>
[button text="Edit checked items in sequence"]
ui_sequence_edit=[calc]
	$CGI->{item_id_left} = $CGI->{item_id};
	$CGI->{item_id_left} =~ s/\0+/,/g;
	Log("in ui_sequence_edit click");
	if($CGI->{item_id_left} =~ s/^(.*?),//) {
		$CGI->{item_id} = $1;
		return 1;
	}
	else {
		delete $CGI->{item_id_left};
		return '';
	}
[/calc]
mv_nextpage=__UI_BASE__/item_edit
mv_todo=return
[/button]

&nbsp;&nbsp;&nbsp;&nbsp;

[button text="Delete checked items"
		confirm="Are you sure you want to delete the checked items?"]
[flag type=write table="[cgi mv_data_table]"]
deleterecords=1
mv_todo=back
mv_nextpage=@@MV_PAGE@@
[/button]
</FORM>

[/search-region]
<!-- ----- END REAL STUFF ----- -->

@_UI_STD_FOOTER_@
<!-- page: @@MV_PAGE@@ -->
