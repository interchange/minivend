[if !cgi mv_data_table]
[calc]
	$CGI->{mv_data_table} = $Values->{mv_data_table} = $Config->{ProductFiles}[0];
	return;
[/calc]
[/if]
[comment]
[if-mm function="!tables" table=`$Config->{ProductFiles}[0]`]
[bounce page="__UI_BASE__/error"]
[/if-mm]
[/comment]

[set page_title]Item editor[/set]
[set table_perm]1[/set]
[set help_name]item.main[/set]
[set icon_name]admin/icon_item.gif[/set]
@_UI_STD_HEAD_@


<!-- ----- BEGIN REAL STUFF ----- -->
[if scratch ui_message]
<BLOCKQUOTE>
	[scratch ui_message]
	[set ui_message][/set]
</BLOCKQUOTE>
<p>
&nbsp;
[/if]
<form action="[area process]" method="post">
<INPUT TYPE=hidden NAME=mv_todo     VALUE=return>
<INPUT TYPE=hidden NAME=mv_nextpage VALUE="__UI_BASE__/item_edit">
<INPUT TYPE=hidden NAME=mv_data_table VALUE="[calc]$Config->{ProductFiles}[0][/calc]">
<INPUT TYPE=hidden NAME=ui_data_fields VALUE="[either]__UI_ITEM_FIELDS__[or]description image comment size color sku price weight category[/either]">
<INPUT TYPE=hidden NAME=ui_break_before VALUE="[either]__UI_ITEM_BREAK__[or]description image sku category[/either]">

<table __UI_T_PROPERTIES__>
<tr>
<td colspan=2 bgcolor=__UI_C_TOPBLOCKBAR__><img src="admin/cleardot.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>

[set Create new item]
ui_hide_key=0
item_id=new
sku=new
[/set]

<tr>
<td bgcolor="__UI_C_INTBLOCK__" width=__UI_LEFT_WIDTH__>
<input type="submit" name="mv_click" value="Create new item">
</td>

<td bgcolor="__UI_C_INTBLOCK__" width=__UI_RIGHT_WIDTH__>

&nbsp; <!-- make sure theres always *something* in the cell -->

</td></tr>

<tr>
<td colspan=2 bgcolor=__UI_C_INTBLOCKBAR__><img src="admin/cleardot.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>

<tr>
<td bgcolor="__UI_C_INTBLOCK__">

<input type="submit" name="show_edit_cmd" value="Edit item">
<br>

[button name="show_changematrix_cmd" text="Change matrix"][/button]
<br>
<input type="submit" name="show_editallvariants_cmd" value="Edit all 
 variations">
<br>

[button
	text="Delete item"
	src="admin/dalete.gif"
	alt="Delete the item from the database"
	confirm="Are you sure you want to delete this item from [either]__UI_ITEM_EXPUNGE__[or]inventory pricing products[/either]?"
	
]
	[loop list="[either]__UI_ITEM_EXPUNGE__[or]inventory pricing products[/either]"]
	[flag type=write table="[loop-code]"]
	[/loop]
	mv_nextpage=__UI_BASE__/item
	[if-mm advanced item=d]
		[perl tables="[either]__UI_ITEM_EXPUNGE__[or]inventory pricing products[/either]"]
			my ($item) = $CGI->{item_id};
			my $tabs = $Variable->{UI_ITEM_EXPUNGE} || q/products pricing inventory/;
			my @tabs = split /[\s\0,]+/, $tabs;
			my $out;
			for(@tabs) {
				next unless $Db{$_};
				if ($Db{$_}->delete_record($item)) {
					$out .= "Deleted $item from $_ table<BR>";
				}
				else {
					$out .= "Item $item not in $_ table (or delete failed)<BR>";
				}
			}
			$Scratch->{ui_message} = $out;
			return;
		[/perl]
	[else]
		[set ui_message]Not authorized to delete items.[/set]
	[/else]
	[/if-mm]
[/button]
</td>
<td bgcolor="__UI_C_INTBLOCK__">
<input	onChange="this.form.mv_nextpage.value='@@MV_PAGE@@'; this.form.submit()"
		name=ui_searchspec size=20>
[button text="Limit" src="admin/search.gif"]
	mv_nextpage=@@MV_PAGE@@
[/button]<BR>

<select name="item_id" size=10>
[loop
    more=1
    search=`
		my $pf   = $Config->{ProductFiles}[0];
		my $key  = $Config->{Database}{$pf}{KEY} || 'sku';
		my $sort = $Variable->{UI_ITEM_SORT} || $Config->{DescriptionField};
		my $show = $Variable->{UI_ITEM_LIST} || $Config->{DescriptionField};
		my $size = $Variable->{UI_ITEM_PAGE_SIZE} || 50;
		if($CGI->{ui_searchspec}) {
			my ($field, $spec) = split /\s*=\s*/, $CGI->{ui_searchspec}, 2;
			if(! $spec) {
				$limit = qq{se=$field};
			}
			else {
				$limit = qq{co=yes\nac=0\n};
				while ($spec =~ s/\s*,\s*(.*=.*)//) {
					my $hold = $1;
					$limit .= qq{sf=$field\nse=$spec\n};
					($field, $spec) = split /\s*=\s*/, $hold, 2;
				}
				$limit .= qq{sf=$field\nse=$spec\n};
			}
		}
		else {
			$limit = 'ra=yes';
		}
		return <<EOF;
	fi=$pf
	st=db
	$limit
	ml=$size
	tf=$sort
	rf=$key,$show
EOF
	`]
[list][loop-sub limit_return]
	my $line = shift;
	my @items = split /\t/, $line;
	for(@items) {
		next unless length($_) > 30;
		$_ = substr($_, 0, 27) . '...';
	}
	return join ", ", @items;
[/loop-sub]
<option value="[loop-code]"> [loop-exec limit_return][loop-line 1][/loop-exec]
[/list]
</select>
[more-list]<BR>Items [matches] of [value mv_search_match_count], pages: [more][/more-list]
[/loop]
</td>
</tr>

<tr>
<td colspan=2 bgcolor=__UI_C_TOPBLOCKBAR__><img src="admin/cleardot.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>

</table>

</form>


<!-- ----- END REAL STUFF ----- -->

@_UI_STD_FOOTER_@
<!-- page: @@MV_PAGE@@ -->
