[set page_title]Edit Template[/set]
[set ui_class]Content[/set]
[set help_name]page.main[/set]
[set icon_name]icon_pages.gif[/set]
@_UI_STD_HEAD_@

<!-- ----- BEGIN REAL STUFF ----- -->
[loop search="
        fi=backup
        co=yes
        sf=sku
        se=[cgi ui_template]
        st=db
        tf=mod_time
        to=nr
        rf=code,page_name,mod_time
        "]
[on-match]
<P>
<b>[loc]Backup copies[/loc]</b>
<BLOCKQUOTE>
[/on-match]
[list]
[page href="__UI_BASE__/template_edit"
	  form="
		ui_template=[cgi ui_template]
		ui_template_backup=[loop-code]
	  "][loop-param page_name]</A> (save time [convert-date][loop-param mod_time][/convert-date](
            [page href=__UI_BASE__/page_edit_diff
					form="
						current=[cgi ui_template]
						previous=[loop-code]
					"]diff</A>,
            [page href=__UI_BASE__/page_edit_diff
					form="
						current=[cgi ui_template]
						previous=[loop-code]
						context=1
					"]context diff</A> from [cgi ui_template])<BR>
[/list]
[on-match]
</BLOCKQUOTE>
[/on-match]
[/loop]

<form action="[area ui]" method=POST ENCTYPE="multipart/form-data">
<input type=hidden name=mv_todo value=back>
<input type=hidden name=ui_template_version value="[version]">

<table __UI_T_PROPERTIES__>
<tr id=rborder>
<td colspan=2>
<img src="bg.gif" height=1>
</td>
</tr>

[perl tables="[list-databases] __UI_META_TABLE__"] 

	# Some inits
	my $template_dir = $Variable->{UI_TEMPLATE_DIR} || 'templates';
	my $out = '';
	my $ver = $Tag->version();
	$Values->{ui_theme} = $CGI->{ui_theme} if defined $CGI->{ui_theme};
	$Values->{ui_theme} = $Variable->{THEME} unless defined $Values->{ui_theme};

	sub bleach_it {
		my $val = shift;
		$val =~ s/\s+$//g;
		$val =~ s/^\s+//g;
		$val =~ s/\W+/_/g;
		$val =~ s/_+/_/g;
		return lc($val);
	}

	sub tmp_error {
		my $msg = errmsg(@_);
		my $messages = join "\n--message--\n", @messages;
		return <<EOF;
<TR class=rerror><td colspan=2 class=cerror>$msg</td></tr>
<TR class=rerror><td colspan=2 class=cerror><XMP>$messages</XMP></td></tr>
EOF
	}

	my $new;
	my $ary;
	my $tref;
	my $t_name;
	my $t_desc;

	if($CGI->{ui_template_new}) {
#Debug("found new template");
		$t_desc = $CGI->{ui_template_description} || $CGI->{ui_template_new};
		$t_name = bleach_it($CGI->{ui_template_new});
		$new = 1;
	}
	else {
#Debug("named template cgi=$CGI->{ui_template}");
		$t_name = $CGI->{ui_template};
	}

#Debug(sprintf "template name=$t_name, length %d", length($t_name));
	return tmp_error("No name for template.")
		unless $t_name =~ /\S/;

#	my $current;
#	if (! $CGI->{ui_template_backup}) {
#		$current = $Scratch->{ui_current_content};
#	}
#	else {
#		$current = tag_data('backup', 'page_text', $CGI->{ui_template_backup});
#		$current = $Tag->filter('decode_entities', $current);
#		if(! length($current)) {
#			return tmp_error(
#					"Backup retrieval (%s) failed.",
#					$CGI->{ui_template_backup},
#					);
#		}
#	}

	my %hidden;
#Log("current begins: " . substr($current, 0, 1000) );


	# Probably should offload this to mv_click=process_filter
	my @filters = grep /^ui_filter:/, keys %$CGI;
	foreach my $key (@filters) {
		my $val = delete $CGI->{$key};
		$key =~ s/ui_filter://;
		next unless $val;
		next unless defined $CGI->{$key};
		$CGI->{$key} = $Tag->filter($val, $CGI->{$key}, $key);
	}

	my $t_revert;
	if($new and $CGI->{ui_template_template}) {
#Log("found change of template");
		$t_revert = $t_name;
		$t_name = $CGI->{ui_template_template};
	}
	elsif ($Scratch->{ui_template_structure}) {
		$tref = delete $Scratch->{ui_template_structure};
		$t_name = $tref->{ui_template_name};
	}
	else {
		$t_name = $CGI->{ui_template};
	}

#Log("template reference: " . uneval($tref) );

	if($t_name =~ m{/}) {
		$t_name =~ s:(.*)/(.*)::;
		my $p = $1;
		$t_name = bleach_it($2);
		$t_file = "$p/$t_name";
	}
	else {
		$t_name = bleach_it($t_name);
		$t_file = "$template_dir/$t_name"
	}

	push @messages, "template: $t_name; t_file=$t_file";

	### Add some code here to check for existing templates...
	
	my $exists = -f $t_file;

	TEMPLATE_READ:  {
		last TEMPLATE_READ if $tref;
		last TEMPLATE_READ if ! $exists;
		($ary) = $Tag->read_ui_template($t_file);
		$tref = shift @$ary;
		ref($tref) =~ /HASH/ 
			or return tmp_error(
					"Template read error reading '%s'.",
					$t_name,
				);
		last TEMPLATE_READ if $tref;
	
   }

   if($new and ! $tref) {
		$tref = {};
		my $name_top = uc($t_name) . "_TOP";
		my $name_bot = uc($t_name) . "_BOTTOM";
		$tref->{ui_template} = $t_name;
		$tref->{ui_template_name} = $t_name;
		$tref->{ui_template_layout} = "$name_top, UI_CONTENT, $name_bot";
		$tref->{ui_template_description} = $t_desc;

		$tref->{ui_definition} = $tref->{ui_short_definition} = <<EOF;
ui_template: $t_name;
ui_template_name: $t_name;
ui_template_layout: $name_top, UI_CONTENT, $name_bot
ui_template_description: $t_desc
ui_template_version: $ver

EOF
	}

	my $template_input;
	my $content;
	if( $Values->{ui_upload_template}
		and $Tag->value_extended(
				{
					name => 'ui_upload_template',
					test => 'isfile',
				}
			)
		)							
	{
push @messages, "template from upload:\n$tref->{ui_definition}";
		$template_input = $Tag->value_extended( {
												name => 'ui_upload_template',
												file_contents => 1,
												});
		$template_input =~ s{(.*)(<!--\s+begin\s+content\s+-->)}{$2}is;
		$template_top = $1;
		$template_top =~ s/^\s+//;
		$template_top =~ s/\s+$//;
		$template_input =~ s{(<!--\s+end\s+content\s+-->)\n*(.*)}{$1\n}is;
		$template_bot = $2;
		$template_bot =~ s/^\s+//;
		$template_bot =~ s/\s+$//;
		$content = $template_input;
		$content =~ s/^\s*<!--+\s+begin\s+content\s+--+>(?:\s*\n+)?//i;
		$content =~ s/(?:\n+\s*)?<!--+\s+end\s+content\s+--+>\s*$//i;
		push @messages, "Content:\n$content";
	}

	my $example_layout;
   if($t_revert) {
   		$t_name = $t_revert;
		$example_layout = $tref->{ui_template_layout};
   		return tmp_error("Still no template reference?") unless $tref;
		my $name_top = uc($t_name) . "_TOP";
		my $name_bot = uc($t_name) . "_BOTTOM";
		$tref->{ui_template} = $t_name;
		$tref->{ui_template_name} = $t_name;
		$tref->{ui_template_layout} = "$name_top, UI_CONTENT, $name_bot";
		$tref->{ui_template_description} = $t_desc;
	}

	$t_desc = $tref->{ui_template_description} if ! $t_desc;

######## BEGIN INIT TEMPLATES
		my $sep_template = <<EOF;
<tr class=rheader>
<td class=cheader colspan=2>Component ~NUMBER~ (~NAME~)</td>
</tr>
<tr class=rnorm>
<td class=clabel>Default&nbsp;component</td>
<td class=cdata>
	<table width="100%">
	<tr>
		<td class=cdata width="50%">
			~NAMESEL~
		</td>
		<td class=clabel width="15%">
			Type
		</td>
		<td class=cdata width="35%">
			~TYPESEL~
		</td>
	</tr>
	</table>
</tr>
EOF

		my $break_template = <<EOF;
<tr class=cmarq>
<td colspan=2><img src="bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>
EOF

		my $title_template = <<EOF;
<tr class=rborder>
<td colspan=2><img src="bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>
<tr class=rtitle>
<td colspan=2 class=ctitle><span style="font-size: larger; font-weight: bold">~TITLE~</span></td>
</tr>
<tr class=rborder>
<td colspan=2><img src="bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>
EOF

		my $control_template = <<EOF;
<tr>
   <td class=clabel width="$Variable->{UI_LEFT_WIDTH}"> 
     \$LABEL\$~META~
   </td>
   <td class=cdata> 
     <table cellspacing=0 cellmargin=0 width="100%">
       <tr> 
         <td class=cwidget> 
           \$WIDGET\$
         </td>
         <td class=chelp>~TKEY~<i>\$HELP\$</i>{HELPURL}<BR><A HREF="\$HELP_URL\$">help</A>{/HELPURL}</FONT></td>
       </tr>
     </table>
   </td>
</tr>
EOF

######## END INIT TEMPLATES

	sub title_row {
		my $title = shift;
		my $out = $title_template;
		$out =~ s/~TITLE~/$title/g;
		return $out;
	}

	if($tref and ! $template_top) {
		my @el = split /[\s,\0]+/, $example_layout || $tref->{ui_template_layout};
		my $i = -1;
		my $found;
		for (@el) {
			$i++;
			next unless $_ eq 'UI_CONTENT';
			$found = $i;
			last;
		}
		for($i = 0; $i < $found; $i++) {
			$template_top .= $Tag->var($el[$i], 2);
#Log("i=$i, reading top variable $el[$i]");
		}
		for($i = $found + 1; $i < @el; $i++) {
			$template_bot .= $Tag->var($el[$i], 2);
#Log("i=$i, reading bot variable $el[$i]");
		}
#Log("Template top: $template_top");
	}


#Log("t_name=$t_name");

	my $template = $CGI->{ui_template};

	$out .= title_row( errmsg("Template file: %s", $template ) );
	$hidden{ui_template}			= $t_file;
	$hidden{ui_template_name}		= $t_name;
	$hidden{ui_template_layout} = $tref->{ui_template_layout};

	my $outdesc = $t_desc;
	$outdesc =~ s/"/&quot;/g;
	$out .= <<EOF;
<tr>
<td colspan=2 bgcolor=__UI_C_TOPBLOCKBAR__><img src="bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>
<tr>
	<td bgcolor=__UI_C_INTBLOCK__>
		<b>Template</b>
	</td>
	<td bgcolor=__UI_C_INTBLOCK__>
		<span style="font-size: larger">$t_name</span>
	</td>
</tr>
<tr>
	<td bgcolor=__UI_C_INTBLOCK__>
		<b>Description</b>
	</td>
	<td bgcolor=__UI_C_INTBLOCK__>
		<INPUT TYPE=text NAME=ui_template_description VALUE="$outdesc" SIZE=60>
	</td>
</tr>
EOF

	$out .= <<EOF;
<tr>
	<td class=ralt>
		<b>Template sequence</b><br>
	</td>
	<td class=ralt VALIGN=top>
		$tref->{ui_template_layout}
	</td>
</tr>
<tr>
	<td class=ralt colspan=2>
		<small><i>UI_CONTENT is the content portion(s), all others refer
		to region variables elements.</i></small>
	</td>
</tr>
<tr class=rtitle>
<td colspan=2 class=ctitle><img src="bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>
EOF

	$content = '' if ! $content;

	$content_display = $content;

	my $compdir = $Variable->{UI_COMPONENT_DIR} || 'templates/components';
	my ($carray) = $Tag->read_ui_template("$compdir/*");
	my $chash = {};
	my $ctype = { EVERY => [] };
	for(@$carray) {
		my $name = $_->{ui_component};
		$chash->{$name} = $_;
		push @{$ctype->{EVERY}}, $name;
		my @ty = grep /\S/, split /[\s,\0]+/, $_->{ui_component_type};
		for(@ty) {
			$ctype->{$_} ||= [];
			push @{$ctype->{$_}}, $name;
		}
	}

	my @alltype;
	@alltype = grep $_ !~ /^EVERY|ALL$/, keys %$ctype;
	@alltype = sort { "\L$a" cmp "\L$b" } @alltype;
	push @alltype, 'ANY';
	my $c_type = join ",", @alltype;

	for(keys %$chash) {
		my $r = $chash->{$_};
		delete $r->{ui_current_content};
		delete $r->{ui_definition};
	}

	my $template_div = 0;

	for(\$template_top, \$template_bot) {
#Log("looking in template, length " . length($$_));
		while( $$_ =~ m{
				 [ \t]* 
				 (?:
				 	<!--+ \s+ begin \s+ component \s+ (\w+) \s+ (\w*) \s* --+>
				 	(.*?)
					<!--+ \s+ end \s+ component \s+ \1 \s+ --+> 
				 | 
				 	\[ include \s+ file \s*=\s*["'][^"]*/
						(?:\[control \s+ component \s+ )?
							(\w+)
						\]? ['"]
					(?:\s+group=["']?(\w*)['"]?)?
					\]  \s*  \[control\]
				 )
			}gsix)
		{
			my $compname = $1 || $4;
			my $comptype = $2 || $5;
#Log("Found component $compname, group $comptype");
			my $current_content = $3 || '';
			
#Log ("Read component $compname=$chash->{$compname}.");
			push @messages, ("Read component $compname=$chash->{$compname}.");
#			push @messages, ("component $compname structuret:\n"
#							. $Tag->uneval({ ref => $carray } ) );
			if ($chash->{$compname}) {
				my $r = { %{$chash->{$compname}} } ;
				if($comptype) {
					$r->{ui_component_type_current} = $comptype;
				}
				push @cobj, $r;
			}
			else {
				my $desc	= -f "$compdir/$compname"
							? 'Static component, no controls'
							: 'non-existent component (creating later?)';
				push @cobj, {
					ui_component  => $compname,
					ui_component_name => $compname,
					ui_component_description => $desc,
				};
			}
		}

		$template_div = scalar(@cobj) unless $template_div;

		$$_ =~ s{
				 [ \t]*<!--+
				 	\s+ begin \s+ component \s+ (\S+) (?:\s*(\S+))? \s+ --+>
				 	(.*?)
				 <!--+ \s+end \s+component \s+ \1 \s+ --+> 
			}
			{[include file="$compdir/[control component $1]" group="$2"][control]}gsix;
		
	}

	$template_top_display = $template_top;
	$template_bot_display = $template_bot;
	
	for(\$template_top_display, \$template_bot_display) {
		$$_ =~ s{
						\[include\s+
						[^\]]+
						\[control\s+component
						[^\]]+
						\]
						[^\]]*
						\]
						(?:\s*\[control\])?}
				{'<!-- COMPONENT #'. ++$cnum . ' -->'}egsix;
		$$_ =~ s/\&/\&amp;/g;
		$$_ =~ s/\[/&#91;/g;
		$$_ =~ s/</&lt;/g;
	}

	my $pref = $Tag->read_ui_page( { body => $current } ) || {};
	return tmp_error("No page content!") unless $pref;

	my @settings;

	if($pref->{ui_component}[0]) {
		@settings = @{ $pref->{ui_component} };
		for (my $i = 0; $i < @cobj; $i++) {
			my $grp = $cobj[$i]->{ui_component_type_current};
			my $name = $settings[$i]->{component};
			undef $grp if $grp eq 'ALL';
			my $ref = $chash->{$name} || $chash->{none};
			$cobj[$i] = { %$ref };
			$cobj[$i]->{ui_component_type_current} = $grp;
		}
	}

	my $content;

	length($current) and
		$current =~ m{<!--\s+begin\s+content\s+-->\n*(.*)\n*<!--\s+end\s+content\s+-->}is
		and $content = $1;


	my $idx = 0;
	my $num = $idx + 1;

	sub get_unified_ref {
		my ($name, $ref) = @_;
		my $uniref = {};
		for(keys %$ref) {
			next unless ref($ref->{$_}) eq 'HASH';
			$uniref->{$_} = $ref->{$_}{$name} || undef;
		}
		return $uniref;
	}

	sub comp_selector {
		my ($type, $curr, $name) = @_;
#Log("called type=$type curr=$curr name=$name");
		$name = 'ui_component' unless $name;
		my $all = $ctype->{ALL} || [ 'none' ];
		my $ary = $ctype->{$type} || $ctype->{EVERY};
		$ary = $ctype->{EVERY} unless @$ary;
#Log("ary is: " . uneval($ary) );
		my @comps;
		push @comps, @$ary, @$all;
		my %seen;
		@comps = grep !$seen{$_}++, @comps;

		my $out = qq{<SELECT NAME="$name">};
		for(@comps) {
			$out .= qq{<OPTION VALUE="$_"};
			$out .= " SELECTED" if $curr eq $_;
			$out .= q{>};
			$out .= defined $chash->{$_}{ui_component_label}
				  ? $chash->{$_}{ui_component_label}  
				  : $_;
		}
		return $out .= qq{</SELECT>};
	}

	sub type_selector {
		my ($type, $curr, $name) = @_;
#Log("called type=$type curr=$curr name=$name");
		$name = 'ui_component_type' unless $name;
		my @comps = grep /\S/, split /[\0\s,]+/, $type;
		unshift @comps, $curr;
		my %seen;
		@comps = grep !$seen{$_}++, @comps;
		
		my $out = qq{<SELECT NAME="$name">};
		for(@comps) {
			$out .= qq{<OPTION VALUE="$_"};
			$out .= " SELECTED" if $curr eq $_;
			$out .= qq{>$_};
		}
		return $out .= qq{</SELECT>};
	}

	my $vsize;
	sub get_vsize {
		my ($body, $min, $max) = @_;
		my $size = $body =~ tr/\n/\n/;

		$max = 100 unless $max;
		$min = 20 unless $min;

		if($size < $min) {
			$size = $min;
		}
		elsif ($size > $max) {
			$size = $max;
		}
		else {
			$size++;
		}
		return $size;
	}

	my @globals;
	@globals = @{$tref->{ui_display_order}}
		if $tref->{ui_display_order};

	push @controls, title_row("Page Settings");

	my $glob = '';
	for my $g (@globals) {
		$glob .= "$g:\n";

		for(qw/description  help options height width filter prefilter/) {
			$glob .= "\t$_: $tref->{$_}{$g}\n"
				if ref $tref->{$_};
		}
		$glob .= "\n";
	}

	$vsize = get_vsize($glob, 10);

	my $preamble_widget = <<EOF;
<tr class=ralt>
	<td colspan=2 class=clabel>
		Page Settings <I>(accessed via scratch in header/footer)</I>
		<TEXTAREA NAME=ui_template_setting COLS=85 ROWS=$vsize>$glob</TEXTAREA>
	</td>
</tr>
EOF

	push @controls, $preamble_widget;

	$vsize = get_vsize($template_top_display);
	push @controls, <<EOF;
<tr class=ralt>
	<td colspan=2 class=clabel>
	<b>Top of template</b><BR>
		<TEXTAREA NAME=ui_template_top COLS=85 ROWS=$vsize>$template_top_display</TEXTAREA>
	</td>
</tr>
<tr>
<td colspan=2 class=rtitle><img src="bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>
EOF

	my $norest_select = $tref->{ui_template_limit_tag} ? '' : ' SELECTED';
	my $content_widget = <<EOF;
<tr>
   <td class=clabel width="$Variable->{UI_LEFT_WIDTH}"> 
     Content tag restrict
   </td>
   <td class=cdata> 
     <table cellspacing=0 cellmargin=0 width="100%">
       <tr> 
         <td class=cwidget> 
           <SELECT NAME="ui_template_limit_tag">
		   		<OPTION VALUE="value page area">Yes
		   		<OPTION VALUE=""$norest_select>No
		   </SELECT>
         </td>
         <td class=chelp><i>Restricts embedded ITL tags to <b>page, area,</b> and <b>value</b></i></td>
       </tr>
     </table>
   </td>
</tr>
EOF

	push @controls, title_row("Top Components") if @cobj;
	for(my $i = 0; $i < @cobj; $i++) {
		my $ref = $cobj[$i];
		my $settings = $settings[$i] || {};
		if($template_div and $i >= $template_div) {
			push @controls, title_row("Content");
			push @controls, $content_widget;
			push @controls, title_row("Bottom Components");
			undef $template_div;
		}
		my $c_name      = $ref->{ui_component} || 'none';
		my $c_type_curr = $ref->{ui_component_type_current};
		my $c_label     = $ref->{ui_component_label}
				        || $ref->{ui_component_description}
				        || 'no description';
		push @messages, "ui_component_name=$ref->{ui_component_name}";
		push @messages, "ui_component=$ref->{ui_component}";
		push @messages, "ui_component_label=$ref->{ui_component_label}";
		push @messages, "ui_component_description=$ref->{ui_component_description}";

		my @def;

		my $titlebar = $sep_template;
		$titlebar =~ s/~NAME~/$c_name/g;
		$titlebar =~ s/~NAMESEL~/comp_selector($c_type_curr || $c_type, $c_name, "$i.ui_component")/ge;
		$titlebar =~ s/~NUMBER~/$i + 1/eg;
		$titlebar =~ s/~TYPE~/$c_type/g;
		$titlebar =~ s/~TYPESEL~/type_selector($c_type, $c_type_curr, "$i.ui_component_type")/eg;
		$titlebar =~ s/~DESC~/$c_label/g;
		$titlebar =~ s/~VARNAME~/$i.ui_component/g;
		push @controls, $titlebar;
		my $def_string = $ref->{ui_definition};
		$def_string =~ s/"/&quot;/g;

		my $short_def = "ui_component: $c_name";

	}

	if(defined $template_div) {
		push @controls, title_row("Content");
		push @controls, $content_widget;
		undef $template_div;
	}

	$out .= join "\n", @controls;
	
	$out .= <<EOF;
<tr class=ralt>
	<td colspan=2 class=clabel>
	<b>Bottom of template</b><br>
		or input below:<br>
		<TEXTAREA NAME=ui_template_bot COLS=85 ROWS=20>$template_bot_display</TEXTAREA>
	</td>
</tr>
EOF

	$hidden{good_template} = 1;

	my $hidden = '';
	for(keys %hidden) {
		$hidden .= qq{<input type=hidden name="$_" value="};
		$hidden .= $Tag->filter('entities', $hidden{$_});
		$hidden .= qq{">\n};
	}
	$Scratch->{tmp_hidden} = $hidden;
	return $out;
[/perl]

<tr>
<td colspan=2 class=rtitle><img src="bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>

<tr class=ralt>
<td colspan=2>
[set Preview]
mv_todo=back
mv_nextpage=__UI_BASE__/template_preview
[/set]

[set Save]
mv_nextpage=__UI_BASE__/template_save
[/set]

[scratchd tmp_hidden]
<INPUT TYPE=submit NAME=mv_click VALUE=Preview onClick="this.form.target='template_preview'; this.form.action='[area __UI_BASE__/template_preview]'">
<INPUT TYPE=hidden NAME=ui_return_to VALUE="__UI_BASE__/page">
<INPUT TYPE=submit NAME=mv_click VALUE=Save onClick="this.form.target='_self'; this.form.action='[area __UI_BASE__/template_save]'">
<INPUT TYPE=submit NAME=mv_click VALUE=Cancel onClick="this.form.target='_self'; this.form.action='[area __UI_BASE__/page]'"><br>
[comment]
<!-- may come back someday -->
<INPUT TYPE=checkbox NAME=ui_save_t_in_page VALUE=1 [cgi save_in_page]> Save template in page
[/comment]

</td>
</tr>

<tr>
<td colspan=2 class=rtitle><img src="bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>

</table>
</form>


<!-- ----- END REAL STUFF ----- -->

@_UI_STD_FOOTER_@
<!-- page: __MV_PAGE__ -->
