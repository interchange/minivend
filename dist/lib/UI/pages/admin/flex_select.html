<!-- [if cgi mv_more_ip]
[calc]
	for( qw/
		help_name
		icon_name
		mv_data_table
		page_title
		ui_break_before
		ui_show_fields
		ui_sort_field
		ui_sort_option
		ui_description_fields
		ui_flex_description
		ui_flex_key
		page_banner
		/)
	{
		$CGI->{$_} = $Values->{$_};
		push @out, "$_ = $CGI->{$_}";
	}
	return join "\n", @out;
[/calc]
[/if] -->

[tmp page_title]
	[either]
		[cgi page_title]
	[or]
		Select for table edit: [cgi mv_data_table]
	[/either]
[/tmp]
[tmp page_banner]
	[either]
		[cgi page_banner]
	[or]
		[cgi page_title]
	[or]
		[loop list="[cgi mv_data_table]"]
		Select for table edit:
		[page href="__UI_BASE__/flex_editor"
				 form='
				 mv_data_table=__UI_META_TABLE__
				 ui_meta_view=dbconfig
				 ui_data_fields=code name height field help help_url
				 ui_break_before=height
				 page_title=Change display information: [loop-code]
				 ui_return_to=__UI_BASE__/gentable
				 item_id=[loop-code]
		 '][loop-code]</A>
		[/loop]
	[/either]
[/tmp]
[tmp help_name][either][cgi help_name][or]flex.select[/either][/tmp]
[tmp icon_name][either][cgi icon_name][or]admin/icon_config.gif[/either][/tmp]

[if-mm function="!tables" table="[cgi mv_data_table]"]
[bounce page="__UI_BASE__/error"]
[/if-mm]

<!-- sequence_edit: [cgi ui_sequence_edit] -->
<!-- item_id_left: [cgi item_id_left] -->
[perl tables="[cgi mv_data_table] __UI_META_TABLE__"]
	delete $Scratch->{ui_location};
	if($CGI->{ui_sequence_edit}) {
		my $doit;
		if($CGI->{item_id_left} =~ s/^(.*?),//) {
			$CGI->{item_id} = $1;
			$doit = 1;
		}
		elsif ($CGI->{item_id_left}) {
			$CGI->{item_id} = delete $CGI->{item_id_left};
			delete $CGI->{ui_sequence_edit};
			$doit = 1;
		}
		else {
			delete $CGI->{item_id};
			delete $CGI->{ui_sequence_edit};
		}
		return unless $doit;
		$Scratch->{ui_location}
				= $Tag->area( {
						href => '__UI_BASE__/flex_editor',
						form => qq{
							mv_data_table=$CGI->{mv_data_table}
							item_id=$CGI->{item_id}
							item_id_left=$CGI->{item_id_left}
							ui_sequence_edit=$CGI->{ui_sequence_edit}
							ui_return_to=__UI_BASE__/flex_select
							ui_return_to=mv_data_table=$CGI->{mv_data_table}
							ui_return_to=ui_sequence_edit=$CGI->{ui_sequence_edit}
							ui_page_banner=Edit next key $CGI->{item_id}
						},
					});
		return;
	}

	return unless $CGI->{item_id};
	return unless delete $CGI->{deleterecords};
	return unless $Tag->if_mm('tables', '=d');

	delete $Scratch->{ui_location};
	$Config->{NoSearch} = '';
	my $tab = $CGI->{mv_data_table} or return;
	my $db = $Db{$tab};
	if(! $db) {
		$Scratch->{error_message} = "<FONT CLASS=error>Error: no <B>$tab</B> database.</FONT><BR>";
		$Scratch->{ui_location} = "__UI_BASE__/error";
		return;
	}

	for(grep $_, @{$CGI_array->{item_id}}) {
		$db->delete_record($_)
			or push @errors, $@;
	}
	if(@errors) {
		my $plural = @errors > 1 ? 's' : '';
		return "<FONT CLASS=error>Error$plural:<UL><LI>" .
				join ("<LI>", @errors)                    .
				"</UL></FONT><BR>";
	}
	return;
[/perl]

[comment]
[calc]
	### Why was I doing this?
	my $out = '';
	my $page;
	delete $Scratch->{ui_location};
	return unless $CGI->{ui_return_to};
	($page, @env) = split /\0/, $CGI->{ui_return_to};
	$Scratch->{ui_location} = $Tag->area({
									href => $page,
									form => join "\n", @env,
								});
	return;
[/calc]
[/comment]

<!-- ui_location: [scratch ui_location] -->
[if scratch ui_location]
[bounce href=`delete $Scratch->{ui_location}`]
[elsif !cgi mv_data_table]
[bounce page="__UI_BASE__/gentable"]
[/elsif]
[/if]

@_UI_STD_HEAD_@
[update values]
<!-- ----- BEGIN REAL STUFF ----- -->
<FORM ACTION="[area @@MV_PAGE@@]" METHOD=post>
<table>
<tr>
<td>
		[loop list="[cgi mv_data_table]"]
		 	[if-loop-data __UI_META_TABLE__ name]
		 	<B>[loop-data __UI_META_TABLE__ name]</B>
			[/if-loop-data]
		 	[if-loop-data __UI_META_TABLE__ help_url]
		 	&nbsp;&nbsp;&nbsp;<small><A HREF="[loop-data __UI_META_TABLE__ help_url]">help</A></small>
			[/if-loop-data]
		 	[if-loop-data __UI_META_TABLE__ help]
		 	<BR><i>[loop-data __UI_META_TABLE__ name]</i>
			[/if-loop-data]
		[/loop]
</td>
<td>
<input NAME=ui_text_qualification size=16> <INPUT TYPE=submit VALUE="Limit with search">
</td>
</tr>
</table>
[if scratch ui_failure]
<P>
<BLOCKQUOTE>
<FONT COLOR="__CONTRAST__">[scratch ui_failure][set ui_failure][/set]</FONT>
</BLOCKQUOTE>
<P>
&nbsp;
[/if]
[if scratch ui_message]
<P>
<BLOCKQUOTE>
<FONT COLOR="__CONTRAST__">[scratch ui_message][set ui_message][/set]</FONT>
</BLOCKQUOTE>
<P>
&nbsp;
[/if]

[perl tables="[cgi mv_data_table] __UI_META_TABLE__"]
	my $ref = $Db{$CGI->{mv_data_table}};
	my $mref = $Db{__UI_META_TABLE__};
	
	if (! $ref) {
		$Scratch->{keypos} = 0;
		return;
	}
	elsif (! $mref) {
		$Scratch->{keypos} = 0;
		return;
	}

	my $meta;
	if($mref->record_exists($CGI->{mv_data_table}) ) {
		$meta = $mref->row_hash($CGI->{mv_data_table});
	}
	else {
		$meta = {};
	}
	if($CGI->{ui_flex_key}) {
		$Scratch->{keypos} = $CGI->{ui_flex_key};
	}
	else {
		$Scratch->{keyname} = $ref->config('KEY');
		$Scratch->{keypos} = $ref->config('KEY_INDEX');
	}

	$Config->{NoSearch} = '';
	$ui_text_qualification = $CGI->{ui_text_qualification};
	if ($ui_text_qualification and $CGI->{ui_text_qualification} =~ /=/ ) {
		my ($f, $s) = split /\s*=\s*/, $CGI->{ui_text_qualification} , 2;
		$CGI->{ui_text_qualification} = "co=1\nop=eq\nse=$s\nsf=$f";
	}
	elsif ($ui_text_qualification) {
		$CGI->{ui_text_qualification} = "se=$CGI->{ui_text_qualification}";
	}
	else {
		$CGI->{ui_text_qualification} = "ra=yes";
	}
	$CGI->{ui_sort_field} = $meta->{lookup} || $Scratch->{keyname}
		if ! $CGI->{ui_sort_field};
	$CGI->{ui_list_size} = $meta->{height}
		if ! $CGI->{ui_list_size};
	if(! ($CGI->{ui_show_fields} = $meta->{field}) ) {
		$CGI->{ui_show_fields} = '*';
		$CGI->{ui_description_fields} = join ",", $ref->columns();
	}
	else {
		$CGI->{ui_show_fields} =~ s/[\0,\s]+/,/g;
		$CGI->{ui_description_fields} = $CGI->{ui_show_fields};
	}
	@cols = split /[\s,\0]+/, $CGI->{ui_description_fields};
	for(@cols) {
		$numeric{$_} = 1 if $ref->numeric($_);
	}

	return;
[/perl]

[if cgi ui_show_fields]
	[tmp sparams]
			fi=[cgi mv_data_table]
			st=db
			[cgi ui_text_qualification]
			su=1
			md=1
			ml=[cgi ui_list_size]
			tf=[cgi ui_sort_field]
			to=[cgi ui_sort_option]
			rf=[cgi ui_show_fields]
	[/tmp]
[else]
	[tmp sparams]
		fi=[cgi mv_data_table]
		st=db
		[cgi ui_text_qualification]
		md=1
		tf=[scratch keypos]
		rf=[scratch keypos]
	[/tmp]
[/else]
[/if]

<INPUT TYPE=hidden NAME=mv_data_table    VALUE="[cgi mv_data_table]">
<INPUT TYPE=hidden NAME=ui_page_title    VALUE="[cgi ui_page_title]">
<INPUT TYPE=hidden NAME=ui_page_title    VALUE="[cgi ui_page_banner]">
<INPUT TYPE=hidden NAME=ui_meta_specific VALUE="[cgi ui_meta_specific]">
<INPUT TYPE=hidden NAME=ui_return_to     VALUE="@@MV_PAGE@@">
<INPUT TYPE=hidden NAME=ui_return_to     VALUE="mv_data_table=[cgi mv_data_table]">
<INPUT TYPE=hidden NAME=ui_return_to     VALUE="ui_sequence_edit=1">
<INPUT TYPE=hidden NAME=mv_action        VALUE=back>
<TABLE CELLSPACING=1 cellmargin=3>
<TR BGCOLOR="__UI_C_TITLEBARBG__">
[loop list="[cgi ui_description_fields]"]
<TH ALIGN=LEFT><FONT COLOR="__UI_C_TITLEBARTXT__">
	[loop-change 1][condition]1[/condition]&nbsp;&nbsp;&nbsp;&nbsp;[/loop-change 1]
	<A HREF="[area href='@@MV_PAGE@@'
					form=`
						my $f = '[loop-code]';
						my $o = '';
						$o .= 'r'
							if $CGI->{ui_sort_field} eq $f
									and
								$CGI->{ui_sort_option} !~ /r/;
						$o .= 'n' if $numeric{$f};
						return qq(
							ui_text_qualification=$ui_text_qualification
							mv_data_table=$CGI->{mv_data_table}
							ui_sort_field=$f
							ui_sort_option=$o
						);
					`
				]">[loop-code]</TH>
[/loop]
</tr>
[search-region more=1 arg="[scratch sparams]"]
[search-list]
<TR [item-alternate 2]BGCOLOR="__UI_T_ROW_EVEN__"[else]BGCOLOR="__UI_T_ROW_ODD__"[/else][/item-alternate]>

<TD><INPUT TYPE=checkbox NAME=item_id VALUE="[item-code]">&nbsp;&nbsp;[page href=__UI_BASE__/flex_editor form=|
									mv_data_table=[cgi mv_data_table]
									ui_page_title=[cgi ui_page_title]
									ui_page_title=[cgi ui_page_banner]
									ui_meta_specific=[cgi ui_meta_specific]
									ui_return_to=@@MV_PAGE@@
									ui_return_to=mv_data_table=[cgi mv_data_table]
									item_id=[item-code]
						|][item-code]</A></TD>
[item-sub show_line]
sub {
	my ($pre, $post) = split /\t/, shift;
	my $line = shift;
	return unless $line;
	shift (@$line);
	my $out = '';
	for(@$line) {
		s/\[/&#91;/g;
		$out .= "<TD>" . $Tag->filter('entities', $_) . "</TD>";
	}
	return $out . "\n";
}
[/item-sub]
[item-exec show_line][/item-exec]
</tr>
[/search-list]
[no-match]
<tr>
<td colspan=6 align=center>
<B>Nothing matched.</B>
</td>
</tr>
[/no-match]
[more-list]
<tr>
<td colspan=6 align=center>
More rows: [decade-next][/decade-next] [more] [decade-prev][/decade-prev]
</td>
</tr>
[/more-list]
</table>

[button text="Edit checked records in sequence"]
ui_sequence_edit=[calc]
	$CGI->{item_id_left} = $CGI->{item_id};
	$CGI->{item_id_left} =~ s/\0+/,/g;
	if($CGI->{item_id_left} =~ s/^(.*?),//) {
		$CGI->{item_id} = $1;
		return 1;
	}
	else {
		delete $CGI->{item_id_left};
		return '';
	}
[/calc]
mv_nextpage=__UI_BASE__/flex_editor
mv_todo=return
[/button]

&nbsp;&nbsp;&nbsp;&nbsp;

[button text="Delete checked records"
		confirm="Are you sure you want to delete the checked records?"]
[flag type=write table="[cgi mv_data_table]"]
deleterecords=1
mv_todo=back
mv_nextpage=@@MV_PAGE@@
[/button]
</FORM>
[/search-region]
<!-- ----- END REAL STUFF ----- -->

@_UI_STD_FOOTER_@
<!-- page: @@MV_PAGE@@ -->
