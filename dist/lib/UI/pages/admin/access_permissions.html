[if !cgi user_id]
	[calc] $CGI->{user_id} = $Values->{user_id}; return;[/calc]
[/if]
[if !cgi user_id]
[bounce page="__UI_BASE__/access"]
[/if]

[calc]
	$CGI->{mv_data_table} = $Values->{mv_data_table} = '__UI_ACCESS_TABLE__';
	return;
[/calc]

[seti page_title]Edit Permissions: [cgi user_id][/seti]
[set ui_class]Admin[/set]
[set page_perm]access=v[/set]
[set help_name]access.permissions[/set]
[set icon_name]admin/icon_config.gif[/set]

[set process_perm]
[perl]
	my @filters = grep /^ui_filter:/, keys %$CGI;
	foreach my $key (@filters) {
		my $val = delete $CGI->{$key};
		$key =~ s/ui_filter://;
		next unless $val;
		next unless defined $CGI->{$key};
		$CGI->{$key} = $Tag->filter($val, $CGI->{$key}, $key);
		$CGI->{$key} = s/=$//;
	}
	
	$CGI->{yes_functions} =~ s/\0//g;
	$CGI->{yes_functions} =~ s/,/ /g;
	$CGI->{yes_functions} =~ s/\w+=(?:\s+|$)//g;

	$CGI->{yes_tables} =~ s/\0//g;
	$CGI->{yes_tables} =~ s/,/ /g;
	$CGI->{yes_tables} =~ s/\w+=(?:\s+|$)//g;
	$CGI->{yes_tables} =~ s/(\w+)=vecdix(\s+|$)/$1$2/g;

	$CGI->{no_tables} =~ s/\0/ /g;
	
	$CGI->{mv_todo} = 'set';
	$CGI->{mv_nextpage} = '@@MV_PAGE@@';# unless $CGI->{mv_nextpage};
	return;
[/perl]
[/set]

@_UI_STD_HEAD_@
[if scratch ui_message]
<P>
<BLOCKQUOTE>
	[scratch ui_message][set ui_message][/set]
</BLOCKQUOTE>
<P>
&nbsp;
[/if]


<!-- ----- BEGIN REAL STUFF ----- -->

[if scratch ui_failure]
	<FONT COLOR=RED>Failed: [scratch ui_failure][set ui_failure][/set]</FONT><BR>
[/if]

<FORM METHOD=POST ACTION="[area ui]">
<INPUT TYPE=hidden NAME=mv_doit VALUE="set">
<INPUT TYPE=hidden NAME=mv_click VALUE="process_perm">
<INPUT TYPE=hidden NAME=mv_nextpage VALUE="[cgi ui_return_to]">
<INPUT TYPE=hidden NAME=user_id VALUE="[cgi user_id]">
<INPUT TYPE=hidden NAME=username VALUE="[cgi user_id]">
<INPUT TYPE=hidden NAME=mv_data_table VALUE="[value mv_data_table]">
<INPUT TYPE=hidden NAME=mv_data_key VALUE="username">
<INPUT TYPE=hidden NAME=mv_update_empty VALUE="1">
<INPUT TYPE=hidden NAME=mv_data_fields VALUE="username yes_functions no_tables yes_tables">
<INPUT TYPE=hidden NAME="mv_data_function" VALUE="update">


<table __UI_T_PROPERTIES__>

<tr>
<td colspan=6 bgcolor=__UI_C_TOPBLOCKBAR__><img src="@_UI_IMG_@admin/bg.gif" width=600 height=1></td>
</tr>

<tr>
<td bgcolor=__UI_C_INTBLOCK__ valign=top>&nbsp;</td>
<td bgcolor=__UI_C_INTBLOCK__ valign=top>View list</td>
<td bgcolor=__UI_C_INTBLOCK__ valign=top>View detail</td>
<td bgcolor=__UI_C_INTBLOCK__ valign=top>Create</td>
<td bgcolor=__UI_C_INTBLOCK__ valign=top>Edit</td>
<td bgcolor=__UI_C_INTBLOCK__ valign=top>Delete</td>
</tr>

[seti tables][list-databases][/seti]
[perl tables="__UI_META_TABLE__ __UI_ACCESS_TABLE__"]

	my @permissions = (
        item		=> 'Item editor',
        page		=> 'Page editor',
        cat			=> 'Category editor',
        tax			=> 'Tax editor',
        shipping	=> 'Shipping editor',
        payment		=> 'Payment editor',
        affiliate	=> 'Affiliates editor',
        itemtype	=> 'Item type editor',
        pagetype	=> 'Page type editor',
        grouptype	=> 'Group type editor',
        matrix		=> 'Matrix editor',
        knar		=> 'Knar editor',
        access		=> 'Administrator Permissions',
        group		=> 'Access Group editor',
        perm		=> 'Permission editor',
        layout		=> 'Layout editor',
	);
	my %extra = qw/userdb 1 order 1/;
	my $current = tag_data('__UI_ACCESS_TABLE__', 'yes_functions', $CGI->{user_id});
	my $out = '';
	my @ary = grep /\S/, split /[\s,\0]+/, $current;
	my @some = qw/l v e c d/;
	my @more = qw/a u p/;
	my @all = (@some, @more);
	my %all;
	@all{@some, @more} = (@some, @more);
	$permref = {};
	foreach $one (@ary) {
		$one =~ s/=(.*)//;
		my $sub = $1 || undef;
		my $ref = $permref->{$one} = {};
		my @set;
		if ($sub) {
			@set = grep $all{$_}, split //, $sub;
		}
		else {
			@set = $extra{$one} ? @all : @some;
		}
		for(@set) {
			$ref->{$_} = ' CHECKED';
		}
	}

	my $string = $Tag->uneval( {ref=>$permref} );
#DEBUG
#	$out .= <<EOF;
#<tr>
#<td colspan=6 bgcolor=__UI_C_INTBLOCK__ valign=top>
#$string
#</td>
#EOF

	my $perm;
	my $title;
	while( $perm = shift @permissions) {
		$title = shift @permissions;
		my $ref = $permref->{$perm} || {};
		$out .= <<EOF;
<tr>
<td bgcolor=__UI_C_INTBLOCK__ valign=top>
<b>$title</b>
<input type=hidden value="$perm=" name="yes_functions">
</td>
EOF
		for(@some) {
			$out .= <<EOF;
<td bgcolor=__UI_C_INTBLOCK__ valign=top>
<INPUT type=checkbox value=$_ name="yes_functions"$ref->{$_}>
</td>
EOF
		}
		$out =~ s!(<.td>\s*)$!<input type=hidden value="," name="yes_functions">$1</tr>!;
	}
	my $ref = $permref->{order};
	$out .= <<EOF;
<tr>
<td colspan=6 bgcolor=__UI_C_TOPBLOCKBAR__><img src="@_UI_IMG_@admin/bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>

</table>
 
<br>

<table __UI_T_PROPERTIES__>

<tr>
<td colspan=2 bgcolor=__UI_C_TOPBLOCKBAR__><img src="@_UI_IMG_@admin/bg.gif" width=600 height=1></td>
</tr>

<tr>
<td bgcolor=__UI_C_INTBLOCK__ valign=top>
<b>Order manager:</b>
<INPUT type=hidden value="order=" name="yes_functions">
<li><INPUT type=checkbox value=l name="yes_functions"$ref->{l}> View list
<li><input type=checkbox value=v name="yes_functions"$ref->{v}> View single
<li><input type=checkbox value=d name="yes_functions"$ref->{d}> Delete
<li><input type=checkbox value=e name="yes_functions"$ref->{e}> Edit
<li><input type=checkbox value=c name="yes_functions"$ref->{c}> Input new
<li><input type=checkbox value=a name="yes_functions"$ref->{a}> Archive
<li><input type=checkbox value=u name="yes_functions"$ref->{u}> Un-archive
<INPUT type=hidden value="," name="yes_functions">
<p>
</td>
<td bgcolor=__UI_C_INTBLOCK__ valign=top ROWSPAN=2>
EOF
	@permissions = (
		orderstats		=> 'Order statistics utility',
		trafficstats	=> 'Traffic statistics utility',
		env_vars		=> 'Environment variables utility',
		stats			=> 'Stats menu',
		techadmin		=> 'Techncal Admin menu',
		sitedesign		=> 'Site Design menu',
		config			=> 'Apply changes',
		dbupload		=> 'Database importer',
		dbdownload		=> 'Database exporter',
		layupload		=> 'Layout importer',
		laydownload		=> 'Layout exporter',
		gensql			=> 'Direct SQL utility',
	);
	while($perm = shift @permissions ) {
		$title = shift @permissions;
		my $on = defined $permref->{$perm} ? ' CHECKED' : '';
		$out .= <<EOF;
<li><INPUT type=checkbox value="$perm," name="yes_functions"$on> <b>$title</b>
EOF
	}
	$ref = $permref->{userdb};
	$out .= <<EOF;
<p>
</td>
</tr>

<tr>
<td bgcolor=__UI_C_INTBLOCK__ valign=top>
<b>Administrator Permissions:</b>
<INPUT type=hidden value="userdb=" name="yes_functions">
<li><INPUT type=checkbox value=l name="yes_functions"$ref->{l}> View list
<li><input type=checkbox value=v name="yes_functions"$ref->{v}> View single
<li><input type=checkbox value=d name="yes_functions"$ref->{d}> Delete
<li><input type=checkbox value=e name="yes_functions"$ref->{e}> Edit
<li><input type=checkbox value=c name="yes_functions"$ref->{c}> Input new
<li><input type=checkbox value=p name="yes_functions"$ref->{p}> Mail password
<INPUT type=hidden value="," name="yes_functions">
<p>
</td>
</tr>
EOF
	return $out;
[/perl]

<tr>
<td colspan=2 bgcolor=__UI_C_TOPBLOCKBAR__><img src="@_UI_IMG_@admin/bg.gif" width=600 height=1></td>
</tr>

</table>

<p>

<table cellpadding=3 cellspacing=0 width=100%>

<tr>
<td colspan=8 bgcolor=__UI_C_TOPBLOCKBAR__><img src="@_UI_IMG_@admin/bg.gif" width=600 height=1></td>
</tr>

<tr>
<td colspan=8 bgcolor=__UI_C_INTBLOCK__ ALIGN=center><B>Table Permissions</B></td>
</tr>

<tr>
<td colspan=8 bgcolor=__UI_C_TOPBLOCKBAR__><img src="@_UI_IMG_@admin/bg.gif" width=600 height=1></td>
</tr>

<tr>
<td bgcolor=__UI_C_INTBLOCK__ valign=top>&nbsp;</td>
<td bgcolor=__UI_C_INTBLOCK__ valign=top>HIDE</td>
<td bgcolor=__UI_C_INTBLOCK__ valign=top>View</td>
<td bgcolor=__UI_C_INTBLOCK__ valign=top>Edit</td>
<td bgcolor=__UI_C_INTBLOCK__ valign=top>Create</td>
<td bgcolor=__UI_C_INTBLOCK__ valign=top>Delete</td>
<td bgcolor=__UI_C_INTBLOCK__ valign=top>Import</td>
<td bgcolor=__UI_C_INTBLOCK__ valign=top>Export</td>
</tr>


[perl]

	my $current = tag_data('__UI_ACCESS_TABLE__', 'yes_tables', $CGI->{user_id})
					|| $Scratch->{tables};
	$current =~ s/\s+/ /g;
	my $no = tag_data('__UI_ACCESS_TABLE__', 'no_tables', $CGI->{user_id});
	$no =~ s/\s+/ /g;
	#Log("no = $no");
	my (@no) = split /\s+/, $no;
	my %no;
	for(@no) { $no{$_} = ' CHECKED' }

	my $out = '';
	my @ary = split /[\s,\0]+/, $current;

	#Log("ary = " . join ",", @ary);
	#Log("no = " . join ",", @no);
	my (@all) = qw/v e c d i x/;
	my %all;
	@all{@all} = @all;
	my $permref = {};

	my $one;

	foreach $one (@ary) {
		$one =~ s/=(.*)//;
		my $sub = $1 || undef;
		next if $no{$one};
		my $ref = $permref->{$one} = {};
		my @set;
		if ($sub) {
			@set = grep $all{$_}, split //, $sub;
		}
		else {
			@set = (@all);
		}
		for(@set) {
			$ref->{$_} = ' CHECKED';
		}
	}

	#my $string = "all=@all ". $Tag->uneval( { ref=> $permref } );

	my @tables = split /\s+/, $Scratch->{tables};

	for(@tables) {
		push @permissions, $_, tag_data('__UI_META_TABLE__', 'label', $_) || $_;
	}

	my $perm;
	my $title;
	while( $perm = shift @permissions) {
		$title = shift @permissions;
		my $ref = $permref->{$perm} || {};
		$out .= <<EOF;
<tr>
<td bgcolor=__UI_C_INTBLOCK__ valign=top>
<b>$title</b>
<input type=hidden value="$perm=" name="yes_tables">
</td>
<td bgcolor=__UI_C_INTBLOCK__ valign=top>
<INPUT type=checkbox value="$perm" name="no_tables"$no{$perm}>
</td>
EOF
		for(@all) {
			$out .= <<EOF;
<td bgcolor=__UI_C_INTBLOCK__ valign=top>
<INPUT type=checkbox value=$_ name="yes_tables"$ref->{$_}>
</td>
EOF
		}
		$out =~ s!(<.td>\s*)$!<input type=hidden value="," name="yes_tables">$1</tr>!;
	}
	#$Scratch->{string} = $string;
	return $out;
	[/perl]

<tr>
<td colspan=8 bgcolor=__UI_C_TOPBLOCKBAR__><img src="@_UI_IMG_@admin/bg.gif" width=600 height=1></td>
</tr>

</table>

<input type=submit value="Ok">

[button text="Cancel"]
mv_todo=back
mv_nextpage=[either][value-extended name=ui_return_to index=0][or]__UI_BASE__/access[/either]
mv_data_table=[cgi mv_data_table]
[/button]

<BR>

</form>
@_UI_STD_FOOTER_@

<!-- page: @@MV_PAGE@@ -->
