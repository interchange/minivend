[set page_title]Direct SQL Query[/set]
[set ui_class]Admin[/set]
[set page_banner]Direct SQL Query[/set]
[set page_perm]super[/set]
[set help_name]table.direct_sql[/set]
[set icon_name]icon_config.gif[/set]
[seti ui_body_extra][/seti]

@_UI_STD_HEAD_@
<!-- ----- BEGIN REAL STUFF ----- -->

[calc]
	delete $CGI->{list};
	delete $CGI->{html};
	$Scratch->{message} = '';
	delete $Scratch->{update_message};
	if ($CGI->{clear_query_buffer}) {
		delete $Session->{x_query_buffer};
		return;
	}
	unless ($sql = $CGI->{sql}) {
		$CGI->{sql} = "select * from $CGI->{mv_data_table}"
			if $CGI->{mv_data_table};
		return;
	}
	my $extra = '';
	$sql =~ s/^\s+//;
	$sql =~ s/\s+$//;
	if($sql =~ /^select\s+.*?\s+from\s+(\w+)/i) {
		$CGI->{mv_data_table} = $1;
		delete $CGI->{rc};
		delete $CGI->{list};
		$CGI->{html} = 1;
#		$Scratch->{message} = qq{
#			Rows selected by query:
#				<blockquote><b>$sql</b></blockquote>
#		};
	}
	else {
		if($sql =~ /^update\s+(\w+)/i) {
			$Scratch->{update_message} = 'UPDATED';
		}
		elsif($sql =~ /^delete\s+from\s+(\w+)/i) {
			$Scratch->{update_message} = 'DELETED';
		}
		elsif($sql =~ /^insert\s+into\s+(\w+)/i) {
			$Scratch->{update_message} = 'INSERTED';
		}
		else {
			$Scratch->{update_message} = 'UNKNOWN OPERATION';
		}
		my $flagtab = $1;
		if($Scratch->{is_super}) {
			$Tag->flag( { type => 'write', table => $flagtab });
		}
		else {
			$extra = "(May fail on write-controlled table, not admin superuser)";
		}
		$CGI->{rc} = 1;
		delete $CGI->{html};
		$CGI->{list} = 1;
#		$Scratch->{message} = qq{
#				Rows updated by query:
#				<blockquote><b>$sql</b></blockquote>
#		};
	}
	$Scratch->{message} =~ s/\r?\n/<br>/g;
	$Scratch->{message} =~ s/\r/<br>/g;
	$Scratch->{message} =~ s/<br>/<br>\n/g;
	$Scratch->{message} .= $extra;

	my $qb = $Session->{x_query_buffer} ||= [];
	my $prev = $qb->[0] ? $qb->[0][0] : '';
	unshift @$qb, [$sql] unless $sql eq $prev;
	return;
[/calc]

[if cgi mv_data_table]
[page 
	href=__UI_BASE__/flex_select
	form=auto
	mv_data_table="[cgi mv_data_table]"
]Return to [cgi mv_data_table] edit</a>
[/if]

<FORM ACTION="[area @@MV_PAGE@@]" name=query>

<table>
<tr>
<td>
<textarea name=sql rows=4 cols=80>[cgi sql]</textarea>
</td>
<td style="font-size: smaller">
[loop list=`
		my $tmp = $Session->{x_query_buffer};
		return [$tmp] if $tmp;
		return;
	` ml=10]
[list]
[loop-increment] <A HREF="javascript: document.query.sql.value='[loop-calc]
		my $thing = <<'EOF';
[loop-code]
EOF
		$thing =~ s/'/\\'/g;
		return $thing;[/loop-calc]'; void(0)">[loop-code]</A><br>
[/list]
[/loop]
</td>
<tr>
<td>
<input type=submit>
<select name=limit>
[loop list="250 10 25 50 100 500 1000 10000 50000" option=limit cgi=1]
	<OPTION value="[loop-code]"> Limit to [loop-code]
[/loop]
</select>
Base table <select name=mv_data_table>
[loop list="[list-databases]" option=mv_data_table cgi=1]
	<OPTION>[loop-code]
[/loop]
</select>
</td>
<td>
<input style="font-size: smaller"
		type=submit
		name=clear_query_buffer
		value="Clear buffer">
</td>
</form>
<P>
	<blockquote>
	[scratchd message]
	</blockquote>
	<table border=1>
[if cgi html]
	[query
		table="[cgi mv_data_table]"
		st=db
		row-count="[cgi row-count]"
		html="[cgi html]" 
		list="[cgi list]" 
		sql=`$sql`
		ml="[cgi limit]"
	]
	[/query]
[elsif cgi list]
	[query
		table="[cgi mv_data_table]"
		row-count="[cgi row-count]"
		st=db
		html="[cgi html]" 
		list="[cgi list]" 
		ml="[cgi limit]"
		sql=`$sql`
	]
	<tr>
	<td>[scratchd update_message]</td>
	<td>[sql-code]</td>
	</tr>
	[/query]
[/elsif]
[/if]
	</table>

<!-- ----- END REAL STUFF ----- -->
@_UI_STD_FOOTER_@
<!-- page: @@MV_PAGE@@ -->






