[if-mm !tables]
[set ui_error]Not authorized for table.[/set]
[bounce href="[area __UI_BASE__/error]"]
[/if-mm]
[if !advanced report]
[bounce page="__UI_BASE__/error"]
[value name=saved_report set=""]
[/if]

[if cgi mv_data_table]
[value name=saved_search set=""]
[/if]

[seti page_title]Search builder[/seti]
[set help_name]search_builder[/set]
[set icon_name]admin/icon_config.gif[/set]
[seti name=tables][list-databases][/seti]
[seti meta_header]
[perl table="[scratch tables]"]

	my @tables = split /\s+/, $Scratch->{tables};
	my $out;
	for(@tables) {
		$tables{$_} = [ $Db{$_}->columns() ];
	}
	$out = "<SCRIPT LANGUAGE=JAVASCRIPT>\n<!-- \n";

	my (@wanted) = qw/
						num_columns
						search_name
						search_table
						search_template
						unique_only
						allow_regex	
						matchlimit
						/;
	my (%wantmap) = qw/
						search_table		fi
						allow_regex		    ac
						search_template		sp
						unique_only			un
						matchlimit			ml
						/;

	my %want_invert = qw/ ac 1 /;
	@wantmap{values %wantmap} = keys %wantmap;

	my $saved = $Values->{saved_search} || {};
	my @lines;
	if($CGI->{ui_searchblob} ) {
		$saved = {};
		@lines = grep /\S/, split /\n/, $CGI->{ui_searchblob};
		@lines = map { s/^\s+//; s/\s+$//; $_ } @lines;
		for(@lines) {
Log("processing searchblob line $_");
			my($k, $v) = split /\s*=\s*/, $_, 2;
			my $keyname;
			if ($keyname = delete($wantmap{$k}) ) {
				$v = ! $v if $want_invert{$k};
				$saved->{$keyname} = $v;
			}
			else {
				push @rescan, [$k, $v];
			}
		}
	}
	else {
		$saved = $Values->{saved_search};
	}

	my %remap = (
					qw/
					fi  search_table
					sf  search_field
					op  search_op
					se  search_spec
					cs  case_sensitive
					bs  begin_string
					su  substring
					nu  numeric
					tf  sort_order
					rf  return
					to  sort_option
					/
	);
	my %count_rescan;
	my $r;
	foreach $r (@rescan) {
		my $keyname = $remap{$r->[0]} . ($count_rescan{$r->[0]}++ || 0);
		if($r->[0] eq 'sf') {
			my ($kn, $tab);
			if( $r->[1] =~ s/(\w+)://) {
				$tab = $1;
				$kn = $keyname;
				$kn =~ s/search_field/search_table/;
				$saved->{$kn} = $tab;
			}
			else {
				my $kn = $keyname;
				$kn =~ s/search_field/search_table/;
				$saved->{$kn} = $saved->{search_table};
			}
		}
		if($r->[0] eq 'sf' and $r->[1] =~ s/(\w+)://) {
			my $tab = $1;
			my $kn = $keyname;
			$kn =~ s/search_field/search_table/;
			$saved->{$remap{$kn}} = $tab;
		}
Log("processing searchblob rescan $keyname = $r->[1]");
		$saved->{$keyname} = $r->[1];
	}

Log($Tag->uneval( { ref => $saved } ));
	if(ref $saved) {
		for (@wanted) {
			delete $Values->{$_};
			$Values->{$_} = $saved->{$_}
				if defined $saved->{$_}; 
		}
		$Values->{mv_data_table} =
			$CGI->{mv_data_table} =
				$saved->{search_table}
			if $saved->{search_table};
				
		$max_columns = $saved->{num_columns} || 5;
	}
	else {
		$Values->{mv_data_table} = $CGI->{mv_data_table} || $Config->{ProductFiles}[0];
		$saved = {};
		$max_columns = 2;
	}

	foreach my $tab (sort keys %tables) {
		my $cols = $tables{$tab};
		my $row = (qq{ var ary_$tab = new Array ("('-- default(key) --', '', true,true)","('All columns', '*', true,true)",});
		for(@$cols) {
			$row .= qq{"('$_')",\n};
		}
		$row =~ s/,$/);/;
		$out .= $row;
		if ($tab eq $Values->{mv_data_table}) {
			$Scratch->{selected_table_options} =
			   join '<OPTION>', '', @$cols;
			$Scratch->{selected_table_columns} =
			   join "\n", @$cols;
			$Scratch->{default_key} = $Db{$tab}->config('KEY');
		}
	}
	$Scratch->{column_nums} = join " ", 0 .. $max_columns;
	my @incs = qw/ search_table
					search_field
					search_op
					search_spec
					case_sensitive
					begin_string
					substring
					numeric
					sort_order
					sort_option
					return
				/;

	for(my $i = 0; $i <= $max_columns ; $i++) {

		for (@incs) { delete $Values->{"$_$i"}; }

		next if ! $saved;

		for( @incs ) { $Values->{"$_$i"} = $saved->{"$_$i"}; }
	}
	$out .= <<EOF;

function populate(table_options,selected) {
	var foundKey = false;
	for (var i=0; i < table_options.length; i++) {
		if (table_options[i].text == selected) {
			table_options[i].selected = true;
			foundKey = true;
		}
		else {
			table_options[i].selected = false;
		}
	}
	if(foundKey == false) {
		table_options[0].selected = true;
	}
	return true;
}

function populateTable(table_options,column_options,selected) {
	var selectedArray = eval ( "ary_" + selected );
	var currentTable = "$Values->{mv_data_table}";
	var currentArray = eval ( "ary_" + currentTable );
	while (selectedArray.length < column_options.length) {
		column_options[(column_options.length - 1)] = null;
	}
	for (var i=0; i < selectedArray.length; i++) {
		eval("column_options[i]=" + "new Option" + selectedArray[i]);
	}
	if (table_options[0].value == '') {
		table_options[0]= null;
    }
   return true;
}
// End -->
</SCRIPT>
EOF
[/perl]
[/seti]

[calc] $Config->{NoSearch} = ''; [/calc]

@_UI_STD_HEAD_@

[seti table_list]
	[loop prefix=table list="[scratch tables]" option=search_table]
	<OPTION VALUE="[table-code]">[table-code]</OPTION>
	[/loop]
[/seti]

<P>
<table __UI_T_PROPERTIES__>
<tr>
<td colspan=2 bgcolor=__UI_C_TOPBLOCKBAR__><img src="admin/cleardot.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>

<tr>
<td colspan=2 bgcolor=__UI_C_INTBLOCK__>
<FORM NAME=report ACTION="[area __UI_BASE__/search_builder_results]" METHOD=POST>
<INPUT TYPE=hidden NAME=cat          VALUE="[cgi cat]"         >
<INPUT TYPE=hidden NAME=ui_return_to VALUE="[cgi ui_return_to]">
<INPUT TYPE=hidden NAME=ui_target    VALUE="[cgi ui_target]"   >
<INPUT TYPE=submit VALUE=Run>
[if-mm advanced mml]
<INPUT TYPE=submit NAME=generate_page VALUE="Generate definition">
[/if-mm]</td>
</tr>

<tr>
<td colspan=2 bgcolor=__UI_C_TOPBLOCKBAR__><img src="admin/cleardot.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>

<TR>
	<TD BGCOLOR="__UI_C_INTBLOCK__" WIDTH=20%>
		<B>Search Info</B>
	</TD>
	<TD BGCOLOR="__UI_C_INTBLOCK__">
	<TABLE>
	<TR>
		<TH>Base table</TD>
		<TH>Template</TD>
		<TH>Page Size</TD>
		<TH>Unique only?</TD>
		<TH>Allow regex</TD>
	</TR>
	<TR>
		<TD>
	<SELECT NAME=search_table onChange="
		[loop list="[scratch column_nums]"]
		populate( this.form.search_table[loop-code].options,
			this.form.search_table.options[this.form.search_table.selectedIndex].value
		);
		populateTable(
			this.form.search_table.options,
			this.form.return[loop-code].options,
			this.form.search_table.options[this.form.search_table.selectedIndex].value
		);
		[/loop]
		">
	[scratch table_list]
	</SELECT>
		</TD>
		<TD>
	<select NAME="search_template">
		<option value=""> --default ([calc] $Config->{Special}{results} [/calc]) --
		[loop option=search_template list="[list-pages]"]
			<option>[loop-code]
		[/loop]
	</select>
		</TD>
		<TD>
	<SELECT NAME="matchlimit">
		[loop list="50 1 2 3 5 10 20 25 50 100 9999" option=matchlimit]<OPTION>[loop-code][/loop]
	</SELECT>
		</TD>
		<TD>
	<SELECT NAME="unique_results">
		<OPTION VALUE="">No
		<OPTION VALUE="1" [selected unique_results 1]>Yes
	</SELECT>
		</TD>
		<TD>
	<SELECT NAME="allow_regex">
		<OPTION VALUE="">No
		<OPTION VALUE="1" [selected allow_regex 1]>Yes
	</SELECT>
		</TD>
	</TR>
	</TABLE>
</TR>

<tr>
<td colspan=2 bgcolor=__UI_C_TOPBLOCKBAR__><img src="admin/cleardot.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>

[loop list="[scratch column_nums]"]
<TR>
	<TD BGCOLOR="__UI_C_INTBLOCK__" WIDTH=20%>
		<B>Search filter</B>
		[loop-change 1][condition]only[/condition]
		<BR>
		<SMALL><SMALL><I>First must be in base table.<BR>Faster performance if "equal to" for SQL tables.<BR>Faster performance if "regular expression match " for text searches.<BR></I></SMALL></SMALL>
		[/loop-change 1]
	</TD>
	<TD BGCOLOR="__UI_C_INTBLOCK__">
	<FONT SIZE="-1">
	<SELECT NAME="search_table[loop-code]" onChange="populateTable(
			this.form.search_table[loop-code].options,
			this.form.search_field[loop-code].options,
			this.form.search_table[loop-code].options[this.form.search_table[loop-code].selectedIndex].value
			)">
	[value search_table[loop-code]]
	[scratch table_list]
	</SELECT>
	<SELECT NAME="search_field[loop-code]">
	<OPTION VALUE="[value search_field[loop-code]]">[value name=search_field[loop-code] default="--"]
	<OPTION VALUE="">--none--
	[scratch selected_table_options]
	</SELECT>
	<FONT SIZE=1>
	<SELECT NAME="search_op[loop-code]">
	[loop prefix=op list="eq	equal to
ne	not equal to
rm	Regular expression match
rn	Regular expression negate
gt	Greater than
ge	Greater than or equal
lt	Less than
le	Less than or equal
>	Greater than (numeric)
>=	Greater than or equal (numeric)
<	Less than (numeric)
<=	Less than or equal (numeric)
"    lr=1 option=search_op[loop-code] ]<OPTION VALUE="[op-code]">[op-pos 1]</OPTION>
	[/loop]
	</SELECT></FONT>&nbsp;<INPUT NAME="search_spec[loop-code]" VALUE="[value search_spec[loop-code]]"><BR>
	<SELECT NAME=case_sensitive[loop-code]>
	<OPTION VALUE="">Not case-sensitive
	<OPTION VALUE=1 [selected case_sensitive[loop-code] 1]>Yes, case-sensitive
	</SELECT>
	<SELECT NAME=substring[loop-code]>
	<OPTION VALUE="">Match words
	<OPTION VALUE=1 [selected substring[loop-code] 1]>Match partial
	</SELECT>
	<SELECT NAME=begin_string[loop-code]>
	<OPTION VALUE="">Match anywhere in field
	<OPTION VALUE=1 [selected begin_string[loop-code] 1]>Match beginning
	</SELECT>
</TR>
[/loop]

<tr>
<td colspan=2 bgcolor=__UI_C_TOPBLOCKBAR__><img src="admin/cleardot.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>


[loop list="[scratch column_nums]"]
<TR>
	<TD BGCOLOR="__UI_C_INTBLOCK__" WIDTH=20%>
		<B>Sort order [loop-increment]</B>
	</TD>
	<TD BGCOLOR="__UI_C_INTBLOCK__">
	<SELECT NAME="sort_order[loop-code]">
	<OPTION VALUE="[value sort_order[loop-code]]">[value name=sort_order[loop-code] default="--"]
	<OPTION VALUE="">--none--
	[scratch selected_table_options]
	</SELECT>
	<SELECT NAME="sort_option[loop-code]">
	<OPTION VALUE="x"> Normal
	<OPTION VALUE="n" [selected sort_option[loop-code] n]> Numeric
	<OPTION VALUE="r" [selected sort_option[loop-code] r]> Reverse
	<OPTION VALUE="f" [selected sort_option[loop-code] f]> Case-insensitive
	<OPTION VALUE="nr" [selected sort_option[loop-code] nr]> Reverse numeric
	<OPTION VALUE="fr" [selected sort_option[loop-code] fr]> Reverse case-insensitive
	</SELECT>
	Break:
	[if value break[loop-code]]
	<INPUT TYPE=radio NAME="break[loop-code]" VALUE=""> no
	<INPUT TYPE=radio NAME="break[loop-code]" VALUE=1 CHECKED> yes
	[else]
	<INPUT TYPE=radio NAME="break[loop-code]" VALUE="" CHECKED> no
	<INPUT TYPE=radio NAME="break[loop-code]" VALUE=1> yes
	[/else]
	[/if]

	</TD>
</TR>
[/loop]

<tr>
<td colspan=2 bgcolor=__UI_C_TOPBLOCKBAR__><img src="admin/cleardot.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>

<TR>
	<TD BGCOLOR="__UI_C_INTBLOCK__" WIDTH=20% VALIGN=TOP>
		<B>Column return</B><BR>
	</TD>
	<TD BGCOLOR="__UI_C_INTBLOCK__" ALIGN=LEFT>
	<FONT SIZE="-1">
	[loop list="[scratch column_nums]"]
	<SELECT NAME="return[loop-code]">
	<OPTION VALUE="[value return[loop-code]]">[value name=return[loop-code] default="--"]
	<OPTION VALUE="">--default (key)--
	[scratch selected_table_options]
	</SELECT>
	[/loop]
	</TD>
</TR>

<tr>
<td colspan=2 bgcolor=__UI_C_INTBLOCK__>
<INPUT TYPE=submit VALUE=Run>
[if-mm advanced mml]
<INPUT TYPE=submit NAME=generate_page VALUE="Generate definition">
[/if-mm]</td>
</tr>

</TABLE>

</FORM>

@_UI_STD_FOOTER_@
