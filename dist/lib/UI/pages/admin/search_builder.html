[if-mm !tables]
[set ui_error]Not authorized for table.[/set]
[bounce href="[area __UI_BASE__/error]"]
[/if-mm]
[if !advanced report]
[bounce page="__UI_BASE__/error"]
[value name=saved_report set=""]
[/if]

[if cgi mv_data_table]
[value name=saved_search set=""]
[/if]

[seti page_title]Search builder[/seti]
[set help_name]report[/set]
[set icon_name]admin/icon_config.gif[/set]
[seti name=tables][list-databases][/seti]
[seti meta_header]
[perl table="[scratch tables]"]

	my @tables = split /\s+/, $Scratch->{tables};
	my $out;
	for(@tables) {
		$tables{$_} = [ $Db{$_}->columns() ];
	}
	$out = "<SCRIPT LANGUAGE=JAVASCRIPT>\n<!-- \n";

	my $saved = $Values->{saved_search};
	my (@wanted) = qw/
						num_columns
						search_name
						search_table
						search_template
						unique_only
						matchlimit
						/;
	if(ref $saved) {
		for (@wanted) {
			delete $Values->{$_};
			$Values->{$_} = $saved->{$_}
				if defined $saved->{$_}; 
		}
		$Values->{mv_data_table} =
			$CGI->{mv_data_table} =
				$saved->{search_table}
			if $saved->{search_table};
				
		$max_columns = $saved->{num_columns} || 5;
	}
	else {
		$Values->{mv_data_table} = $CGI->{mv_data_table} || $Config->{ProductFiles}[0];
		$saved = {};
		$max_columns = 2;
	}

	foreach my $tab (sort keys %tables) {
		my $cols = $tables{$tab};
		my $row = (qq{ var ary_$tab = new Array ("('-- default(key) --', '', true,true)","('All columns', '*', true,true)",});
		for(@$cols) {
			$row .= qq{"('$_')",\n};
		}
		$row =~ s/,$/);/;
		$out .= $row;
		if ($tab eq $Values->{mv_data_table}) {
			$Scratch->{selected_table_options} =
			   join '<OPTION>', '', @$cols;
			$Scratch->{selected_table_columns} =
			   join "\n", @$cols;
			$Scratch->{default_key} = $Db{$tab}->config('KEY');
		}
	}
	$Scratch->{column_nums} = join " ", 0 .. $max_columns;
	for(my $i = 0; $i <= $max_columns ; $i++) {

		for (
				qw/ search_table
					search_field
					search_op
					search_spec
					case_sensitive
					begin_string
					substring
					numeric
					sort_order
					sort_option
				/
			)
		{ delete $Values->{"$_$i"}; }

		next if ! $saved;

		for(
			qw/ search_table
				search_field
				search_op
				search_spec
				case_sensitive
				begin_string
				substring
				numeric
				sort_order
				sort_option
			/
			)
		{ $Values->{"$_$i"} = $saved->{"$_$i"}; }
		my $tab = $saved->{"search_table0"}
		            or next;
		$Values->{"return$i"}  .= "<OPTION SELECTED VALUE='$tab'>$tab</OPTION>";
	}
	$out .= <<EOF;

function populate(table_options,selected) {
	var foundKey = false;
	for (var i=0; i < table_options.length; i++) {
		if (table_options[i].text == selected) {
			table_options[i].selected = true;
			foundKey = true;
		}
		else {
			table_options[i].selected = false;
		}
	}
	if(foundKey == false) {
		table_options[0].selected = true;
	}
	return true;
}

function populateTable(table_options,column_options,selected) {
	var selectedArray = eval ( "ary_" + selected );
	var currentTable = "$Values->{mv_data_table}";
	var currentArray = eval ( "ary_" + currentTable );
	while (selectedArray.length < column_options.length) {
		column_options[(column_options.length - 1)] = null;
	}
	for (var i=0; i < selectedArray.length; i++) {
		eval("column_options[i]=" + "new Option" + selectedArray[i]);
	}
	if (table_options[0].value == '') {
		table_options[0]= null;
    }
   return true;
}
// End -->
</SCRIPT>
EOF
[/perl]
[/seti]

[calc] $Config->{NoSearch} = ''; [/calc]

@@UI_STD_HEAD@@

[seti table_list]
	[loop prefix=table list="[scratch tables]" option=search_table]
	<OPTION VALUE="[table-code]">[table-code]</OPTION>
	[/loop]
[/seti]

<P>
<TABLE CELLPADDING=3 CELLSPACING=0>
<tr>
<td colspan=2 bgcolor=__UI_C_TOPBLOCKBAR__><img src="admin/cleardot.gif" width=__UI_OVERALL_WIDTH__ height=1></td>
</tr>

<tr>
<td colspan=2 bgcolor=__UI_C_INTBLOCK__>
<FORM NAME=report ACTION="[area __UI_BASE__/search_builder_results]" METHOD=POST>
<INPUT TYPE=submit VALUE=Run>
[if-mm advanced mml]
<INPUT TYPE=submit NAME=generate_page VALUE="Generate definition">
[/if-mm]</td>
</tr>

<tr>
<td colspan=2 bgcolor=__UI_C_TOPBLOCKBAR__><img src="admin/cleardot.gif" width=__UI_OVERALL_WIDTH__ height=1></td>
</tr>

<TR>
	<TD BGCOLOR="__UI_C_INTBLOCK__" WIDTH=20%>
		<B>Search Info</B>
	</TD>
	<TD BGCOLOR="__UI_C_INTBLOCK__">
	<TABLE>
	<TR>
		<TH>Base table</TD>
		<TH>Template</TD>
		<TH>Page Size</TD>
		<TH>Unique only?</TD>
		<TH>Allow regex</TD>
	</TR>
	<TR>
		<TD>
	<SELECT NAME=search_table onChange="
		[loop list="[scratch column_nums]"]
		populate( this.form.search_table[loop-code].options,
			this.form.search_table.options[this.form.search_table.selectedIndex].value
		);
		populateTable(
			this.form.search_table.options,
			this.form.return[loop-code].options,
			this.form.search_table.options[this.form.search_table.selectedIndex].value
		);
		[/loop]
		">
	[scratch table_list]
	</SELECT>
		</TD>
		<TD>
	<INPUT NAME="search_template" VALUE="[value search_template]">
		</TD>
		<TD>
	<SELECT NAME="matchlimit">
		[loop list="50 1 2 3 5 10 20 25 50 100 9999" option=matchlimit]<OPTION>[loop-code][/loop]
	</SELECT>
		</TD>
		<TD>
	<SELECT NAME="unique_results">
		<OPTION VALUE="">No
		<OPTION VALUE="1" [selected unique_results 1]>Yes
	</SELECT>
		</TD>
		<TD>
	<SELECT NAME="allow_regex">
		<OPTION VALUE="">No
		<OPTION VALUE="1" [selected allow_regex 1]>Yes
	</SELECT>
		</TD>
	</TR>
	</TABLE>
</TR>

<tr>
<td colspan=2 bgcolor=__UI_C_TOPBLOCKBAR__><img src="admin/cleardot.gif" width=__UI_OVERALL_WIDTH__ height=1></td>
</tr>

[loop list="[scratch column_nums]"]
<TR>
	<TD BGCOLOR="__UI_C_INTBLOCK__" WIDTH=20%>
		<B>Search filter</B>
		[loop-change 1][condition]only[/condition]
		<BR>
		<SMALL><SMALL><I>First must be in base table.<BR>Faster performance if "equal to" for SQL tables.<BR>Faster performance if "regular expression match " for text searches.<BR></I></SMALL></SMALL>
		[/loop-change 1]
	</TD>
	<TD BGCOLOR="__UI_C_INTBLOCK__">
	<FONT SIZE="-1">
	<SELECT NAME="search_table[loop-code]" onChange="populateTable(
			this.form.search_table[loop-code].options,
			this.form.search_field[loop-code].options,
			this.form.search_table[loop-code].options[this.form.search_table[loop-code].selectedIndex].value
			)">
	[value search_table[loop-code]]
	[scratch table_list]
	</SELECT>
	<SELECT NAME="search_field[loop-code]">
	<OPTION VALUE="[value search_field[loop-code]]">[value name=search_field[loop-code] default="--"]
	<OPTION VALUE="">--none--
	[scratch selected_table_options]
	</SELECT>
	<FONT SIZE=1>
	<SELECT NAME="search_op[loop-code]">
	[loop prefix=op list="eq	equal to
ne	not equal to
rm	Regular expression match
rn	Regular expression negate
gt	Greater than
ge	Greater than or equal
lt	Less than
le	Less than or equal
>	Greater than (numeric)
>=	Greater than or equal (numeric)
<	Less than (numeric)
<=	Less than or equal (numeric)
"    lr=1 option=search_op[loop-code] ]<OPTION VALUE="[op-code]">[op-pos 1]</OPTION>
	[/loop]
	</SELECT></FONT>&nbsp;<INPUT NAME="search_spec[loop-code]" VALUE="[value search_spec[loop-code]]"><BR>
	<SELECT NAME=case_sensitive[loop-code]>
	<OPTION VALUE="">Not case-sensitive
	<OPTION VALUE=1 [selected case_sensitive[loop-code] 1]>Yes, case-sensitive
	</SELECT>
	<SELECT NAME=substring[loop-code]>
	<OPTION VALUE="">Match words
	<OPTION VALUE=1 [selected substring[loop-code] 1]>Match partial
	</SELECT>
	<SELECT NAME=begin_string[loop-code]>
	<OPTION VALUE="">Match anywhere in field
	<OPTION VALUE=1 [selected begin_string[loop-code] 1]>Match beginning
	</SELECT>
</TR>
[/loop]

<tr>
<td colspan=2 bgcolor=__UI_C_TOPBLOCKBAR__><img src="admin/cleardot.gif" width=__UI_OVERALL_WIDTH__ height=1></td>
</tr>


[loop list="[scratch column_nums]"]
<TR>
	<TD BGCOLOR="__UI_C_INTBLOCK__" WIDTH=20%>
		<B>Sort order [loop-increment]</B>
	</TD>
	<TD BGCOLOR="__UI_C_INTBLOCK__">
	<SELECT NAME="sort_order[loop-code]">
	<OPTION VALUE="[value sort_order[loop-code]]">[value name=sort_order[loop-code] default="--"]
	<OPTION VALUE="">--none--
	[scratch selected_table_options]
	</SELECT>
	<SELECT NAME="sort_option[loop-code]">
	<OPTION VALUE="x"> Normal
	<OPTION VALUE="n" [selected sort_option[loop-code] n]> Numeric
	<OPTION VALUE="r" [selected sort_option[loop-code] r]> Reverse
	<OPTION VALUE="f" [selected sort_option[loop-code] f]> Case-insensitive
	<OPTION VALUE="nr" [selected sort_option[loop-code] nr]> Reverse numeric
	<OPTION VALUE="fr" [selected sort_option[loop-code] fr]> Reverse case-insensitive
	</SELECT>
	Break:
	[if value break[loop-code]]
	<INPUT TYPE=radio NAME="break[loop-code]" VALUE=""> no
	<INPUT TYPE=radio NAME="break[loop-code]" VALUE=1 CHECKED> yes
	[else]
	<INPUT TYPE=radio NAME="break[loop-code]" VALUE="" CHECKED> no
	<INPUT TYPE=radio NAME="break[loop-code]" VALUE=1> yes
	[/else]
	[/if]

	</TD>
</TR>
[/loop]

<tr>
<td colspan=2 bgcolor=__UI_C_TOPBLOCKBAR__><img src="admin/cleardot.gif" width=__UI_OVERALL_WIDTH__ height=1></td>
</tr>

<TR>
	<TD BGCOLOR="__UI_C_INTBLOCK__" WIDTH=20% VALIGN=TOP>
		<B>Column return</B><BR>
	</TD>
	<TD BGCOLOR="__UI_C_INTBLOCK__" ALIGN=LEFT>
	<FONT SIZE="-1">
	[loop list="[scratch column_nums]"]
	<SELECT NAME="return[loop-code]">
	<OPTION VALUE="[value return[loop-code]]">[value name=return[loop-code] default="--"]
	<OPTION VALUE="">--default (key)--
	[scratch selected_table_options]
	</SELECT>
	[/loop]
	</TD>
</TR>

<tr>
<td colspan=2 bgcolor=__UI_C_INTBLOCK__>
<INPUT TYPE=submit VALUE=Run>
[if-mm advanced mml]
<INPUT TYPE=submit NAME=generate_page VALUE="Generate definition">
[/if-mm]</td>
</tr>

</TABLE>

</FORM>

@@UI_STD_FOOTER@@
