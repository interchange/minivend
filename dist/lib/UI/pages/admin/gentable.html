[set page_perm]gentable[/set]
[set page_title][L]Table Manager[/L][/set]
[set ui_class]Admin[/set]
[set help_name]gentable[/set]
[set icon_name]icon_config.gif[/set]
@_UI_STD_HEAD_@

<!-- ----- BEGIN REAL STUFF ----- -->

<!-- touch metatable [data __UI_META_TABLE__ test test] -->
<table cellpadding=2 cellspacing=0 width="60%">
[loop list="[list-databases]"]
[loop-sub db_action]

sub {
#Log("args=" . $Tag->uneval({ ref => \@_ }));
	my $name = shift;
	return if $admin{$name};
	my $rec = shift;
	my $tab = $rec->[0];
	if(! $admin_done++) {
		# Set up hidden tables
		%admin = map { ($_, 1) } split /[\s.\0]+/, $Variable->{UI_ADMIN_TABLES};
		# To build the links to hidden tables
		$Scratch->{ui_tmp_admin} = join " ", sort keys %admin;
	}

	return '' if $admin{$tab};

#Log("name=$name tab=$tab");
	$name = $tab if ! $name;
	my $url = "$Config->{VendURL}/__UI_BASE__";
	my $froot = sub {
		my $fn = shift;
		$fn =~ s#^$Config->{VendRoot}/##o;
		return $fn;
	};
	my $ref = {
		upload => { 
						img => 'up.gif',
						url => $Tag->area(
									'__UI_BASE__/upload_file',
									$froot->(join "/",
											($Config->{Database}{$tab}{dir} || $Config->{ProductDir}),
											$Config->{Database}{$tab}{file}
										),
									{
										form => 'ui_return_to=@@MV_PAGE@@'
									}
								),
									
					},
		download => { 
						img => 'down.gif',
						url => $Tag->area( 
									{
										href => 'ui_download/' .
										  $froot->(
										  	join "/",
												(	$Config->{Database}{$tab}{dir}
													||
													$Config->{ProductDir}
												),
												$Config->{Database}{$tab}{file}
											 ),
										 form => 'filler=1',
									},
								),
					},
		import => { 
						img => 'left.gif',
						url => $Tag->area(
									{
										href => '__UI_BASE__/import_table',
										form => "mv_data_table=$tab",
									}
									),
					},
		export => { 
						img => 'right.gif',
						url => $Tag->area(
									{
										href => '__UI_BASE__/export_table',
										form => "mv_data_table=$tab",
									}
									),
					},
		config => { 
						img => 'icon_config.gif',
						url => $Tag->area(
									{
										href => '__UI_BASE__/dbconfig',
										form => "mv_data_table=$tab",
									}
									),
					},
		edit => { 
						img => 'layout.gif',
						url => $Tag->area(
									{
										href => '__UI_BASE__/flex_select',
										form => "mv_data_table=$tab",
									}
									),
					},
	};
	my $out = '';
	my @litems = (
				'[L]edit[/L]',
				'[L]import[/L]',
				'[L]export[/L]',
				'[L]upload[/L]',
				'[L]download[/L]',
			);
	push @litems, '[L]config[/L]' if $Variable->{UI_DBCONFIG};
	push @litems, '[L]Table name[/L] ([L]description[/L])';
	
	if(! $dblist_done_one++) {
		$out .= '<tr>';
		my $i = 0;
		for(@litems) {  # Add "report"
			my $align = $i++ == $#litems ? 'left' : 'center';
			$out .= qq{<td class=rmarq align=$align>$_</td>};
		}
		$out .= "</tr>";
	}
	$out .= '<tr class=rnorm>';

	my @mitems = (qw/edit import export upload download/);
	if($Variable->{UI_DBCONFIG}) {
		push @mitems, 'config';
	}

	for(@mitems) {  # Add "report"
		my $line = $ref->{$_};
		$out .= <<EOF;
<td ALIGN=center><A HREF="$line->{url}"><img src="$line->{img}" border=0 alt="$_ $tab" title="$_ $tab" align=top></A></td>
EOF
	}
	$out .= qq{<td>&nbsp;<FONT SIZE="+1">$name</FONT>};
	my $desc = tag_data('__UI_META_TABLE__', 'name', $name);
	$out .= qq{ ($desc)} if $desc;
	$out .= q{</td></tr>};
	return $out;
}
[/loop-sub]
[loop-exec db_action][loop-data __UI_META_TABLE__ label][/loop-exec]
[/loop]
<tr class=rborder>
	<td colspan=6><img src="bg.gif" height=1></td>
</tr>
</table>

[if-mm super]
<blockquote>
	[L]Hidden admin tables[/L]:
<blockquote>
	[calc]
		return
			join ', ',
			map {
				$Tag->page( {
					href => '__UI_BASE__/flex_select',
					form => "mv_data_table=$_",
				} ) .
				$_ .
				'</a>'
			} split / /, $Scratch->{ui_tmp_admin}
		;
	[/calc]
</blockquote>
</blockquote>
[/if-mm]


<!-- ----- END REAL STUFF ----- -->

@_UI_STD_FOOTER_@
<!-- page: @@MV_PAGE@@ -->
