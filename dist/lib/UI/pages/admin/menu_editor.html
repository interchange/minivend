[if cgi junksubmit]
[or cgi cancelsubmit]
Hit action for no-content
[tag op=header]Status: 204 No content[/tag]
[goto]
[/if]

[set page_title]Menu construction[/set]
[tmpn dhtml_required]1[/tmpn]
[set ui_class]Design[/set]
[set page_banner]Menu constructor: Make a quick menu[/set]
[set page_perm]layout=e[/set]
[set help_name]layout.edit[/set]
[set icon_name]icon_pages.gif[/set]
[seti ui_body_extra][/seti]

@_UI_STD_HEAD_@
<!-- ----- BEGIN REAL STUFF ----- -->

[loop list="tree __MV_TREE_TABLE__"]
[flag type=write table="[loop-code]"]
[/loop]

[seti medit_tables]
__MV_TREE_TABLE__
__ProductFiles_0__
tree
cat
area
[cgi qmenu_products]
__UI_META_TABLE__
[/seti]

[perl tables="[scratch medit_tables]"]
	my $menupath = $Variable->{MV_MENU_DIRECTORY} || 'include/menus';
	@menufields = qw/
        code mgroup msort next_line indicator exclude_on depends_on page
        form name super inactive description help_name img_dn img_up
        img_sel img_icon url member
	/;

	$Tag->tmp('qmenu_fdata');
	$Tag->tmp('qmenu_data');
	%menuinit = (
				code => 0,
				inactive => 0,
				msort => "'x'",
				);

	if($CGI->{qmenu_text}) {
		my $menufile;
		my $menuname;
		if($CGI->{qmenu_new} =~ /\S/) {
			$menuname = $CGI->{qmenu_new};
			$menuname =~ s/\s+$//;
			$menuname =~ s/^\s+//;
		}
		else {
			$menuname = $CGI->{qmenu_name};
		}
		$CGI->{qmenu_name} = $menuname;
		if($menuname) {
			$menufile = $Tag->filter('filesafe', "$menupath/$menuname.txt");
			my $text = $CGI->{qmenu_text};
			$text =~ s{\\([\\r])}{
									if   ($1 eq 'r')  { "\r" }
									elsif($1 eq "\\") { "\\" }
									else              { "\\$1" }
								}eg;
			$text =~ s/\r\n/\n/g;
			$Tag->backup_file($menufile) if -f $menufile;
			if($Tag->write_relative_file($menufile, $text) ) {
				$Tag->warnings( errmsg(
									"Menu '%s' saved to file %s. Active on next access.",
									$menuname,
									$menufile,
								));
			}
			else {
				$Tag->error({ name => 'Save menu',
							  set => errmsg(
										"Failed to save menu '%s' to file %s.",
										$Tag->filter('unescape', $menuname),
										$menufile,
									),
								});
			}
			my $tab = $Variable->{MV_TREE_TABLE} || 'tree';
			if($CGI->{qmenu_tree} && $CGI->{qmenu_write_tree} and $Db{$tab}) {
			  TREEWRITE: {
				my $db = $Db{$tab}
					or do {
						$Tag->error({
								set =>  errmsg(
											"%s database %s for tree write: %s",
											'open',
											$tab,
											'non-existent',
										),
								});
						last TREEWRITE;

					};
				my @lines = split /\n/, $text;
				my @fields = split /\t/, shift(@lines);
				my $pfield = $Variable->{MV_TREE_PARENT_FIELD} || 'parent_fld';
				my $gfield = $Variable->{MV_TREE_GROUP_FIELD} || 'mgroup';
				my $sfield = $Variable->{MV_TREE_SORT_FIELD} || 'msort';

				my @valid;
				for(my $i = 0; $i < @fields; $i++) {
					push @valid, $i if defined $db->test_column($fields[$i]);
				}
#Debug("valid entries=" . join(',', @valid));

				@fields = @fields[@valid];

				my $gptr;
				my $sptr;
				for(my $i = 1; $i < @fields; $i++) {
					if($fields[$i] eq $gfield) {
						$gptr = $i;
					}
					elsif($fields[$i] eq $sfield) {
						$sptr = $i;
					}
				}

				my $num = @fields;
				my $last = $num - 1;

				my $pptr = @fields;
				push @fields, $pfield;
				shift(@fields);

				my @parent = ($menuname);
				my $plev = 0;

				my $query = qq{delete from $tab where $gfield = '$menuname'};
				$db->query($query);

				for(@lines) {
					my @row = split /\t/, $_, $num;
					my @f = @fields;
					$#row = $last;
					@row = @row[@valid];
					my $lev = $row[$sptr];
#Debug("menu level=$lev");
					$row[$gptr] = $menuname;
					$row[$pptr] = $parent[$lev];
					splice(@parent, $lev + 1);
					shift(@row);
#Debug("fields to set: " . uneval(\@f));
#Debug("values to set: " . uneval(\@row));
					my $key = $db->set_slice(undef, \@f, \@row);
#Debug("fields to set: " . uneval(\@f));
#Debug("values to set: " . uneval(\@row));
					$parent[$lev + 1] = $key;
				}
				$Tag->warnings( errmsg(
									"Successfully wrote %s lines to tree %s.",
									scalar(@lines),
									$menuname,
								) );
			  }
			}
		}
		else {
			$Tag->error({	name => 'qmenu_name/qmenu_new',
							set => "No menu name to write.",
						});
		}
	}
	elsif ($CGI->{qmenu_products}) {
		PRODBUILD: {
			my $tab = $CGI->{qmenu_products};
			my $db = $Db{$tab}
				or do {
					$Tag->error({ set => errmsg(
										"Failed to open %s table %s.",
										'products',
										$tab,
										),
									});
					last PRODBUILD;
				};
#Debug("LARGE=" . $db->config('LARGE'));
			if(! $CGI->{qmenu_even_large} and $db->config('LARGE')) {
				$Tag->error({ set => errmsg(
										"%s database %s for tree write: %s",
										'check',
										$tab,
										'too large, must override',
									),
								});
				last PRODBUILD;
			}
			my @somefields = qw/mgroup page name description/;
			my $q = qq{
						SELECT sku,prod_group,category,description
						FROM $tab
						ORDER BY prod_group,category,description
						};
			my $ary = $db->query($q)
							or do {
								$Tag->error({
										set => errmsg(
											"No results from %s table %s.",
											'products',
											$tab,
										),
									});
					last PRODBUILD;
				};
			my $prev_area = '';
			my $prev_cat = '';
			my @out = join "\t", @menufields;
			my @rows;
			my $base_search = "scan/co=yes/fi=$tab";
				

			for(@$ary) {
				my($sku, $area, $cat, $desc) = @$_;
				for( \$sku, \$area, \$cat, \$desc) {
					$$_ =~ s/\s+$//;
				}
				if($area ne $prev_area) {
					$prev_area = $area;
					$prev_cat = '';
					my $url = join '/',
								$base_search,
								"sf=prod_group",
								"se=$area",
								"op=eq",
								"tf=category,description",
								;
					push @rows, {
							%menuinit,
							msort => 0,
							page	=> $url,
							inactive => 0,
							name => $area,
							};
				}
				if($cat ne $prev_cat) {
					$prev_cat = $cat;
					my $url = join '/',
								$base_search,
								"sf=prod_group",
								"se=$area",
								"op=eq",
								"sf=category",
								"se=$cat",
								"op=eq",
								"tf=description",
								;

					push @rows, {
							%menuinit,
							msort => 1,
							page	=> $url,
							inactive => 0,
							name => $cat,
							};
				}
				push @rows, {
					%menuinit,
					msort => 2,
					name => $desc,
					inactive => 0,
					page => $sku,
				};
			}

			for(@rows) {
#Debug("pushing out --> " . $_->{name});
				push @out, join "\t", @{$_}{@menufields};
			}
			$Scratch->{qmenu_data} = join "\n", @out, '';
			$CGI->{qmenu_name} = '';
			$CGI->{qmenu_new} ||= 'Untitled';
#Debug("qmenu_data=$Scratch->{qmenu_data}");
		}
	}
	elsif ($CGI->{qmenu_cat}) {
		AREABUILD: {
			my $tab = $CGI->{qmenu_area} || 'area';
			my $ctab = $CGI->{qmenu_cat} || 'cat';
			my $db = $Db{$tab}
				or do {
					$Tag->error({ set => errmsg(
										"Failed to open %s table %s.",
										'area',
										$tab,
										),
									});
					last AREABUILD;
				};
#Debug("LARGE=" . $db->config('LARGE'));
			my $q = qq{ SELECT * FROM $tab ORDER BY sort };
			my $ary = $db->query({ sql => $q, hashref => 1 } )
							or do {
								$Tag->error({
										set => errmsg(
											"No results from %s table %s.",
											'area',
											$tab,
										),
									});
					last AREABUILD;
				};

sub old_link {
  my ($row, $nrow) = @_;
#Debug("row link_type='$row->{link_type}'");
  if($row->{link_type} eq 'external') {
	  $first = $row->{url};
	  $first =~ s/\s+$//;
	  $first =~ s/^\s+//;
	  $nrow->{page} = $first;
  }
  elsif	($row->{link_type} eq 'internal') {
	  my ($page, $form) = split /\s+/, $row->{url}, 2;
	  $nrow->{page} = $page;
	  $nrow->{form} = $form;
  }
  elsif	($row->{link_type} eq 'simple') {
	  my (@items) = split /\s*[\n,]\s*/, $row->{selector};
	  my @out;
	  my $fi = $row->{tab};
	  my $sp = $row->{page};
	  my $arg = '';
	  $nrow->{page} = 'search';
	  push @out, "fi=$fi" if $fi;
	  push @out, "sp=$sp" if $sp;
	  push @out, "st=db";

	  if(! @items) {
		  push @out, "ra=yes";
		  $nrow->{form} = join "\n", @out;
	  }
	  else {
		push @out, "co=yes";
		for(@items) {
			my ($col, $string) = split /\s*=\s*/;
			push @out, "sf=$col";
			push @out, "se=$string";
		}
		push @out, $row->{search}
			if $row->{search} =~ /^\s*\w\w=/;

		push @out, qq{va=banner_image=$row->{banner_image}};
		push @out, qq{va=banner_text=$row->{banner_text}};
		$arg = join "\n", @out;
		$nrow->{form} = $arg;
	  }
  }
  elsif	($row->{link_type} eq 'complex') {
	  $row->{search} =~ s/[\r\n+]/\n/g;
	  $row->{search} .= qq{\nva=banner_text=$row->{banner_text}};
	  $row->{search} .= qq{\nva=banner_image=$row->{banner_image}};
	  $nrow->{form} = $row->{search};
  }
  else {
	  $url = "";
  }
  return $nrow;
}

			my @rows;
			my $nc = '0000';
			my $cdb = $Db{$ctab};
			foreach my $row (@$ary) {
				my $code = $row->{code};
				my $nrow = {
					code => $nc++,
					name => $row->{name},
					img_icon => $row->{image},
					msort => 0,
					mgroup => $row->{set_selector},
				};
				old_link($row, $nrow);
				my $sq = qq{
						SELECT * FROM $ctab
						WHERE sel = '$code'
						OR    sel like '$code %'
						OR    sel like '% $code'
						OR    sel like '% $code %'
						ORDER BY sort
						};
#Debug("subquery=$sq");
				push @rows, $nrow;
				my $sary = $cdb->query({ sql => $sq, hashref => 1 });
#Debug("subquery returned: " . uneval($sary));
				for my $crow (@$sary) {
				  my $nsub = {
					  code => $nc++,
					  name => $crow->{name},
					  img_icon => $crow->{image},
					  msort => 1,
					  mgroup => $crow->{sel},
				  };
				  old_link($crow, $nsub);
				  push @rows, $nsub;
				}
			}
			for(@rows) {
#Debug("pushing out --> " . $_->{name});
				push @out, join "\t", @{$_}{@menufields};
#Debug("pushing out --> row=" . uneval($_));
			}
			push @out, join
			$Scratch->{qmenu_data} = join "\n", @out, '';
			$CGI->{qmenu_name} = '';
			$CGI->{qmenu_new} ||= 'Untitled';
#Debug("qmenu_data=$Scratch->{qmenu_data}");
		}
	}

	if($CGI->{qmenu_html_create} and $CGI->{qmenu_create}) {
		my $text = $CGI->{qmenu_html_create};
		my $start = '0001';
		my @out = join "\t", @menufields;
		while($text =~ s{<a(\s+.*?)</a>}{}is) {
			my $blob = $1;
			my $desc = '';
			$blob =~ m{^[^>]*\s+title=(['"]?)(.*?)\1}
				and $desc = $2;
			$blob =~ s{^.*?\shref\s*=\s*(["'])?(.*?)\1}{}is
				or next;
			my $link = $2;
			$blob =~ s/.*?>//;
			1 while $blob =~ s{<.*?>}{};
			$anchor = $blob;
			my $sort = $start;
			$sort =~ s/./x/;
			my($href, $parms) = split /\?/, $link, 2;
			my %record = (
				code => $start++,
				msort => $sort,
				page => $href,
				form => $parms,
				name => $anchor,
				description => $desc,
			);

			push @out, join "\t", @record{@menufields};
		}

		$Scratch->{qmenu_data} = join "\n", @out, '';
		$CGI->{qmenu_name} = '';
		$CGI->{qmenu_new} ||= 'Untitled';
	}

	my $files = $Tag->list_pages({
											base => $menupath,
											ext => '.txt',
											arrayref => 1,
										});
#Debug("files=" . join(",", @$files));
	my @names;
	for(@$files) {
		my $tmp = $_;
		$tmp =~ s/%([A-Fa-f0-9]{2})/chr(hex $1)/eg;
		$_ = "$menupath/$_.txt";
		push @names, $tmp;
	}

	@qmenu{@names} = @$files;

	my @fdata = "code\tfile";
	for(my $i = 0; $i < @names; $i++) {
		push @fdata, "$names[$i]\t$files->[$i]";
	}
	$Scratch->{qmenu_fdata} = join "\n", @fdata;

	if(my $mn = $CGI->{qmenu_name}) {
		my $filedata = $Tag->file($qmenu{$mn});
		if(! $filedata) {
			$filedata = $Tag->file("$menupath/$mn.txt");
			## Aha, in admin include
			$CGI->{qmenu_new} ||= $mn;
		}

		if($filedata) {
			$filedata =~ /^(.*)/;
			my $f = $1;
			$f =~ s/\s+$//;
			@menufields = split /\t/, $f;
		}
		else {
			$filedata = join("\t", @menufields);
		}
		$Scratch->{qmenu_data} = $filedata;
		$Scratch->{qmenu_name} = $mn;
		my $mbase;
		for $mbase ( $CGI->{ui_meta_view}, "menu_editor::$mn") {
			$menumeta = $Tag->meta_record($mbase)
				and $metabase = $mbase
					and last;
		}
	}

	my %illegal;
	my @illegal  = qw/check msg code/;
	my %suggested = qw/
                        extended 1
                        inactive 1
					/;
	my @required = qw/
                        description
                        form
                        mgroup
                        msort
                        name
                        page
					/;
	@required{@required} = @required;
	@illegal{@illegal} = @illegal;
	my $illegal = 0;
	for(my $i = 1; $i < @menufields; $i++) {
		my $f = lc $menufields[$i];
		$menu_fh{$f} = $i;
		delete $required{$f};
		delete $suggested{$f};
		if($illegal{$f}) {
			$Tag->error({
						name => 'Illegal field name',
						set => errmsg( "Name reserved: %s.", $f),
					});
			$illegal++;
		}
	}
	@suggested = keys %suggested;
	for(keys %required) {
			$Tag->error({
						set => errmsg( "Required field '%s' missing.", $_),
					});
			$illegal++;
	}
	delete $Scratch->{qmenu_data} if $illegal;
	@required{@required} = @required;
	return;
[/perl]

<p style="font-size: larger">

[tmp qmenu_options]
[loop head-skip=1 lr=1 list="[scratch qmenu_fdata]" cgi=1 option=qmenu_name]
<option value="[loop-code]">[loop-code]</option>
[/loop]
[/tmp]

<table width="95%">
<tr>
	<td width="30%">
[if scratch qmenu_options =~ /\S/]
	<form action="[area @@MV_PAGE@@]">
	<input name=mv_action type=hidden value="back">
	<B>Menu name:</B>
	<select name=qmenu_name><option value="">--select--</option>[scratch qmenu_options]</select>
	<input type=submit value="[L]Load[/L]">
	[page href="__UI_BASE__/file_transfer"
			form="
				initial_dir=include/menus
			"]Delete/Manage</A>
	</form>
[/if]
	</td>
	<td width="40%">
	<span class=cmessage>[warnings auto=1]</span>
	[error all=1 text="<ul class=cerror><li>%s</ul>" joiner="<li>"]
	</td>
	<td width="30%">
		<form action="[process href=@@MV_PAGE@@]">
		<input type=hidden name=mv_session_id value="[data session id]">
		<input type=hidden name=mv_action value="back">
		Build menu tree from database table:<br>
		<select name=qmenu_products>
		[loop list="__ProductFiles_0__ [list-databases]" option=qmenu_products cgi=1]
		<option> [loop-code][/loop]
		</select> <input type=submit value=Go>
		<br><br>
		<input type=checkbox name="qmenu_even_large" value=1> Override, build even if large
		</form>
	</td>
</tr>
</table>

<script language="JavaScript1.2">
	var lines = new Array;
	var initialized = 0;
	var no_alert = 0;
	var tree_mode = 0;
	var extended;
	var extra = new Array;
	var label = new Array;
	var meta = new Array;
	var help = new Array;
	var widget = new Array;
	var ltitle = new Array;
	var emodes;
	var evalues;

[perl reparse=0]
	my @out;
	my $i = 0;
	
	$metabase ||= 'icmenu';
	for(@menufields) {
		push @out, "    var \U$_\E = $i;";
		DOMETA: {
			last DOMETA if $required{$_} or $_ eq 'code';
			my $metaname = "${metabase}::$_";
			my $mrecord = $Tag->meta_record($metaname)
				or last DOMETA;
			my $lab;
			my $help;
			if($lab = $mrecord->{label}) {
				push @out, "    label[$i] = " . $Tag->jsq($lab) . ';';
			}
			if($help = $mrecord->{help}) {
				$help = '<span style="font-size: 12pt;">' .
						'<u>' . "$lab " . "($_)" . '</u><br>' . $help .
						'</span>';
				$help = $Tag->filter('encode_entities', $help);
				push @out, "    help[$i] = " . $Tag->jsq($help) . ';';
			}
			if( defined $Values->{ui_meta_force} && $Values->{ui_meta_force}
				or $Variable->{UI_META_LINK}
			   )
			{
				my $u = $Tag->page({ href => '__UI_BASE__/flex_editor',
									form => qq(
										ui_meta_view=metaconfig
										item_id=$metaname
									) });
				push @out, "    meta[$i] = " . $Tag->jsq($u . 'meta</a>');
			}
			if(my $type = $mrecord->{type}) {
				$mrecord->{name} = "ext_$_";
				$mrecord->{extra} = qq{onChange="form_changed(1)"};
				my $wid = $Tag->display( {
										meta => $mrecord,
										override => 1,
										default => '',
										} );
				push @out, "    widget[$i] = " . $Tag->jsq($wid) . ';';
			}
		}
		$i++;
	}

	for (@suggested) {
		push @out, "    var \U$_;";
	}

	$i = scalar(@menufields);
	push @out, "\tvar CHECK = $i;";
	$i++;
	push @out, "\tvar MSG = $i;";

	push @out, "\tlines[0] = ['" . join("', '", @menufields) . "'];";
	return join "\n", @out;
[/perl]

[restrict enable="perl calc scratch loop image area" log=none]
[loop head-skip=1 lr=1 list="[scratch qmenu_data]"][loop-sub jsline]
sub {
	$loopname = shift;
	my $row = shift;
	$loopinc++;

	while(@$row < @menufields) {
		push @$row, '';
	}

	if($CGI->{remap}) {
		my $tmp = $row->[$menu_fh{mgroup}];
		$row->[$menu_fh{mgroup}] = $row->[$menu_fh{msort}];
		$row->[$menu_fh{msort}] = $tmp;
	}

	my $i = 0;
	for(@$row) {
		my $foundit = '';
		if($_ eq '0') {
			# Do nothing
		}
		elsif(/^[1-9](\d*\.)?\d*$/) {
			# Do nothing
		}
		elsif(! length($_) and exists $menuinit{$menufields[$i]}) {
			$_ = $menuinit{$menufields[$i]};
		}
		elsif($_ !~ /'/) {
			s/\r/\\r/g;
			$_ = "'$_'";
		}
		elsif($_ !~ /"/) {
			s/\r/\\r/g;
			$_ = qq{"$_"};
		}
		else {
			if(s/^\s*{\s+//) {
				s/(,?\s*\}\s*)$//;
				$foundit = 1;
			}
			s/\\'/-_ESC_QUOTE_-/g;
			s/'/\\'/g;
			s/\r+$/' + "\\r"/g;
			s/\r/' + "\\r" + '/g;
			s/-_ESC_QUOTE_-/\\\\\\'/g;
			if($foundit) {
				$_ = "{" . $_ . "}";
			}
			$_ = qq{'$_'};
		}
		$i++;
	}
	my $line = "$loopname\[" . $loopinc  . "] = [" . join(", ", @$row) . "];";
#Debug("Final line=$line");
	return $line;
}
[/loop-sub][loop-exec jsline]lines[/loop-exec]
[/loop]
[calc]
	$loopinc++;
	$Scratch->{lastfull} = $loopinc;
	my $stop = $loopinc + 50;
	my @out;
	for(; $loopinc < $stop; $loopinc++) {
		# do nothing
	}
	$Scratch->{loopinc} = $loopinc - 1;
	return;
[/calc]

	var is_form_changed = 0;
	var checkcur = 0;
	var form;

	function form_changed (is) {
		if(is == undefined) 
			return is_form_changed;

		is_form_changed = is;

		set_save_buttons(is_form_changed);
	}

	function check_change (wid) {

		form.cancelsubmit.value = wid == undefined ? 0 : 1;

		if(form_changed() == 0) {
			form.cancelsubmit.value = '';
			return true;
		}

		if( confirm("Form has changed and not been saved. Continue?") ) {
			form.cancelsubmit.value = '';
			return true;
		}

		return false;
	}

	function set_checked_buttons (enab) {
		if(enab == undefined) 
			enab = 0;
		var dis;
		var vis;
		var weight;
		var f = document.qmenuform;
		if(enab == 0) {
			dis = 1;
			vis = 'Hidden';
			weight = 'normal';
			f.insbutton.value = "Append menu item";
		}
		else {
			dis = 0;
			vis = 'Visible';
			weight = 'bold';
			f.insbutton.value = "Insert menu item";
		}
		var buttons = [ f.delbutton, f.upbutton, f.downbutton,
						f.loadbutton, f.copybutton ];
		var i;
		for( i = 0; i < buttons.length; i++) {
			var el = buttons[i];
			if(el != undefined) {
				el.disabled			= dis;
				el.style.visibility	= vis;
				el.style.fontWeight	= weight;
			}
		}
		return;
	}

	function set_save_buttons (enab) {
		if(enab == undefined) 
			enab = 0;
		var color;
		var weight;
		if(enab == 0) {
			color = '#666666';
			weight = 'normal';
		}
		else {
			color = '#000000';
			weight = 'bold';
		}
		var f = document.qmenuform;
		var buttons = [ f.savebutton ];
		var i;
		for( i = 0; i < buttons.length; i++) {
			var el = buttons[i];
			if(el != undefined) {
				el.style.color			= color;
				el.style.fontWeight	= weight;
			}
		}
		return;
	}


	function checkit(idx) {
		var nam = 'img' + idx;
		var i_el = document.getElementById(nam);
		var empty_img = '[image dir-only=1 ui=1 secure="__UI_SECURE__"]box_empty.gif';
		var full_img = '[image dir-only=1 ui=1 secure="__UI_SECURE__"]box_checked.gif';
		var l = lines[idx];

		if(l != undefined && l[CHECK] == 1) {
			checkcur = l[CHECK] = 0;
			i_el.src = empty_img;
			set_checked_buttons(0);
			return void(0);
		}
		var i;
		var uncheck = new Array;
		var j = 0;
		for(i = 1; i < lines.length; i++)  {
			if(lines[i][CHECK] == 1) {
				uncheck[j] = i;
				j++;
			}
		}

		for(i = 0; i < uncheck.length; i++) {
			var n = uncheck[i];
			lines[n][CHECK] = 0;
			var el = document.getElementById('img' + n);
			el.src = empty_img;
		}

		checkcur = idx;
		lines[idx][CHECK] = 1;
		i_el.src = full_img;
		set_checked_buttons(1);
		// alert("checkcur=" + checkcur);
		return void(0);
	}

    function escapeParams (parms) {
		// alert("parms=" + parms);
		parms = parms.replace(/[\r\n]+/g, "\n");
		parms = parms.replace(/^\s+/, "");
		parms = parms.replace(/\s+$/, "");
		parms = parms.replace(/=/g, "-_EQUAL_X_-");
		parms = parms.replace(/\n/g, "-_NEWLINE_X_-");
		parms = escape(parms);
		parms = parms.replace(/-_NEWLINE_X_-/g, '@@UrlJoiner@@');
		parms = parms.replace(/-_EQUAL_X_-/g, '=');
		// alert("parms=" + parms);
		return parms;
	}

    function unescapeParams (parms) {
		// alert("parms=" + parms);
		parms = parms.replace(/=/g, "-_EQUAL_X_-");
		parms = parms.replace(/@@UrlJoiner@@/g, "-_NEWLINE_X_-");
		parms = unescape(parms);
		parms = parms.replace(/-_NEWLINE_X_-/g, "\n");
		parms = parms.replace(/-_EQUAL_X_-/g, '=');
		// alert("parms=" + parms);
		return parms;
	}

	var page_rep = '';
	var params_rep = '';
	var name_rep = '';
	var showlevel = 1;
	
	function toggleShowlevel () {
	    if(showlevel != 1) {
			showlevel = 1;
		}
		else {
			showlevel = 0;
		}

		if(tree_mode == 1) {
			for(var i = 1; i < lines.length; i++)
				rewrite_tree(i);
		}
		else {
			showlevel = 0;
		}
		form.showlevel.checked = showlevel;
	}
	
	function toggleName (form,val) {
		if(val != undefined) {
			val = val.replace(/\s+$/, '');
			if (val == '') {
				form.label.checked = 1;
			}
			else {
				form.label.checked = 0;
			}
			return;
		}

		if(form.label.checked) {
			page_rep = form.page.value;
			params_rep = form.params.value;
			form.page.value = '';
			form.params.value = '';
		}
		else {
			form.page.value = page_rep;
			form.params.value = params_rep;
		}
		set_save_buttons(form_changed);
		return;
	}

	function toggleBreak (form,val) {
		if(val != undefined) {
			val = val.replace(/\s+$/, '');
			if (val == '') {
				form.breakline.checked = 1;
			}
			else {
				form.breakline.checked = 0;
			}
			return;
		}
			
		if(form.breakline.checked) {
			form.label.checked = 0;
			toggleName(form);
			form.label.checked = 1;
			toggleName(form);
			name_rep = form.name.value;
			form.name.value = '';
		}
		else {
			form.name.value = name_rep;
		}
		set_save_buttons(form_changed);
		return;
	}

	function ext_name (str) {
		var pos = str.indexOf('_') + 1;
		if(pos < 1) 
			return '';
		str = str.substr(pos);
		return str;
	}

	function show_title (idx, msg) {
		var el = document.getElementById('titlebox');
		if(el == undefined) 
			return;
		if(msg == undefined) 
			msg = ltitle[idx];
		if(idx == 0 || msg.length == 0) {
			el.style.visibility = 'Hidden';
		}
		else {
			el.innerHTML = msg;
			el.style.visibility = 'Visible';
		}
	}

	function set_mode (mode) {
		if(mode == 'toggle') {
			if(tree_mode == 0) {
				mode = 'tree';
			}
			else {
				mode = 'simple';
			}
		}
		var f = document.qmenuform;
		var el = f.treebutton;
		var ch = f.qmenu_tree;
		var cht = f.qmenu_write_tree;
		var tel = document.getElementById('treebox');
// alert("change mode, el=" + el);
		if(mode == 'tree') {
			tree_mode = 1;
			lines[1][MSORT] = 0;
			el.value = "Set simple mode";
			ch.checked = 1;
			cht.checked = 1;
			tel.style.visibility = 'Visible';
		}
		else {
			tree_mode = 0;
			lines[1][MSORT] = 'x';
			el.value = "Set tree mode";
			ch.checked = 0;
			cht.checked = 0;
			tel.style.visibility = 'Hidden';
		}
		var i;
		for(i = 1; i < lines.length; i++) {
			rewrite(i);
		}
		return;
	}

	function rewrite_tree (idx) {
		var out = '';

		var l = lines[idx];
			
		if(l != undefined && idx < lines.length) {
			// out =	idx + 
			out = ' <a href="javascript:checkit(' + idx + ');void(0)"><img ';
			if(l[CHECK] == 1) {
				out = out + 'src="__UI_IMG__box_checked.gif" ';
			}
			else {
				out = out + 'src="__UI_IMG__box_empty.gif" ';
			}

			var grp = l[MSORT] + '';
// alert("rewrite grp=" + grp);
			if(! grp.match(/^\d+$/) ) {
				l[MSORT] = 0;
			}
			out = out + 'border=0 align=absbottom ' +
					'id="img' + idx + '"></A>' + "\n" +
					'<a href="javascript:motion(' + idx + ", 'left');void(0)" +
					'"><img src="__UI_IMG__left.gif" border=0 align=absbottom></A>' + "\n" +
					'<a href="javascript:motion(' + idx + ", 'right');void(0)" +
					'"><img src="__UI_IMG__right.gif" border=0 align=absbottom></A>' + "\n" +
					'<a href="javascript:loadForm(' + idx + ");void(0)" +
					'"><img src="__UI_IMG__forward.gif" border=0 align=absbottom></A>' + "\n";
			for(i = 0; i < l[MSORT]; i++)
				out = out + '&nbsp;&nbsp;&nbsp;'; 
			if(showlevel == 1 && l[MSORT] > 0) {
				out = out + l[MSORT] + '&nbsp;'
			}

			var nme = l[NAME];
			if(nme != undefined) {
				nme = nme.replace(/</g, '&lt;');
			}
			if(l[PAGE]) {
				var i;
				out = out + '<a href="javascript:loadForm(' +
						idx + ');void(0)"' +
						' onDblClick="checkit(' + idx + ')"' +
						' title="' + l[PAGE];
				if(l[FORM])
					out = out + '?' + l[FORM];
				if(l[DESCRIPTION])
					out = out + " : " + l[DESCRIPTION];
				out = out + '">' + nme + '</a>';
			}
			else {
				out = out + '<b>' + nme + '</b>';
			}

			if(l[MSG]) {
				out = out + ' <i style="font-size: 8pt;">(' + l[MSG] + ')</i>';
			}
		}

		var el = document.getElementById('box' + idx);
// alert("rewriting, el=" + el);
		el.innerHTML = out;
		if(l != undefined && l[CHECK] == 1)
			checkcur = idx;
		// alert("idx=" + idx + ", writing " + out);
		if(lines.length > 25) 
			document.getElementById('scrollbox').style.overflow = 'scroll';
		if(lines.length < 25) 
			document.getElementById('scrollbox').style.overflow = 'visible';
		return;
	}

	function rewrite (idx) {
		if(tree_mode == 1)
			return rewrite_tree(idx);

		var out = '';

		var l = lines[idx];
			
		if(l != undefined && idx < lines.length) {
			// out =	idx + 
			out = ' <a href="javascript:checkit(' + idx + ');void(0)"><img ';
			if(l[CHECK] == 1) {
				out = out + 'src="__UI_IMG__box_checked.gif" ';
			}
			else {
				out = out + 'src="__UI_IMG__box_empty.gif" ';
			}

			var linktitle = '';
			var lzero = lines[0];
			for(var k = 1; k < lzero.length; k++) {
				var lstring = l[k] + '';
				if(lstring.length > 0)
					linktitle = linktitle + '<b>' + lzero[k] + ':</b> ' + lstring + "<br>";
			}
			out = out + 'border=0 align=absbottom ' +
					'id="img' + idx + '"></A>' + "\n" +
					'<a href="javascript:motion(' + idx + ", 'up');void(0)" +
					'"><img src="__UI_IMG__up.gif" border=0 align=absbottom></A>' + "\n" +
					'<a href="javascript:motion(' + idx + ", 'down');void(0)" +
					'"><img src="__UI_IMG__down.gif" border=0 align=absbottom></A>' + "\n" +
					'<a href="javascript:loadForm(' + idx + ");void(0)" +
					'"><img src="__UI_IMG__transfer.gif" border=0 align=absbottom></A>' + "\n";
			if(l[PAGE]) {
				out = out + '&nbsp;&nbsp;&nbsp;<a href="javascript:loadForm(' +
						idx + ');void(0)"' +
						' onDblClick="checkit(' + idx + ')"' +
						' onMouseOver="show_title(' + idx + ')"' +
						' onMouseOut="show_title(0)"' +
						' title="' + l[PAGE];
				if(l[FORM])
					out = out + '?' + l[FORM];
				out = out + '">' + l[NAME] + '</a>';
			}
			else {
				out = out + '<span style="font-weight: bold"' +
						' onMouseOver="show_title(' + idx + ')"' +
						' onMouseOut="show_title(0)"' + '>'
						l[NAME] + '</span>';
			}

			if(l[MSG]) {
				out = out + ' <i style="font-size: 8pt;">(' + l[MSG] + ')</i>';
			}

			// Set box title array
			ltitle[idx] = linktitle.replace(/\r/g, '<br>');
		}

		var el = document.getElementById('box' + idx);
// alert("rewriting idx=" + idx + ", el=" + el);
		el.innerHTML = out;
		if(l != undefined && l[CHECK] == 1)
			checkcur = idx;
		// alert("idx=" + idx + ", writing " + out);
		if(lines.length > 25) 
			document.getElementById('scrollbox').style.overflow = 'scroll';
		if(lines.length < 25) 
			document.getElementById('scrollbox').style.overflow = 'visible';
		return;
	}

	function delRow (idx) {

		if( ! check_change() )
			return;

		zeroForm;

		if(idx == undefined || idx < 1) {
			idx = checkcur;
			if(idx > 0)
				checkit(idx);
		}
		if(idx == undefined || idx < 1) {
			alert("No row selected!");
			return;
		}

		var l = lines[idx];
		if(l == undefined) {
			alert("deleting non-existent row!");
			return;
		}

		var needs_confirm = l[PAGE].length || l[FORM].length

		var i;
		for(i = 3; i < 8; i++) {
			if(l[i] != undefined && l[i].length) {
				needs_confirm = 1;
				break;
			}
		}
			
		if(needs_confirm && ! confirm("Delete row " + idx + ", '" + lines[idx][NAME] + "'?") )
			return;

		var len  = lines.length;
		var last = len - 2;

		if(tree_mode == 1) {
			var d = lines[idx + 1];
			if(l[MSORT] == 0 && d != undefined && d[MSORT] > 0) {
				motion(idx + 1, 'left');
			}
			else {
				var save = no_alert;
				no_alert = 1;
				motion(idx, 'left');
				no_alert = save;
			}
		}

		for( i = idx; i <= last; i++) {
			lines[i] = lines[i+1];
			rewrite(i);
		}
		len--;
		lines.length   = len;
		rewrite(len);
		for(i = idx; i <= len; i++) 
			rewrite(i);
		return;
	}

	function insRow (idx) {

		if( ! check_change() )
			return;

		if(idx == undefined || idx < 1) {
			idx = checkcur;
			if (idx > 0)
				checkit(idx);
		}

		if(idx == undefined || idx < 1) {
			idx = lines.length;
		}

		lines.length = lines.length + 1;
		var last = lines.length - 1;
		
		if(lines[idx] != undefined) {
			var penult = last - 1;
			var i;
			for( i = penult; i >= idx; i--) {
				lines[i + 1] = lines[i];
				rewrite(i + 1);
			}
		}

		lines[idx] = new Array;
		for (i = 0; i < CHECK; i++)
			lines[idx][i] = '';
		lines[idx][MSG] = 'NEW';

		if(tree_mode == 1) {
			if(lines[idx - 1] != undefined) {
				lines[idx][MSORT] = lines[idx-1][MSORT];
			}
			else {
				lines[idx][MSORT] = 0;
			}
		}

		rewrite(idx);

		var ch = [	form.page.value,
					form.params.value,
					form.description.value,
					form.extended.value];
		var something = 0;
		var i;
		for(i = 0; i < ch.length; i++) {
			if(ch[i] != undefined && ch[i].length > 0) {
				something = 1;
				break;
			}
		}

		form.lineidx.value = idx;
		if(something > 0 && confirm("Start item out with values from form?")) {
			saveForm(idx);
		}
		return;
	}

	function loadForm (idx, msg, zeromsg) {
		if( ! check_change() )
			return;

		if(idx == undefined || idx <= 0) {
			idx = checkcur;
			if (idx <= 0) return;
			checkit(idx);
		}

		if(msg == undefined)
			msg = 'loaded'; 
                            
		if(zeromsg == undefined)
			zeromsg = 'loaded';

		var l = lines[idx];
		// alert("idx=" + idx + "\nl=" + l + "\nform=" + form);

		form.name.value      = name_rep   = l[NAME];
		form.page.value      = page_rep   = l[PAGE];
		form.params.value    = params_rep = unescapeParams(l[FORM]);
		form.description.value            = l[DESCRIPTION];
		form.mgroup.value                 = l[MGROUP];

		for(var x = 0; x < extra.length; x++) {
			var el;
			var en = extra[x];
			var un = en.toUpperCase();
			var eidx;
			eval('eidx = ' + un);
			eval ('el = form.ext_' + en );
//			if( x < 2) {
// alert('loading extra form value ' + en + '(' + un + '), eidx=' + eidx + ', value=' + l[eidx]);
//			}
			if(el == undefined) {
				alert('bad extra form element: ' + en);
				continue;
			}
			if(el.type == 'select') {
				for(var j = 0; j < el.length; j++) {
					if(el.options[j].value == l[eidx]) {
						el.selectedIndex = j;
						break;
					}
				}
			}
			else {
				el.value = l[eidx];
			}
		}

		if(INACTIVE != undefined) {
			form.inactive.disabled = 0;
			form.inactive.checked = l[INACTIVE] ? 1 : 0;
		}
		else {
			form.inactive.disabled = 1;
		}

		if(form.page.value == '') {
			form.label.checked = 1;
		}
		else {
			form.label.checked = 0;
		}
		if(form.name.value == '') {
			form.breakline.checked = 1;
		}
		else {
			form.breakline.checked = 0;
		}
		form.lineidx.value = idx;

		var j;
		for(j = 0; j < lines.length; j++) {
			if(lines[j] != undefined && lines[j][MSG] == zeromsg) {
				lines[j][MSG] = '';
				rewrite(j);
			}
		}
		l[MSG] = msg;
		rewrite(idx);
		form_changed(0);
		return;
	}

	function zeroForm (form) {
		if(form == undefined) {
			form = document.qmenuform;
		}
		form.page.value = '';
		form.params.value = '';
		form.name.value = '';
		form.description.value = '';
		form.mgroup.value = '';
		if(EXTENDED != undefined)
			form.extended.value = '';

		form.inactive.checked = 0;
		form.breakline.checked = 0;
		form.label.checked = 0;
		form.lineidx.value = 0;

		for(var x = 0; x < extra.length; x++) {
			var el;
			var en = extra[x];
			var un = en.toUpper;
			eval ('el = form.ext_' + en );

			if(el.type == 'select') {
				el.selectedIndex = undefined;
			}
			else {
				el.value = '';
			}
		}


		form_changed(0);
		return;
	}

	function boxMsg (idx, msg) {
		
	}

	function saveForm (idx, msg, zeromsg) {

		if(idx == undefined || idx < 1)
			idx = form.lineidx.value;

		if(idx <= 0) {
			alert("Improper line index " + idx);
			return;
		}
		var l = lines[idx];

		if(msg == undefined)
			msg = 'saved';

		if(zeromsg == undefined)
			zeromsg = 'saved';

		// alert("idx=" + idx + "\nl=" + l + "\nform=" + form);

		form.lineidx.value = idx;
		l[PAGE] = form.page.value;
		l[FORM] = escapeParams(form.params.value);
		l[NAME] = form.name.value;
		l[MGROUP] = form.mgroup.value;

		var ttt = form.description.value;
		ttt = ttt.replace(/\r\n/g, "\r");
		l[DESCRIPTION] = ttt.replace(/\n/g, "\r");

		for(var x = 0; x < extra.length; x++) {
			var el;
			var en = extra[x];
			var un = en.toUpperCase();
			var eidx;
			eval('eidx = ' + un);
			eval('el = form.ext_' + en );

			if(el.type == 'select') {
				var sel = el.options[el.selectedIndex];
				if(sel == defined) {
					l[eidx] = sel.value;
				}
				else {
					l[eidx] = '';
				}
			}
			else {
				l[eidx] = el.value;
			}
		}

		if(INACTIVE != undefined) {
			l[INACTIVE] = form.inactive.checked ? 1 : 0;
		}

		var j;
		for(j = 0; j < lines.length; j++) {
			if(lines[j] != undefined && lines[j][MSG] == zeromsg) {
				lines[j][MSG] = '';
				rewrite(j);
			}
		}

		l[MSG] = msg;
		if(checkcur > 0)
			checkit(checkcur);
		rewrite(idx);
		zeroForm();
		return;
	}

	function setOutput () {
		var output = new Array;
		var i;
		var linelen = [calc]scalar @menufields[/calc];
		output[0] = "[calc]join "\\t", @menufields [/calc]";
		document.qmenuform.qmenu_text.value = output[0];
		for(i = 1; i < lines.length; i++) {
			var ttt = "" + i;
			while( ttt.length < 3 )
				ttt = '0' + ttt;
			var tl = new Array;
			var j;
			tl[0] = ttt;
			if(tree_mode != 1)
				lines[i][MSORT] = 'x' + ttt;
			for( j = 1; j < linelen; j++) {
				tl[j] = lines[i][j];
				if(tl[j] == undefined) 
					tl[j] = '';
			}
			tl[DESCRIPTION] = tl[DESCRIPTION].replace(/\r/g, "\\r");
			if(EXTENDED != undefined) 
				tl[EXTENDED] = tl[EXTENDED].replace(/\r/g, "\\r");
			output[i] = tl.join("\t");
		}
		document.qmenuform.qmenu_text.value = output.join("\n") + "\n";
		// alert(document.qmenuform.qmenu_text.value);
		return;
	}

	function canon_lines () {
		for(i = lines.length - 1; i > 0; i--) {
			if(lines[i] != undefined)
				break;
			lines.length = lines.length - 1;
		}
	}

	function do_alert (msg) {
		if(no_alert != 1)
			alert(msg);
	}

	function moveit (idx, motion) {
		var up = idx - 1;
		var dn = idx + 1;

		var dest;

		if (up < 1 && motion == 'up')
			return void(0);
		if (dn > lines.length - 1 && motion == 'down')
			return void(0);
		dest = motion == 'up' ? up : dn;

		var tmp = lines[dest];
		lines[dest] = lines[idx];
		lines[idx] = tmp;

		rewrite(idx);
		rewrite(dest);

		return;
	}

	function movetree (idx, motion) {
		var up = idx - 1;
		var dn = idx + 1;

		if(up < 1) {
			alert("Can't move first element in tree.");
			return;
		}

		var end = checkcur;

		if(end < idx)
			end = idx;
		
		var x;
		for(x = idx; x <= end; x++) {
			var l = lines[x];
			var u = lines[up];
			var d = lines[dn];
			u[MSORT] *= 1;
			l[MSORT] *= 1;
			if(isNaN(u[MSORT])) {
				u[MSORT] = 0;
			}

			if(isNaN(l[MSORT])) {
				l[MSORT] = 0;
			}

			if(motion == 'left') {
				if(l[MSORT] == 0) {
					if(x == idx) {
						do_alert("Already at top level.");
						break;
					}
				}
				else {
					l[MSORT] -= 1;
				}
				while (x >= end && d != undefined && d[MSORT] - 1 > l[MSORT]) {
					d[MSORT] -= 1;
					rewrite_tree(dn);
					dn++;
					d = lines[dn];
				}
			}
			else {
				if(l[MSORT] > u[MSORT]) {
					if(x == idx) {
						do_alert("Already at farthest right, need parent at same level or higher.");
						break;
					}
				}
				else {
					l[MSORT] += 1;
				}
			}
			dn++;
			up++;
			rewrite(x);
		}

		return;
	}

	function search_win () {
			window.name = 'mainwindow[scratch window_name]';
			var url = '[area
							href="admin/search_wizard"
							form=|
								ui_source_form=qmenuform
								ui_source_var=params
							|]';
			url += '&ui_searchblob=' + escape(form.params.value);
			window.open(url, undefined, 'scrollbars,location=no,status=no,toolbar=no,resizable,fullsize=no,width=900,height=700');
			return void(0);
	}

	function motion (idx, motion, fromchecked) {

		if(motion == 'left' || motion == 'right') {
			if(tree_mode != 1) {
				alert("Not in tree mode, can't move " + motion);
				return;
			}

			return movetree(idx, motion);
		}
		if(fromchecked == 1) {
			idx = checkcur;
			if(idx == undefined || idx < 1)
				return;
		}

		var up = idx - 1;
		var dn = idx + 1;

		if( ! check_change() )
			return;

		var dest;

		// alert("checkcur=" + checkcur + "\nidx=" + idx + "\ndest=" + dest);
		if (checkcur != 0 && fromchecked != 1) {
			dest = checkcur;
			checkit(checkcur);
			if(idx == dest) 
				return void(0);
			if(idx < dest) {
				var k;
				if(motion == 'up') 
					dest--;

				for( k = idx; k < dest; k++) {
					moveit(k, 'down');
				}
			}
			else {
				var k;
				if(motion == 'down') 
					dest++;
				for( k = idx; k > dest; k--) {
					moveit(k, 'up');
				}
			}
			motion = 0;
		}
		else {
			if (up < 1 && motion == 'up')
				return void(0);
			if (dn > lines.length - 1 && motion == 'down')
				return void(0);
			dest = motion == 'up' ? up : dn;
		}

		// alert("checkcur=" + checkcur + "\nidx=" + idx + "\ndest=" + dest);
		if (motion) {
			moveit(idx, motion);
		}

		return void(0);
	}

</script>
[/restrict]

<form name=qmenuform action="[process href=@@MV_PAGE@@]" method=POST>
<input name=mv_session_id type=hidden value="[data session id]">
<input name=mv_action type=hidden value="back">
<input name=cancelsubmit type=hidden value="">
<input name=qmenu_name type=hidden value="[scratch qmenu_name]">
<input name=qmenu_text type=hidden value="">

<table>
<tr>
	<td>
Save to new menu <input name=qmenu_new type=text size=20 value="[cgi qmenu_new]">
		<input type=submit
				style="Visibility: Hidden;"
				disabled=1
				name=junksubmit
				value=".">
		<input type=submit name=doit style="font-weight: bold" value="Publish" onClick="check_change(1) && setOutput()">
		&nbsp;&nbsp;&nbsp;
		<input type=submit
				onClick="
					this.form.qmenu_text.value='';
					this.form.qmenu_new.value='';
					this.form.qmenu_name.value='';
					"
				value="Cancel">
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<input type=button
				onClick="set_mode('toggle')"
				name=treebutton
				value="Set tree mode">
		<div id=treebox>
		<input type=checkbox name=qmenu_tree value=1> Tree mode
		<input type=checkbox name=qmenu_write_tree value=1> Write tree to DB
		<input type=checkbox name=showlevel value=1 onClick="toggleShowlevel()" CHECKED=1> Show numerical level
		</div>
<br>
		<input type=button
				onClick="insRow()"
				name=insbutton
				value="Insert menu item">
		<input type=button
				name=delbutton
				style="visibility: Hidden;"
				disabled=1
				onClick="delRow()"
				value="Delete menu item">
		<input type=button
				name=upbutton
				style="visibility: Hidden;"
				disabled=1
				onClick="motion(0,'up',1)"
				value="Up">
		<input type=button
				name=downbutton
				style="visibility: Hidden;"
				disabled=1
				onClick="motion(0,'down',1)"
				value="Down">
	</td>
</tr>
</table>
	<div id=titlebox style="
						position: Absolute;
						Top: 300;
						Left: 300;
						border: 2pt gray solid;
						background: #CCCCCC;
						float: right;
						Visibility: Hidden;
						zAxis: 2;
						">
		Test floatbox.
	</div>
<table width="95%">
<tr>
	<td width="40%" valign=top>[set empty][/set]
	<div id=scrollbox style="
						width: 100%;
						height: 800px;
						overflow: auto;
						border: 1pt gray shaded;
						">
[loop head-skip=1 lr=1 list="[scratch qmenu_data]"][list]<div id=box[loop-increment] style="font-size: 11pt; width=300px; [loop-alternate 2]Background: #EEEEEE;[/loop-alternate]"></div>
[/list][no-match][set empty]1[/set][/no-match]
[/loop]
[loop ranges=1 list="[scratch lastfull]..[scratch loopinc]"]<div id=box[loop-code] style="font-size: 11pt; width=300px;">[loop-change 1]
[condition]1[/condition][if scratch empty]
<h3>Create menu from HTML</h3>
<textarea name=qmenu_html_create rows=20 cols=50
onChange="this.form.qmenu_new.focus()"></textarea>
<br>
<input type=submit name=qmenu_create value="Create New Menu">
[/if]
[/loop-change 1]</div>
[/loop]
	</div>
	</td>
	<td valign=top>
		<table>
		<tr>
			<td class=clabel>
				Name
			</td>
			<td class=cdata>
				<input name=name type=text size=30 onChange="form_changed(1);toggleBreak(this.form,this.value); void(0)">
			</td>
		</tr>
		<tr>
			<td class=clabel>
				Page
			</td class=cdata>
			<td class=cdata>
				<input name=page type=text size=50 onChange="form_changed(1);toggleName(this.form,form.page.value)">
			</td>
		</tr>
		<tr>
			<td class=clabel>
				Form values<br>
				<input name=ui_searchblob type=hidden value="">
				<input name=ui_source_win type=hidden value="[scratch window_name]">

			<div align=right>
			<input
				style="font-size: smaller; font-weight: bold;"
				type=button
				value="Create search"
				onClick="this.form.page.value = 'search';form_changed(1);search_win();"
				>&nbsp;<input
							style="font-size: smaller;"
							type=button onClick="this.form.params.value=''"
							value="clear search">
			</div>
			</td>
			<td class=cdata>
				<textarea cols=50 rows=4 name=params onChange="form_changed(1);"></textarea>
			</td>
		</tr>
		<tr>
			<td class=clabel>
				Options
			</td>
			<td class=cdata>
				Menu Group <input name=mgroup  type=text onChange="form_changed(1);">
				&nbsp;&nbsp;
				<input name=inactive  type=checkbox value=1 onChange="form_changed(1);">Inactive entry<br>
				<input name=label type=checkbox value=1 onChange="form_changed(1);toggleName(this.form)">Label only<br>
				<input name=breakline type=checkbox value=1 onChange="form_changed(1);toggleBreak(this.form)">Break line
			</td>
		</tr>
		<tr>
			<td class=clabel>
				Detailed Description
			</td>
			<td class=cdata>
				<textarea cols=50 rows=4 name=description onChange="form_changed(1);"></textarea>
			</td>
		</tr>
		<tr>
			<td colspan=2>
		<input type=hidden name=lineidx value="0">
		<input type=button onClick="saveForm()" name=savebutton value="Save menu item">
		<input type=button onClick="loadForm()" name=loadbutton
					style="visibility: Hidden;"
					value="Load menu item">
		<input type=button onClick="saveForm(checkcur)" name=copybutton
					style="visibility: Hidden;"
					value="Copy to checked entry">
		<br><br>
		<input type=submit style="font-weight: bold" name=doit value="Publish" onClick="check_change(1) && setOutput()">
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<input type=submit
				onClick="
					this.form.qmenu_text.value='';
					this.form.qmenu_new.value='';
					this.form.qmenu_name.value='';
					"
				value="Cancel">
			</td>
		</tr>
<script>
		form = document.qmenuform;
		var i ;
		var tm = 1;

		for(i = 1; i < lines.length; i++) {
			if( isNaN(lines[i][MSORT] * 1)  ) {
					tm=0;
					break;
			}
		}

		if(lines.length > 1) {
			if(tm == 1) {
				set_mode('tree');
			}
			else {
				set_mode('simple');
			}
		}

		set_checked_buttons();
		set_save_buttons();
		if(INACTIVE == undefined) {
			document.qmenuform.inactive.disabled = 1;
		}
		initialized = 1;
		var reserved = /^(extended|inactive|description|form|mgroup|msort|name|page|code)$/;
		var f = lines[0];
		for (i = 0; i < f.length; i++) {
			var fn = f[i];
			if(! fn.match(reserved) ) {
				var nn = 'ext_' + fn;
				var un = fn.toUpperCase();
// alert([jsq]fn=$fn nn=$nn un=$un[/jsq]);
				var eidx;
				eval('eidx = ' + un);
// alert([jsq]fn=$fn un=$un nn=$nn eidx=$eidx[/jsq]);
				var nidx = extra.length;
				extra.length += 1;
				extra[nidx] = fn;
				var lab = fn;
				var wid;
				var helptext = help[i];
				if(helptext == undefined)
					helptext = '';
				if(label[eidx] != undefined) {
					lab = label[eidx];
				}
				if(widget[eidx] != undefined) {
					wid = widget[eidx];
				}
				else {
					wid = [jsq]<input type=text name="$nn" onChange="form_changed(1);">[/jsq];
				}
				document.write([jsq]
		<tr>
			<td class=clabel onMouseOver="show_title(1, '$helptext')" onMouseOut="show_title(0)">
				$lab
			</td>
			<td class=cdata>
				$wid
			</td>
		</tr>
			[/jsq]);

			}

		}
		
		if(EXTENDED != undefined) {
			document.write([jsq]
		<tr>
			<td class=clabel>
				Extended Parameters (advanced)
			</td>
			<td class=cdata>
				<textarea cols=50 rows=4 name=extended onChange="form_changed(1);"></textarea>
			</td>
		</tr>
			[/jsq]);
		}

</script>
		</table>
	</td>
</tr>
</table>
<a href="javascript:document.qmenuform.inactive.disabled = 1; void(0)">Disable</A>
<a href="javascript:document.qmenuform.inactive.disabled = 0; void(0)">Enable</A>
</form>
<!-- ----- END REAL STUFF ----- -->
@_UI_STD_FOOTER_@
