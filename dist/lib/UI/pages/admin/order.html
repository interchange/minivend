[if cgi showpending]
[value name=showarchive set=""]
[/if]

[value name=mv_data_table set=transactions hide=1]
[if-mm !tables]
[set ui_error]
	Not authorized for order administration. Contact administrator?
[/set]
[bounce page="__UI_BASE__/error"]
[/if-mm]

[tag flag write]transactions[/tag]
[perl tables=transactions]
	delete $Scratch->{ui_location};
	my $db = $Db{transactions};
	if(! $db) {
		$Scratch->{error_message} = "<FONT CLASS=error>Error: no transactions database.</FONT><BR>";
		$Scratch->{ui_location} = "__UI_BASE__/error";
		return;
	}

	my ($value, $action_col);
	if($CGI->{archiveorder}) {
		$value = 1;
		$action_col = 'archived';
	}
	elsif($CGI->{unarchiveorder}) {
		$value = 0;
		$action_col = 'archived';
	}
	elsif($CGI->{deleteorder}) {
		$value = 1;
		$action_col = 'deleted';
	}
	elsif($CGI->{vieworder} and ! $CGI->{viewnext}) {
		$Scratch->{ui_location} = $Tag->area('__UI_BASE__/order_view', $CGI->{order});
	}
	elsif($CGI->{deletebogusorder}) {
	}
	elsif($CGI->{xload}) {
		$Scratch->{ui_location} = $Tag->area('__UI_BASE__/dbdownload');
	}

	if($action_col) {
		for(@{$CGI_array->{order}}) {
			$db->set_field($_, $action_col, $value);
		}
	}
	if(@errors) {
		my $plural = @errors > 1 ? 's' : '';
		return "<FONT CLASS=error>Error$plural:<UL><LI>" .
				join ("<LI>", @errors)                    .
				"</UL></FONT><BR>";
	}
	if($CGI->{viewnext}) {
		my $ordnum = $CGI->{order};
		$ordnum =~ s/[\0,\s].*//;
		return if ! $ordnum;
		$ordnum++;
		CHECKNEXT: {
			if (! $db->record_exists($ordnum) ) {
				undef $ordnum;
				last CHECKNEXT;
			}
			if ($db->field($ordnum, 'deleted') ) {
				$ordnum++;
				next CHECKNEXT;
			}
			if ($Values->{showarchive} and ! $db->field($ordnum, 'archived') ) {
				undef $ordnum;
				last CHECKNEXT;
			}
			else {
				last CHECKNEXT;
			}
		}
		if ($ordnum) {
			$Scratch->{ui_location} = $Tag->area(
									{
										href => '__UI_BASE__/order_view',
										form => "order=$ordnum",
									}
									);
		}
		else {
			$Scratch->{message} = "[L]No next order.[/L]";
		}
	}
	return;
[/perl]


[if scratch ui_location]
[bounce href=`delete $Scratch->{ui_location}`]
[/if]

[set icon_name]admin/icon_orders.gif[/set]
[seti page_title]
	[if value showarchive]
	Orders: archived orders
	[set help_name]order.main.archived[/set]
	[else]
	Orders: pending orders
	[set help_name]order.main.pending[/set]
	[/else]
	[/if]
[/seti]
[update values]

@@UI_STD_HEAD@@


[if scratch message]
<BLOCKQUOTE>
[scratch message]
</BLOCKQUOTE>
[set message][/set]
[/if]
</font>

<!-- ----- BEGIN REAL STUFF ----- -->

<!-- ----- Show the archive/pending buttons ----- -->

<form action="[area __UI_BASE__/order]" method=POST>
<INPUT TYPE=hidden NAME=mv_action VALUE=return>

<input type=hidden name=archive value="false">

<p>
&nbsp;
<table cellpadding=3 cellspacing=0>
<tr>
<td colspan=2 bgcolor=__UI_C_TOPBLOCKBAR__><img src="admin/cleardot.gif" width=__UI_OVERALL_WIDTH__ height=1></td>
</tr>

[if value showarchive]
<tr>
<td bgcolor="__UI_C_INTBLOCK__" width=__UI_OVERALL_WIDTH__ colspan=2>
<input type=submit name="showpending" value="Show pending orders">
[set archive_sense]=[/set]
</td>
</tr>
[else]
<tr>
<td bgcolor="__UI_C_INTBLOCK__" width=__UI_OVERALL_WIDTH__ colspan=2>
<input type=submit name="showarchive" value="Show archived orders">
[set archive_sense]!=[/set]
</td>
</tr>
[/else]
[/if]

<tr>
<td colspan=2 bgcolor=__UI_C_INTBLOCKBAR__><img src="admin/cleardot.gif" width=__UI_OVERALL_WIDTH__ height=1></td>
</tr>

<!-- ----- Show the operation buttons ----- -->

<tr>
<td bgcolor="__UI_C_INTBLOCK__" width=__UI_LEFT_WIDTH__>

<input type=submit name="vieworder" value="View order"><br>

[if value showarchive]
<input type=submit name="unarchiveorder" value="Unarchive order">
[else]
<input type=submit name="archiveorder" value="Archive order">
[/else]
[/if]

<br>
<br>

<input type=submit name="deleteorder" value="Delete order" 
 onClick="return confirm('Are you sure you want to delete this order?')">

<br>

<input type=submit name="deletebogusorder" value="Delete canceled order" 
 onClick="return confirm('Are you sure you want to delete this canceled order?')">

<input type=submit name="xload" value="Export orders">

</td>
<td bgcolor="__UI_C_INTBLOCK__" width=__UI_RIGHT_WIDTH__>

<!-- ----- Show the order list box ----- -->
<pre>

[loop more=1 search="
		fi=transactions
		ml=100
		md=1
		st=db
		co=yes
		sf=archived
		se=1
		tf=order_number
		op=[scratch archive_sense]
		sf=deleted
		se=1
		op=ne
		rf=code,order_date,total_cost
"]
<select name=order size=10 MULTIPLE>
[list]<OPTION VALUE="[loop-code]">[loop-code]  [loop-param order_date]  [loop-param total_cost]</OPTION>
[/list]
</select>
</pre>
[more-list]<BR>Orders [matches] of [value mv_search_match_count]: [more][/more-list]
[/loop]
<B>Total: [currency]
	[query
		sql="select sum(total_cost) from transactions where archived [scratch archive_sense] 1"
		list=1
][sql-code][/query]
[/currency]</B>
</td></tr>

<tr>
<td colspan=2 bgcolor=__UI_C_TOPBLOCKBAR__><img src="admin/cleardot.gif" width=__UI_OVERALL_WIDTH__ height=1></td>
</tr>
</table>

<p>

</form>


<!-- ----- END REAL STUFF ----- -->

@@UI_STD_FOOTER@@
<!-- page: @@MV_PAGE@@ -->
