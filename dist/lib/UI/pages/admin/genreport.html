[if-mm !tables]
[set ui_error]Not authorized for table.[/set]
[bounce href="[area __UI_BASE__/error]"]
[/if-mm]
[if !advanced report]
[bounce page="__UI_BASE__/error"]
[value name=saved_report set=""]
[/if]
[seti page_title]Reports[/seti]
[set help_name]report[/set]
[set icon_name]admin/icon_config.gif[/set]
[seti name=tables][list-databases][/seti]

@@UI_STD_HEAD@@

[seti table_list]
	[loop prefix=table list="[scratch tables]"]
	<OPTION VALUE="[table-code]">[table-code]</OPTION>
	[/loop]
[/seti]

<table __UI_T_PROPERTIES__>
<tr>
<td colspan=3 bgcolor=__UI_C_TOPBLOCKBAR__><img src="admin/cleardot.gif" width=__UI_MAIN_WIDTH__ height=3></td>
</tr>

<TR>
<TD BGCOLOR="__UI_C_INTBLOCK__" VALIGN=TOP WIDTH=200>
	<IMG SRC="admin/icon_stats.gif"><B>
		Run saved report
	</B>
</TD>
<TD BGCOLOR="__UI_C_INTBLOCK__" VALIGN=TOP WIDTH=200>
	<IMG SRC="admin/icon_config.gif"><B>
		Retrieve saved definition
	</B>
</TD>
<TD BGCOLOR="__UI_C_INTBLOCK__" VALIGN=TOP WIDTH=200>
	<IMG SRC="admin/icon_help.gif"><B>
		Delete report
	</B>
</TD>
</TR>
<TD VALIGN=TOP WIDTH=200>
	[loop list="[list-glob spec='pages/__UI_BASE__/reports/* pages/__UI_BASE__/user/[data session mm_username]/reports/*']"]
	[calc]
		$lab = q{[loop-code]}; 
		$lab =~ s:\.html.*::;
		$opt = $lab;
		$opt =~ s:^pages/::;
		$lab =~ s:.*/::;
		$lab =~ s/%([0-9a-fA-F]{2})/chr(hex($1))/ge;
		my $out = $Tag->page($opt);
		$out .= $lab;
		$out .= '</A><BR>'
	[/calc]
	[/loop]
</TD>
<TD VALIGN=TOP WIDTH=200>
	[loop list="[list-glob spec='pages/__UI_BASE__/report_def/* pages/__UI_BASE__/user/[data session mm_username]/report_def/*']"]
	[calc]
		$lab = q{[loop-code]}; 
		$lab =~ s:\.html.*::;
		$opt = $lab;
		$opt =~ s:^pages/::;
		$lab =~ s:.*/::;
		$lab =~ s/%([0-9a-fA-F]{2})/chr(hex($1))/ge;
		my $out = $Tag->page($opt);
		$out .= $lab;
		$out .= '</A><BR>'
	[/calc]
	[/loop]
</TD>
<TD VALIGN=TOP WIDTH=200>
	[if-mm super]
		[seti report_spec][list-glob spec='pages/__UI_BASE__/report*/* pages/__UI_BASE__/user/[data session mm_username]/report*/*'][/seti]
	[else]
		[seti report_spec][list-glob spec='pages/__UI_BASE__/user/[data session mm_username]/report*/*'][/seti]
	[/else]
	[/if-mm]
	[set del_report]
	[calc]
		$out = '';
		my @files;
		if($CGI->{ui_report_delete}) {
			@possible = split /\s+/, $Scratch->{report_spec};
			@files = grep /$CGI->{ui_report_delete}$/, @possible;
		}
		for(@files) {
			my $lab = $_;
			$lab =~ s:.*/([^/]+/.+)\.html:$1:;
			$lab =~ s/%([0-9a-fA-F]{2})/chr(hex($1))/ge;
			$out .= "Delete $lab: ";
			$out .= 
				$Tag->unlink_file($_, 'pages/config') 
				? 'success'
				: 'FAILED';
			$out .= '<BR>';
		}
		$Scratch->{report_delete_message} = $out;
		return;
	[/calc]
	[/set]
	<SMALL>
	[scratch report_delete_message]
	[set report_delete_message][/set]
	<FORM METHOD=POST ACTION="[area ui]">
	<INPUT TYPE=hidden NAME=mv_click VALUE=del_report>
	<INPUT TYPE=hidden NAME=mv_todo VALUE=return>
	<INPUT TYPE=hidden NAME=mv_nextpage VALUE="@@MV_PAGE@@">
	<SELECT NAME="ui_report_delete">
	<OPTION VALUE=""> -- </OPTION>
	[calc]
		@opts = split /\s+/, $Scratch->{report_spec};
		my $out = '';
		for(@opts) {
			my $lab = $_;
			$lab =~ s:.*/::;
			my $val = $lab;
			$lab =~ s:\.html.*::;
			next if $seen{$lab}++;
			$lab =~ s/%([0-9a-fA-F]{2})/chr(hex($1))/ge;
			$out .= qq{<OPTION VALUE="$val">$lab</OPTION>};
		}
		return $out;
	[/calc]
	</SELECT>
	<BR><INPUT TYPE=SUBMIT VALUE=Delete>
	</FORM>
	</SMALL>
</TD>
</tr>

</TABLE>


<FORM METHOD=POST ACTION="[area __UI_BASE__/report]">
<P>
<table __UI_T_PROPERTIES__>
<tr>
<td colspan=2 bgcolor=__UI_C_TOPBLOCKBAR__><img src="admin/cleardot.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>

<tr>
<td WIDTH="40%" bgcolor=__UI_C_INTBLOCK__ ALIGN=center>
	<INPUT TYPE=submit VALUE="Report on table">
</TD>
<td bgcolor=__UI_C_INTBLOCK__>
<FORM NAME=report ACTION="[area __UI_BASE__/report]" METHOD=POST>
<INPUT TYPE=hidden NAME=mv_action VALUE="return">
<SELECT NAME=mv_data_table MULTIPLE>
[loop list="[scratch tables]" option=mv_data_table]
	<OPTION>[loop-code]
[/loop]
</SELECT>
</td>
</tr>

<tr>
<td colspan=2 bgcolor=__UI_C_TOPBLOCKBAR__><img src="admin/cleardot.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>
</FORM>

@@UI_STD_FOOTER@@
