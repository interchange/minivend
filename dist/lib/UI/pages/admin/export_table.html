[if cgi mv_data_table]
[if-mm function=!export table="[cgi mv_data_table]"]
[set ui_error]Not allowed to export table '[cgi mv_data_table]'.[/seti]
[bounce page="__UI_BASE__/error"]
[/if-mm]
[/if]
[set page_title]Individual Table Export[/set]
[set ui_class]Admin[/set]
[set table_perm]1[/set]
[set help_name]export.main[/set]
[set icon_name]admin/icon_config.gif[/set]
@_UI_STD_HEAD_@

[page __UI_BASE__/dbdownload]Multiple table export[/page]<BR>

[seti user_tables][loop list="[list-databases]"][if-mm function=export table="[loop-code]"][loop-code]
[/if-mm][/loop][/seti]
[seti tables][scratch user_tables]
__UI_ACCESS_TABLE__
__UI_META_TABLE__[/seti]
[perl table="[scratch tables]"]

	my @tables = grep /\S/, split /\s+/, $Scratch->{tables};
	my $out;
	for(@tables) {
		#Log("table $_");
		unless (ref $Db{$_}) {
			Log("bad table $_");
			next;
		}
		$tables{$_} = [ $Db{$_}->columns() ];
	}
	$out = "<SCRIPT LANGUAGE=JAVASCRIPT>\n<!-- \n";

	my $saved = $Values->{saved_report};
	my (@wanted) = qw/
						num_columns
						report_name
						report_table
						report_title
						search_field
						search_op
						search_spec
						summary_only
						matchlimit
						/;
	if(ref $saved) {
		for (@wanted) {
			delete $Values->{$_};
			$Values->{$_} = $saved->{$_}
				if defined $saved->{$_}; 
		}
		$Values->{mv_data_table} =
			$Values->{mvc_data_table} =
				$saved->{report_table}
			if $saved->{report_table};
				
		$max_columns = $saved->{num_columns} || 5;
	}
	else {
		$saved = {};
		$max_columns = 5;
	}

	foreach my $tab (sort keys %tables) {
		my $cols = $tables{$tab};
		my $row = (qq{ var ary_$tab = new Array ("('-- select column --', '', true,true)",});
		for(@$cols) {
			$row .= qq{"('$_')",\n};
		}
		$row =~ s/,$/);/;
		$out .= $row;
		if ($tab eq $Values->{mv_data_table}) {
			$Scratch->{selected_table_options} =
			   join '<OPTION>', '', @$cols;
			$Scratch->{selected_table_columns} =
			   join "\n", @$cols;
			$Scratch->{default_key} = $Db{$tab}->config('KEY');
		}
	}
	$Scratch->{column_nums} = join " ", 0 .. $max_columns;
	for(my $i = 0; $i <= $max_columns ; $i++) {

		for (
				qw/ table
					column
					key
					edit
					editkey
					align
					filter
					heading
					break
					summary
					sort_order
					sort_option
					break
				/
			)
		{ delete $Values->{"$_$i"}; }

		$Values->{"table$i"} = "<OPTION VALUE=''>--select table--</OPTION>";
		$Values->{"edit$i"} = "<OPTION VALUE=''>--select table--</OPTION>";
		$Values->{"column$i"} = "<OPTION VALUE=''>--select column--</OPTION>";
		$Values->{"key$i"} = "<OPTION VALUE=''>--key if applicable--</OPTION>";

		next if ! $saved;

		if ($i <= 2) {
			for(qw/sort_order sort_option break/) {
				$Values->{"$_$i"} = $saved->{"$_$i"};
			}
		}
		my $tab = $saved->{"table$i"}
			or next;
		my $col = $saved->{"column$i"};
		my $key = $saved->{"key$i"};
		my $edit = $saved->{"edit$i"};
		$Values->{"table$i"}  .= "<OPTION SELECTED VALUE='$tab'>$tab</OPTION>";
		$Values->{"column$i"} .= "<OPTION SELECTED VALUE='$col'>$col</OPTION>";
		$Values->{"key$i"} .= "<OPTION SELECTED VALUE='$key'>$key</OPTION>"
			if $key;
		$Values->{"edit$i"} .= "<OPTION SELECTED VALUE='$edit'>$edit</OPTION>"
			if $edit;
		for(qw/align filter heading break summary editkey/) {
			$Values->{"$_$i"} = $saved->{"$_$i"};
		}
	}
	$out .= <<EOF;

function populateTable(table_options,column_options,selected) {
	var selectedArray = eval ( "ary_" + selected );
	var currentTable = "$Values->{mv_data_table}";
	var currentArray = eval ( "ary_" + currentTable );
	while (selectedArray.length < column_options.length) {
		column_options[(column_options.length - 1)] = null;
	}
	for (var i=0; i < selectedArray.length; i++) {
		eval("column_options[i]=" + "new Option" + selectedArray[i]);
	}
	if (table_options[0].value == '') {
		table_options[0]= null;
    }
   return true;
}
// End -->
</SCRIPT>
EOF
[/perl]

<!-- ----- BEGIN REAL STUFF ----- -->
[if cgi ui_export_database]
[update values]
[seti result][export-database
        table="[value mv_data_table]"
        file="[value mv_data_file]"
        type="[value mv_data_export_type]"
        sort="[if value ui_sort_field][value ui_sort_field]:[value ui_sort_option][/if]"
   
        ][/seti]
	[if scratch result]
	Export of table <I><B>[cgi mv_data_table]</B></I> successful<P>
	<P>
		<UL>
		[quick-table]
		Table name: [value mv_data_table]
		File name: [default mv_data_file]
		File type: [default mv_data_export_type][if value ui_sort_field]
		Sorting: [value ui_sort_field]:[value ui_sort_option][/if]
		[/quick-table]
	[else]
	<FONT SIZE=5 COLOR=RED>
		Database export error: [data session last_error]
	</FONT>
	[/else]
	[/if]
[/if]
<BR CLEAR=ALL>

[if cgi mv_data_table]
[value name=mv_data_table set="[cgi mv_data_table]" hide=1]
[/if]

<form action="[area @@MV_PAGE@@]" method="POST" ENCTYPE="multipart/form-data">
<INPUT TYPE=hidden NAME=mv_action     VALUE=return>
<INPUT TYPE=hidden NAME=ui_return_to VALUE="__UI_BASE__/genconfig">


<table __UI_T_PROPERTIES__>
<tr>
<td colspan=2 bgcolor=__UI_C_TOPBLOCKBAR__><img src="@_UI_IMG_@admin/bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>

<tr>
<td bgcolor="__UI_C_INTBLOCK__">
Table to export
</td>
<td bgcolor="__UI_C_INTBLOCK__">
<select name="mv_data_table" onChange="populateTable(
			this.form.mv_data_table.options,
			this.form.ui_sort_field.options,
			this.form.mv_data_table.options[this.form.mv_data_table.selectedIndex].value
			)">
[loop list="[scratch user_tables]" option=mv_data_table]<option value="[loop-code]"> [loop-code]
[/loop]
</select>
</td>
</tr>



<tr>
<td bgcolor="__UI_C_INTBLOCK__">
Export as<BR>
</td>
<td bgcolor="__UI_C_INTBLOCK__">
        <SELECT NAME="mv_data_export_type">
            <OPTION VALUE=""> Current type
            <OPTION VALUE="DEFAULT"> System default
            <OPTION VALUE="TAB"> TAB delimited
            <OPTION VALUE="CSV"> CSV
            <OPTION VALUE="PIPE"> PIPE separated
            <OPTION VALUE="%%"> %%/%%%
            <OPTION VALUE="LINE"> Line mode
        </SELECT>
</td>
</tr>

<tr>
<td bgcolor="__UI_C_INTBLOCK__">
	Export to file<br>
	<small><I>(leave empty for default file)</I></small>
</td>
<td bgcolor="__UI_C_INTBLOCK__">
 <INPUT NAME=mv_data_file SIZE=40>
</td>
</tr>

<tr>
<td bgcolor="__UI_C_INTBLOCK__">
Sort by column
</td>
<td bgcolor="__UI_C_INTBLOCK__">
	<SELECT NAME=ui_sort_field>
		<OPTION VALUE=""> unsorted
		[loop list=|
						[db-columns name="[value mv_data_table]"]
					|]
		<OPTION>[loop-code]
		[/loop]
	</SELECT>
</td>
</tr>

<tr>
<td bgcolor="__UI_C_INTBLOCK__">
	Sort options<BR>
</td>
<td bgcolor="__UI_C_INTBLOCK__">
	<SELECT NAME=ui_sort_option>
		<OPTION VALUE=""> default (alpha)
		<OPTION VALUE="r"> reverse
		<OPTION VALUE="n"> numeric
		<OPTION VALUE="rn"> reverse numeric
		<OPTION VALUE="f"> case-insensitive
		<OPTION VALUE="rf"> case-insensitive, reverse
	</SELECT>
</td>
</tr>

<tr>
<td bgcolor="__UI_C_INTBLOCK__" colspan=2>

<center>
<INPUT TYPE=submit NAME=mv_click VALUE="Export">
</center>
[set Export]
ui_export_database=1
[/set]

</td>
</tr>

<tr>
<td colspan=2 bgcolor=__UI_C_TOPBLOCKBAR__><img src="@_UI_IMG_@admin/bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>

</table>

</form>

<!-- ----- END REAL STUFF ----- -->

@_UI_STD_FOOTER_@
