	[calc]
		return unless $CGI->{mv_more_ip};
		$CGI->{mv_data_table} = $Values->{mv_data_table};
		return;
	[/calc]
[seti page_title]
	[either]
		[cgi page_title]
	[or]
		Spreadsheet Edit: [cgi mv_data_table]
	[/either]
[/seti]
[seti help_name][either][cgi help_name][or]gensql.main[/either][/seti]
[seti icon_name][either][cgi icon_name][or]admin/icon_config.gif[/either][/seti]
[set meta_header]
<STYLE TYPE="text/css">
	td: { 
		backround-color: __UI_C_INTBLOCK__
	}
</STYLE>
[/set]
@_UI_STD_HEAD_@

[perl tables="[cgi mv_data_table]"]
	my $table = $CGI->{mv_data_table};
	my $db = $Db{$table};
	$Values->{mv_data_table} = $table;
	$Values->{ui_data_key_name} = $Db{$table}->config('KEY');
	$Values->{ui_data_fields} =
		$CGI->{ui_data_fields} ||
		$CGI->{mv_data_fields} ||
		$Values->{"spread:$table:ui_data_fields"} ||
		join(" ", $db->columns());
	my @fields;
	@fields = grep
				$_ ne $Values->{ui_data_key_name},
				split /[\0\s,]+/, $Values->{ui_data_fields};
	$Values->{ui_data_fields} = join " ", @fields;
	$Values->{"ui_spread_meta:$table"} = $CGI->{"ui_spread_meta:$table"}
		if defined $CGI->{"ui_spread_meta:$table"};
	$Values->{ui_meta_display} = $Values->{"ui_spread_meta:$table"};

	if($Values->{"ui_spreadsheet_rows:$table"}) {
		$Values->{"ui_spreadsheet_rows"} = $Values->{"ui_spreadsheet_rows:$table"};
	}
	else {
		$Values->{"ui_spreadsheet_rows"} = 10;
	}

	if($Values->{"ui_textarea_rows:$table"}) {
		$Values->{"ui_textarea_rows"} = $Values->{"ui_textarea_rows:$table"};
	}
	else {
		$Values->{"ui_textarea_rows"} = 4;
	}

	if($CGI->{"ui_spread_size:$table"}) {
		$Values->{"ui_spread_size"}
			= $Values->{"ui_spread_size:$table"}
			= $CGI->{"ui_spread_size:$table"};
	}
	elsif($Values->{"ui_spread_size:$table"}) {
		$Values->{"ui_spread_size"} = $Values->{"ui_spread_size:$table"};
	}
	else {
		$Values->{"ui_spread_size"} = 12;
	}

	return;
[/perl]
[if scratch ui_failure]
<BLOCKQUOTE>
<FONT COLOR=__CONTRAST__>Error: [scratch ui_failure]</FONT>
[set ui_failure][/set]
</BLOCKQUOTE>
[/if]
<FORM METHOD=POST ACTION="[base-url]/ui">
<INPUT TYPE=hidden NAME="mv_todo" VALUE="set">
<INPUT TYPE=hidden NAME="mv_nextpage" VALUE="@@MV_PAGE@@">
<INPUT TYPE=hidden NAME="mv_data_table" VALUE="[value mv_data_table]">
<INPUT TYPE=hidden NAME="mv_data_key" VALUE="[value ui_data_key_name]">
<INPUT TYPE=hidden NAME="mv_data_decode" VALUE="yes">
<INPUT TYPE=hidden NAME="mv_update_empty" VALUE="1">
<INPUT TYPE=hidden NAME="ui_text_qualification" value="[cgi ui_text_qualification]">
<INPUT TYPE=hidden NAME="mv_data_fields"
	VALUE="[db-columns columns='[value ui_data_fields]']">

<INPUT TYPE=hidden NAME="mv_data_function" VALUE="update">

[calc]
	@areas = grep /\S/, split /[\s,\0]+/, $Values->{ui_data_fields};
	$Scratch->{ui_num_col} = scalar(@areas) + 2;
	$Config->{NoSearch} = '';
	if ($CGI->{ui_text_qualification} and $CGI->{ui_text_qualification} =~ /=/ ) {
		my ($f, $s) = split /\s*=\s*/, $CGI->{ui_text_qualification} , 2;
		$CGI->{ui_text_qualification} = "co=1\nop=eq\nse=$s\nsf=$f";
	}
	elsif ($CGI->{ui_text_qualification}) {
		$CGI->{ui_text_qualification} = "se=$CGI->{ui_text_qualification}";
	}
	else {
		$CGI->{ui_text_qualification} = "ra=yes";
	}
	$CGI->{ui_description_field} =
		q{[data table=__UI_META_TABLE__
				col=field
				key="[cgi mv_data_table]"
			]};

	return;
[/calc]

[if !value ui_spreadsheet_rows]
[value name=ui_spreadsheet_rows set=10 hide=1]
[/if]
[search-region more=1 arg="
				[cgi ui_text_qualification]
				ml=[value ui_spreadsheet_rows]
				rf=[value ui_data_key_name]
				tf=[value ui_data_key_name]
				st=db
				sp=@@MV_PAGE@@
				fi=[value mv_data_table]
			"]
[rotate-table reparse=0 rotate="[value ui_rotate_spread]" interpolate=1]

<table __UI_T_PROPERTIES__>

<tr>
<td colspan="[scratch ui_num_col]" bgcolor=__UI_C_TOPBLOCKBAR__><img src="admin/cleardot.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>

[with param=table value="[value mv_data_table]"]
<TR BGCOLOR="__UI_C_INTBLOCK__" CELLPADDING=2>
	<TH ALIGN=CENTER>&nbsp;</TH>
	<TH ALIGN=CENTER>[value ui_data_key_name]</TH>
	[row-edit
		columns="[value ui_data_fields]"
		height=`$Values->{"ui_textarea_rows:$Values->{mv_data_table}"}`
		textarea="[value name='ui_textarea_fields:[value mv_data_table]']"
		]
</TR>

<tr>
<td colspan="[scratch ui_num_col]" bgcolor=__UI_C_INTBLOCKBAR__><img src="admin/cleardot.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>

	[search-list]
	[if-mm keys [item-code]]
<TR BGCOLOR="__UI_C_INTBLOCK__">
	<td><input type=checkbox name="batch_id" value="[item-code]"><input type=hidden name="[value ui_data_key_name]" value="[item-code]"></td>
	<TD>
	[page href="__UI_BASE__/flex_editor"
	form=|
		page_title=Edit [value mv_data_table]: [item-code]
		mv_data_table=[value mv_data_table]
		item_id=[item-code]
	|]<small><small><u>edit</u></small></small>&nbsp;<b>[item-code]</b></A>
	</TD>
	[row-edit
		key="[item-code]"
		size="[value ui_spread_size]"
		columns="[value ui_data_fields]"
		height=`
					my $tab = $Values->{mv_data_table};
					return $Values->{"ui_textarea_rows:$tab"};
				`
		textarea=`
					my $tab = $Values->{mv_data_table};
					return $Values->{"ui_textarea_fields:$tab"};
			`
		]
</TR>
	[/if-mm]
	[set row_number][item-increment][/set]
	[/search-list]

<TR BGCOLOR="__UI_C_INTBLOCK__">
	<td COLSPAN=2>
	<input type=text size=12 name="[value ui_data_key_name]">
	</TD>
	[row-edit blank=1 size="[value ui_spread_size]" columns="[value ui_data_fields]"]
</TR>

[more-list]
<tr>
<td colspan="[scratch ui_num_col]" bgcolor=__UI_C_INTBLOCKBAR__><img src="admin/cleardot.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>
<tr>
<td bgcolor=__UI_C_INTBLOCK__>&nbsp;</td>
<td colspan="[calc]$Scratch->{ui_num_col} - 1[/calc]" bgcolor=__UI_C_INTBLOCK__>
	<FONT SIZE="+1">More pages: [more] </FONT>
</td>
</tr>
[/more-list]

<tr>
<td colspan="[scratch ui_num_col]" bgcolor=__UI_C_INTBLOCKBAR__><img src="admin/cleardot.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>

<tr>
<td colspan="[scratch ui_num_col]" bgcolor=__UI_C_TOPBLOCKBAR__><img src="admin/cleardot.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>

<tr>
<td bgcolor=__UI_C_INTBLOCK__>&nbsp;</td>
<td colspan="[calc]$Scratch->{ui_num_col} - 1[/calc]" bgcolor=__UI_C_INTBLOCK__>

[set Change display]
mv_todo=return
mv_nextpage=__UI_BASE__/spread_control
[/set]

[set Cancel]
mv_todo=back
mv_nextpage=__UI_BASE__/flex_select
[/set]

	[set OK]
	[/set]
	<B><INPUT TYPE=submit NAME=mv_click VALUE=Ok></B>&nbsp;&nbsp;&nbsp;
	<INPUT TYPE=submit NAME=mv_click VALUE="Change display">&nbsp;&nbsp;&nbsp;
	<INPUT TYPE=submit NAME=mv_click VALUE="Delete checked rows"
		 onClick="return confirm('Are you sure you want to delete the checked rows?')">&nbsp;&nbsp;&nbsp;
	<INPUT TYPE=submit NAME=mv_click VALUE=Cancel>
[if !value ui_too_large]
<BR><b><INPUT TYPE=checkbox
		NAME=ui_auto_export CHECKED VALUE="[value mv_data_table]">
	Auto-export</b>
[/if]

</td>
</tr>

</TABLE>
[/rotate-table]
</center>
[/search-region]
</FORM>

[set Delete checked rows]
[flag type=write table="[cgi mv_data_table]"]
mv_nextpage=__UI_BASE__/flex_select
ui_auto_export=
mv_todo=return
[if-mm tables =d]
	[perl tables="[cgi mv_data_table]"]
		my $tab = $CGI->{mv_data_table};
		my $db  = $Db{$tab};
		unless ($db) {
			$Scratch->{ui_message} = "No table '$tab'";
			return;
		}
		my @items = split /\0/, $CGI->{batch_id};
		foreach my $item (@items) {
			if ($db->delete_record($item)) {
				$out .= "Deleted $item from table $tab<BR>";
			}
			else {
				$out .= "Item $item not in $tab table (or delete failed)<BR>";
			}
		}
		$Scratch->{ui_message} = $out;
		return;
	[/perl]
[else]
	[set ui_message]Not authorized to delete items.[/set]
[/else]
[/if-mm]
[/set]


<!-- ----- END REAL STUFF ----- -->

@_UI_STD_FOOTER_@
