	[calc]
		return unless $CGI->{mv_more_ip};
		$CGI->{mv_data_table} = $Values->{mv_data_table};
		return;
	[/calc]
[seti page_title]
	[either]
		[cgi page_title]
	[or]
		[L]Spreadsheet Edit:[/L] [cgi mv_data_table]
	[/either]
[/seti]
[seti page_banner]
	[either]
		[cgi page_banner]
	[or]
		Spreadsheet Edit: [page href=__UI_BASE__/db_metaconfig
								form="
									ui_table=[cgi mv_data_table]
									ui_view=[cgi ui_meta_view]
									start_at=extended.spread_height
								"][cgi mv_data_table]</A>
	[/either]
[/seti]
[set ui_class]Admin[/set]
[seti help_name][either][cgi help_name][or]gensql.main[/either][/seti]
[seti icon_name][either][cgi icon_name][or]icon_config.gif[/either][/seti]

@_UI_STD_HEAD_@

<FORM ACTION="[area href="[either][cgi ui_searchpage][or]@@MV_PAGE@@[/either]"]" METHOD=GET>
<INPUT TYPE=hidden NAME=mv_session_id VALUE="[data session id]">
<INPUT TYPE=hidden NAME=mv_data_table    VALUE="[cgi mv_data_table]">
<INPUT TYPE=hidden NAME=mv_action        VALUE=back>
<INPUT TYPE=hidden NAME=ui_show_fields VALUE="[cgi ui_show_fields]">

[if !scratch tmp_large]
<table>
<tr>
<td>
		[loop list="[cgi mv_data_table]"]
		 	[if-loop-data __UI_META_TABLE__ name]
		 	<B>[loop-data __UI_META_TABLE__ name]</B>
			[/if-loop-data]
		 	[if-loop-data __UI_META_TABLE__ help_url]
		 	&nbsp;&nbsp;&nbsp;<small><A HREF="[loop-data __UI_META_TABLE__ help_url]">help</A></small>
			[/if-loop-data]
		 	[if-loop-data __UI_META_TABLE__ help]
		 	<BR><i>[loop-data __UI_META_TABLE__ name]</i>
			[/if-loop-data]
		[/loop]
</td>
<td>
<input NAME=ui_text_qualification size=16><INPUT TYPE=submit VALUE="[L]Limit with search[/L]">
</td>
</tr>
</table>
[/if]
</FORM>



[perl tables="[cgi mv_data_table] __UI_META_TABLE__"]
	my $table = $CGI->{mv_data_table};
	my $db = $Db{$table};
	my $mrec = $Tag->meta_record($table, $CGI->{ui_meta_view}) || {};
	$mrec ||= {};
	$mrec->{spread_fields} ||= join(" ", $db->columns());
	$mrec->{spread_height} ||= 10;
	my $key = $CGI->{ui_data_key_name} = $db->config('KEY');
	$mrec->{spread_sort} ||= $key;
	$CGI->{ui_description_field} = $mrec->{label};

	my $qual;
	if ($CGI->{ui_text_qualification} and $CGI->{ui_text_qualification} =~ /=/ ) {
		my ($f, $s) = split /\s*=\s*/, $CGI->{ui_text_qualification} , 2;
		$qual = "co=1\nop=eq\nse=$s\nsf=$f";
	}
	elsif ($CGI->{ui_text_qualification}) {
		$qual = "se=$CGI->{ui_text_qualification}";
	}
	else {
		$qual = "ra=yes";
	}

	my @fields = split /[\0\s,]+/, $mrec->{spread_fields};
	@fields = grep length($_) && $_ ne $key, @fields;

	$CGI->{mv_data_fields} = join " ", @fields;

	$CGI->{mrec_textarea_rows} ||= 4;

	$CGI->{mrec_spread_width} ||= $mrec->{spread_width} || 12; 

	my $sp = q{@@MV_PAGE@@};

	$Scratch->{mrec_options} = qq{
				$qual
				fi=$table
				st=db
				sp=$sp
				ml=$mrec->{spread_height}
				rf=$CGI->{ui_data_key_name}
				tf=$mrec->{spread_sort}
			};
	$Scratch->{ui_num_col} = scalar(@fields) + 2;
	$Scratch->{ui_most_col} = $Scratch->{ui_num_col} - 1; 
	$Config->{NoSearch} = '';
	return;
[/perl]

<FORM METHOD=POST ACTION="[base-url]/ui">
<INPUT TYPE=hidden NAME="mv_todo" VALUE="set">
<INPUT TYPE=hidden NAME="mv_nextpage" VALUE="@@MV_PAGE@@">
<INPUT TYPE=hidden NAME="mv_data_table" VALUE="[cgi mv_data_table]">
<INPUT TYPE=hidden NAME="mv_data_key" VALUE="[cgi ui_data_key_name]">
<INPUT TYPE=hidden NAME="mv_data_decode" VALUE="yes">
<INPUT TYPE=hidden NAME="mv_data_multiple" VALUE="1">
<INPUT TYPE=hidden NAME="mv_click" VALUE="process_filter">
<INPUT TYPE=hidden NAME="mv_update_empty" VALUE="1">
<INPUT TYPE=hidden NAME="mv_update_empty_key" VALUE="0">
<INPUT TYPE=hidden NAME="ui_text_qualification" value="[cgi ui_text_qualification]">
<INPUT TYPE=hidden NAME="ui_return_to" value="[cgi ui_return_to]">
<INPUT TYPE=hidden NAME="mv_data_fields" VALUE="[cgi mv_data_fields]">
<INPUT TYPE=hidden NAME="mv_data_function" VALUE="update">

[calc]
[/calc]

[search-region more=1 arg="[scratch mrec_options]"]
<table cellpadding=2 cellspacing=0 width="90%">

<tr>
<td colspan="[scratch ui_num_col]" class=rborder><img src="bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>
<tr>
	<td class=rnorm>&nbsp;</td>
	<td colspan="[scratch ui_most_col]" class=rnorm>
	&nbsp;&nbsp;&nbsp;[button text="[L]Ok[/L]" extra=|style="font-weight: bold"|]
		mv_todo=set
		[return-to click]
	[/button]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<INPUT TYPE=submit NAME=mv_click VALUE="[L]Cancel[/L]">
	</td>
</tr>
[more-list]
[prev-anchor]&nbsp;&nbsp;<span style="font-size: larger; font-weight: bolder">&lt;</span>&nbsp;&nbsp;[/prev-anchor]
[next-anchor]&nbsp;&nbsp;<span style="font-size: larger; font-weight: bolder">&gt;</span>&nbsp;&nbsp;[/next-anchor]
[first-anchor]&nbsp;<span style="font-size: larger; font-weight: bolder">&lt;&lt;</span>[/first-anchor]
[last-anchor]&nbsp;<span style="font-size: larger; font-weight: bolder">&gt;&gt;</span>[/last-anchor]
[page-anchor]&nbsp;<span style="font-size: larger; font-weight: bolder">$PAGE$</span>[/page-anchor]
<tr>
<td colspan="[scratch ui_num_col]" class=rspacer><img src="bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>
<tr>
<td class=rnorm>&nbsp;</td>
<td colspan="[scratch ui_most_col]" class=rnorm>
	[msg arg.0=`q{[more]}`]More pages: %s[/msg]
</td>
</tr>
[/more-list]

<tr>
<td colspan="[scratch ui_num_col]" class=rborder><img src="bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>

<TR class=rnorm CELLPADDING=2>
	<TH ALIGN=CENTER>&nbsp;</TH>
	<TH ALIGN=CENTER>[cgi ui_data_key_name]</TH>
	[row-edit columns="[cgi mv_data_fields]" ]
</TR>

	[search-list]
	[item-sub addnum]
		my $inc = shift;
		my $out = '';
		if($ss_row_num) {
			$out = $ss_row_num . '_';
		}
		$ss_row_num++ if $inc;
		return $out;
	[/item-sub]
	[if-mm keys [item-code]]
<TR class=rnorm>
	<td valign=top><input type=checkbox name="batch_id" value="[item-code]"><input type=hidden name="[item-exec addnum][/item-exec][cgi ui_data_key_name]" value="[item-code]"></td>
	<TD valign=top>
	[page href="__UI_BASE__/flex_editor"
	form=|
		page_title=Edit [cgi mv_data_table]: [item-code]
		mv_data_table=[cgi mv_data_table]
		item_id=[item-code]
	|]<small><small><u>edit</u></small></small>&nbsp;<b>[item-code]</b></A>
	</TD>
	[row-edit
		key="[item-code]"
		extra="valign=top"
		pointer="[item-exec addnum]1[/item-exec]"
		columns="[cgi mv_data_fields]"
		]
</TR>
<tr>
<td colspan="[scratch ui_num_col]" class=rspacer><img src="bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>
	[/if-mm]
	[set row_number][item-increment][/set]
	[/search-list]

<tr>
<td colspan="[scratch ui_num_col]" class=rmarq>New record</td>
</tr>

<TR class=rnorm CELLPADDING=2>
	<TH ALIGN=CENTER>&nbsp;</TH>
	<TH ALIGN=CENTER>[cgi ui_data_key_name]</TH>
	[row-edit columns="[cgi mv_data_fields]" ]
</TR>


<TR class=rnorm>
	<td COLSPAN=2 valign=top>
	<input type=text size=12 name="999999_[cgi ui_data_key_name]">
	</TD>
	[row-edit
		blank=1
		pointer=999999
		extra="valign=top"
		columns="[cgi mv_data_fields]"
		extra="valign=top"
		]
</TR>

[more-list]
[prev-anchor]&nbsp;&nbsp;<span style="font-size: larger; font-weight: bolder">&lt;</span>&nbsp;&nbsp;[/prev-anchor]
[next-anchor]&nbsp;&nbsp;<span style="font-size: larger; font-weight: bolder">&gt;</span>&nbsp;&nbsp;[/next-anchor]
[first-anchor]&nbsp;<span style="font-size: larger; font-weight: bolder">&lt;&lt;</span>[/first-anchor]
[last-anchor]&nbsp;<span style="font-size: larger; font-weight: bolder">&gt;&gt;</span>[/last-anchor]
[page-anchor]&nbsp;<span style="font-size: larger; font-weight: bolder">$PAGE$</span>[/page-anchor]
<tr>
<td colspan="[scratch ui_num_col]" class=rspacer><img src="bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>
<tr>
<td class=rnorm>&nbsp;</td>
<td colspan="[scratch ui_most_col]" class=rnorm>
	[msg arg.0=`q{[more]}`]More pages: %s[/msg]
</td>
</tr>
[/more-list]

<tr>
<td colspan="[scratch ui_num_col]" class=rspacer><img src="bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>

<tr>
<td colspan="[scratch ui_num_col]" class=rborder><img src="bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>

<tr>
<td class=rnorm>&nbsp;</td>
<td colspan="[scratch ui_most_col]" class=rnorm>


	&nbsp;&nbsp;&nbsp;[button text="[L]Ok[/L]" extra=|style="font-weight: bold"|]
		mv_todo=set
		[return-to click]
	[/button]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	[button text="[L]Delete checked rows[/L]"
		confirm="[L]Are you sure you want to delete the checked rows?[/L]"]
[flag type=write table="[cgi mv_data_table]"]
mv_nextpage=__UI_BASE__/flex_select
mv_auto_export=
mv_todo=return
[if-mm tables =d]
	[perl tables="[cgi mv_data_table]"]
		my $tab = $CGI->{mv_data_table};
		my $db  = $Db{$tab};
		unless ($db) {
			$Scratch->{ui_message} = "No table '$tab'";
			return;
		}
		my @items = split /\0/, $CGI->{batch_id};
		foreach my $item (@items) {
			if ($db->delete_record($item)) {
				$out .= "Deleted $item from table $tab<BR>";
			}
			else {
				$out .= "Item $item not in $tab table (or delete failed)<BR>";
			}
		}
		$Scratch->{ui_message} = $out;
		return;
	[/perl]
[else]
	[set ui_message][L]Not authorized to delete items.[/L][/set]
[/else]
[/if-mm]
	[return-to click]
[/button]&nbsp;&nbsp;&nbsp;
	<INPUT TYPE=submit NAME=mv_click VALUE="[L]Cancel[/L]">
	[if-mm super]
	<BR><b><INPUT TYPE=checkbox NAME=mv_auto_export [if !scratch ui_too_large]CHECKED [/if]VALUE="[cgi mv_data_table]">
		[L]Auto-export[/L]</b>
	[/if-mm]

</td>
</tr>

</TABLE>
</center>
[/search-region]
</FORM>


<!-- ----- END REAL STUFF ----- -->

@_UI_STD_FOOTER_@
