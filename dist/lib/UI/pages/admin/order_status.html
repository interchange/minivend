[calc]
	$Values->{ui_data_fields} = $CGI->{ui_data_fields} = 'status archive delete';
	$CGI->{mv_data_table} = 'transactions';
	$CGI->{item_id} ||= $CGI->{order};

	$Tag->tmp('hidden');
	my $hidden;
	if($CGI->{ui_sequence_edit}) {
		$Scratch->{mv_nextpage} = "__UI_BASE__/order";
		$hidden = {
			item_id_left	=> $CGI->{item_id_left},
			ui_sequence_edit	=> $CGI->{ui_sequence_edit},
		}
	}
	else {
		$CGI->{ui_sequence_destination} ||= '__UI_BASE__/order';
		$Scratch->{mv_nextpage} = $CGI->{ui_sequence_destination};
		$hidden = { };
	}
	$hidden->{ui_sequence_destination} = q{@@MV_PAGE@@};
	$Scratch->{hidden} = $hidden;
	$CGI->{order} = $CGI->{item_id};
	return;
[/calc]

[if cgi ship_auto]
[calc]
	my $orders = join ",", delete $CGI->{item_id}, delete $CGI->{item_id_left};
	$orders =~ s/-_NULL_-/\0/g;
	$orders =~ s/\0+/,/g;
	$orders =~ s/,+/,/g;
	delete $CGI->{order};
	$Scratch->{order_list} = $orders;
[/calc]
[loop list="[scratch order_list]"]
	[update-order-status
			order_number="[loop-code]"
			ship_all=1
			[if-loop-data transactions order_id]
			settle_transaction="__SETTLE_TRANSACTION__"
			[/if-loop-data]
			archive=1]
[/loop]
			


[/if]
[if !cgi order]
	[bounce page="__UI_BASE__/order"]
[/if]

[set ui_class]Orders[/set]
[seti page_title][L]Order status[/L] -- [cgi order][/seti]
[tmp page_banner][L]Order status[/L]: [L]order[/L] <B>[page href="__UI_BASE__/order_view" form="order=[cgi order]"][cgi order]</A></B>[/tmp]
[set help_name]item.edit[/set]
[set icon_name]icon_item.gif[/set]

@_UI_STD_HEAD_@

[tmp form_include]
<tr class=rnorm>
<td class=clabel align=center style="font-size: larger">
	Actions
</td>
<td class=cdata>
	<div 
		style="
			border: 2px solid black;
			padding: 8px;
		">
	<select name=ship_all>
		<option value=1> Ship all lines
		<option value=0> Ship per status above
	</select>

	[button form=tform bold=1 text="[L]Ship the order[/L]"]
	mv_todo=back
	order=[cgi code]
	[tag flag write]orderline transactions[/tag]
	[update-order-status order-number="[cgi code]"]
	[if scratch ship_notice_username]
	[email-raw][include etc/ship_notice][/email-raw]
	[/if]

	[/button]

	Email
	<select name=send_email>
		<option value="">[L]Use customer preference[/L]</option>
		<option value="0">[L]No[/L]</option>
		<option value="1">[L]Yes[/L]</option>
	</select>

	[if variable SETTLE_TRANSACTION]
	<br>
		[if type=data term="transactions::order_id::[cgi order]"]
	<input type=checkbox name=settle_transaction value=1 CHECKED> <b>Settle transaction </b>
		[/if]
	[/if]
	</div>
</td>
</tr>
[/tmp]

[table-editor 
	table=transactions
	key="[cgi order]"
	form-name=tform
	table-width="100%"
	no-table-meta=1
	mv-nextpage="[scratch mv_nextpage]"
	ui_data_fields="code status tracking_number order_id auth_code archived deleted"
	include-form="[scratch form_include]"
	include-before="order_id"
	help.order_id="* = settled"
	link-table=orderline
	link-key=order_number
	link-before=order_id
	link-no-blank=1
	link-label="Ordered Items"
	hidden=`$Scratch->{hidden}`
/]

<script>
	var f = document.tform;
	if(f != undefined) {
		var str = f.order_id.value;
// alert("in check, str=" + str);
		if(str.match(/\*$/) ) {
			f.settle_transaction.checked = false;
// alert("set checked status!");
		}
	}
</script>

@_UI_STD_FOOTER_@
<!-- page: @@MV_PAGE@@ version: $Id$ -->
